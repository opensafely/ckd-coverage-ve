---
title: "Univariate cox PH model check - dialysis + IMD"
output: html_document
---

### Dialysis 

#### Summary of univariate model without stratification
```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

## Import libraries
library('here')
library('readr')
library('tidyr')
library('tidyverse')
library('lubridate')
library('survival')
library('gtsummary')
library('gt')
library('survminer')
library('glue')
library('fs')
library('cowplot')


## Import custom user functions
source(here::here("analysis", "functions.R"))

## Import data
data_cox <- read_rds(here::here("output", "data", "data_cox.rds"))
```

```{r}
# fit univariate model
uni_model = coxph(Surv(follow_up_time, covid_vax) ~ dialysis, data = data_cox)
summary(uni_model)
```

#### Survival curve (rounded/redacted)
```{r}
#### Survival curve - unredacted
# fit <- survfit(Surv(follow_up_time, covid_vax) ~ imd, data = data_cox)
# ggsurvplot(fit, data = data_cox, 
#   censor.shape="|", censor.size = 4, 
#   conf.int = TRUE,          
#   pval = TRUE,              
#   risk.table = TRUE,        
#   risk.table.col = "strata",
#   risk.table.height = 0.4, 
#   ggtheme = theme_bw()      
# )

threshold=7
surv_data_rounded <- survfit(Surv(follow_up_time, covid_vax) ~ dialysis, 
                            data = data_cox) %>% 
  broom::tidy() %>% 
  filter(estimate > 0) %>%
  mutate(
    estimate = pmin(1,plyr::round_any(estimate, threshold/max(n.risk)), na.rm=TRUE),
    conf.low = pmin(1, plyr::round_any(conf.low, threshold/max(n.risk)), na.rm=TRUE),
    conf.high = pmin(1, plyr::round_any(conf.high, threshold/max(n.risk)), na.rm=TRUE),
    cum.in = 1 - estimate,
    lci = 1- conf.high,
    uci = 1 - conf.low
  )

surv_data_risk_table <- ggsurvplot(
  survfit(Surv(follow_up_time, covid_vax) ~ dialysis, data = data_cox), risk.table = TRUE)$data.survtable %>%
  select(dialysis, time, n.risk) %>%
  mutate(`n.risk` = ifelse(`n.risk` < 8, "<8", `n.risk`))

g1 = surv_data_rounded %>%
  ggplot(aes(x = time, y = 1-cum.in, colour = strata)) + geom_step(size = 0.5) +
  scale_x_continuous(breaks = seq(0, max(surv_data_rounded$time),50)) +
  scale_y_continuous(expand = expansion(mult=c(0,0.01)), limits=c(0,1)) + 
  labs(
    x = "Days since index date",
    y = "1 - cumulative incidence",
    colour = "dialysis status",
    title = "") +
    theme_minimal(base_size = 12)

g2 = ggplot(surv_data_risk_table, aes(time, dialysis)) + 
  geom_text(aes(label = n.risk), size = 4) +
  theme_minimal(base_size = 12) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(fill= "white", size = 1),
        axis.text.x = element_text(color = "white"),
        axis.title = element_text(color = "black"),
        strip.text = element_text(color = "black")) +
  scale_y_discrete(limits = c("0", "1")) +
  xlab("") + 
  ylab("dialysis") +
  ggtitle("Number at Risk")

plot_grid(g1, g2, ncol=1,align="v", axis = c("lr"), rel_heights=c(3,1.5))
```

#### Test proportional hazards
```{r}
test.ph <- cox.zph(uni_model)
test.ph
```

#### Test Schoenfeld residuals
```{r}
plot(test.ph, col=c("red","blue"), resid=FALSE)
```
Points excluded to avoid disclosing individual data.

### IMD

#### Summary of univariate model without stratification
```{r}
# fit univariate model
uni_model = coxph(Surv(follow_up_time, covid_vax) ~ imd, data = data_cox)
summary(uni_model)
```

```{r}
surv_data_rounded <- survfit(Surv(follow_up_time, covid_vax) ~ imd, 
                            data = data_cox) %>% 
  broom::tidy() %>% 
  filter(estimate > 0) %>%
  mutate(
    estimate = pmin(1,plyr::round_any(estimate, threshold/max(n.risk)), na.rm=TRUE),
    conf.low = pmin(1, plyr::round_any(conf.low, threshold/max(n.risk)), na.rm=TRUE),
    conf.high = pmin(1, plyr::round_any(conf.high, threshold/max(n.risk)), na.rm=TRUE),
    cum.in = 1 - estimate,
    lci = 1- conf.high,
    uci = 1 - conf.low
  )

surv_data_risk_table <- ggsurvplot(
  survfit(Surv(follow_up_time, covid_vax) ~ imd, data = data_cox), risk.table = TRUE)$data.survtable %>%
  select(imd, time, n.risk) %>%
  mutate(`n.risk` = ifelse(`n.risk` < 8, "<8", `n.risk`))

g1 = surv_data_rounded %>%
  ggplot(aes(x = time, y = 1-cum.in, colour = strata)) + geom_step(size = 0.5) +
  scale_x_continuous(breaks = seq(0, max(surv_data_rounded$time),50)) +
  scale_y_continuous(expand = expansion(mult=c(0,0.01)), limits=c(0,1)) + 
  labs(
    x = "Days since index date",
    y = "1 - cumulative incidence",
    colour = "IMD",
    title = "") +
    theme_minimal(base_size = 12)

g2 = ggplot(surv_data_risk_table, aes(time, imd)) + 
  geom_text(aes(label = n.risk), size = 4) +
  theme_minimal(base_size = 12) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(fill= "white", size = 1),
        axis.text.x = element_text(color = "white"),
        axis.title = element_text(color = "black"),
        strip.text = element_text(color = "black")) +
  xlab("") + 
  ylab("IMD") +
  ggtitle("Number at Risk")

plot_grid(g1, g2, ncol=1,align="v", axis = c("lr"), rel_heights=c(3,1.5))
```

#### Test proportional hazards
```{r}
test.ph <- cox.zph(uni_model)
test.ph
```

#### Test Schoenfeld residuals
```{r}
plot(test.ph, col=c("red","blue"), resid=FALSE)
```
Points excluded to avoid disclosing individual data.

### Fully adjusted

#### Summary of fully adjusted model without stratification
```{r}
var_list <- c("ageband2", "sex", "ethnicity", "imd", "chronic_kidney_disease_diagnostic",
              "dialysis", "kidney_transplant", "chronic_kidney_disease_stages_3_5", "prior_covid_cat",
              "care_home", "shielded", "immunosuppression", "chronic_resp_dis", "diabetes", "cld",
              "chd", "asplenia", "cancer", "obesity", "chronic_neuro_dis_inc_sig_learn_dis", "sev_mental_ill") 
# fit multivariate model
adj_model <- coxph(as.formula(paste0("Surv(follow_up_time, covid_vax) ~", paste(var_list, collapse="+"),"+ strata(region)")),
                             data = data_cox)
summary(adj_model)
```

#### Test proportional hazards
```{r}
test.ph <- cox.zph(adj_model)
test.ph
```

#### Test Schoenfeld residuals
```{r}
plot(test.ph, col=c("red","blue"), resid=FALSE)
```
Points excluded to avoid disclosing individual data.


