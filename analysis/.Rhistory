# Immunosuppression
immunosuppression_diagnosis_date = !is.na(immunosuppression_diagnosis_date),
immunosuppression_medication_date = !is.na(immunosuppression_medication_date),
immunosuppression = immunosuppression_diagnosis_date | immunosuppression_medication_date,
# Mental illness
sev_mental_ill = !is.na(sev_mental_ill),
# Prior covid
prior_covid_date = pmin(prior_positive_test_date,
prior_primary_care_covid_case_date,
prior_covidadmitted_date,
na.rm=TRUE),
prior_covid_cat = ifelse(prior_covid_date < covid_vax_date_3 & prior_covid_date >= covid_vax_date_2, 1, NA),
prior_covid_cat = ifelse(prior_covid_date < covid_vax_date_2 & prior_covid_date >= covid_vax_date_1, 2, NA),
prior_covid_cat = ifelse(prior_covid_date < covid_vax_date_1, 3, prior_covid_cat),
prior_covid_cat = fct_case_when(
prior_covid_cat == 1 ~ "Between second and third dose",
prior_covid_cat == 2 ~ "Between first and second dose",
prior_covid_cat == 3 ~ "Prior to first dose",
TRUE ~ NA_character_
)
) %>%
droplevels() %>%
mutate(
# converts TRUE/FALSE to 1/0
across(
where(is.logical),
~.x*1L
)
)
# add binary flag to signal whether dummy data processing steps have been applied
data_processed$mock_data_flag=0
# apply dummy data script if running locally
if(grepl(userid, getwd())) {
source("dummy_data.R")
# update mock data flag
data_processed$mock_data_flag=1
}
View(data_processed)
data_processed$mock_data_flag
# linearise the vaccination dates of each individual, then determine the product and index for each dose
data_vax <- local({
data_vax_pfizer <- data_processed %>%
select(patient_id, matches("pfizer\\_date\\_\\d+")) %>%
pivot_longer(
cols = -patient_id,
values_to = "date",
values_drop_na = TRUE
) %>%
arrange(patient_id, date) %>%
mutate(type = "pfizer") %>%
select(-name)
data_vax_az <- data_processed %>%
select(patient_id, matches("az\\_date\\_\\d+")) %>%
pivot_longer(
cols = -patient_id,
values_to = "date",
values_drop_na = TRUE
) %>%
arrange(patient_id, date) %>%
mutate(type = "az") %>%
select(-name)
data_vax_moderna <- data_processed %>%
select(patient_id, matches("moderna\\_date\\_\\d+")) %>%
pivot_longer(
cols = -patient_id,
values_to = "date",
values_drop_na = TRUE
) %>%
arrange(patient_id, date) %>%
mutate(type = "moderna") %>%
select(-name)
data_vax <- rbind(data_vax_pfizer, data_vax_az, data_vax_moderna) %>%
arrange(patient_id, date) %>%
group_by(patient_id) %>%
mutate(
vax_index=row_number()
) %>%
ungroup()
data_vax
})
# pivot to wide-form table that lists dates and products for up to 4 sequential doses
data_vax_wide = data_vax %>%
pivot_wider(
id_cols= patient_id,
names_from = c("vax_index"),
values_from = c("date", "type"),
names_glue = "covid_vax_{vax_index}_{.value}"
)
# merge with full data-set
data_processed_updated <- data_processed %>%
left_join(data_vax_wide, by ="patient_id") %>%
mutate(
vax1_type = covid_vax_1_type,
vax2_type = covid_vax_2_type,
vax3_type = covid_vax_3_type,
vax4_type = covid_vax_4_type,
vax12_type = paste0(vax1_type, "-", vax2_type),
vax123_type = paste0(vax12_type, "-", vax3_type),
# add new descriptor variables with formal product names
vax1_type_descr = fct_case_when(
vax1_type == "pfizer" ~ "BNT162b2",
vax1_type == "az" ~ "ChAdOx1",
vax1_type == "moderna" ~ "Moderna",
TRUE ~ NA_character_
),
vax2_type_descr = fct_case_when(
vax2_type == "pfizer" ~ "BNT162b2",
vax2_type == "az" ~ "ChAdOx1",
vax2_type == "moderna" ~ "Moderna",
TRUE ~ NA_character_
),
vax3_type_descr = fct_case_when(
vax3_type == "pfizer" ~ "BNT162b2",
vax3_type == "az" ~ "ChAdOx1",
vax3_type == "moderna" ~ "Moderna",
TRUE ~ NA_character_
),
vax4_type_descr = fct_case_when(
vax4_type == "pfizer" ~ "BNT162b2",
vax4_type == "az" ~ "ChAdOx1",
vax4_type == "moderna" ~ "Moderna",
TRUE ~ NA_character_
),
vax1_date = covid_vax_1_date,
vax2_date = covid_vax_2_date,
vax3_date = covid_vax_3_date,
vax4_date = covid_vax_4_date,
# Calculate time between vaccinations
tbv1_2 = as.numeric(vax2_date - vax1_date),
tbv2_3 = as.numeric(vax3_date - vax2_date),
tbv3_4 = as.numeric(vax4_date - vax3_date),
prior_covid_cat = ifelse(prior_covid_date < vax3_date & prior_covid_date >= vax2_date, 1, NA),
prior_covid_cat = ifelse(prior_covid_date < vax2_date & prior_covid_date >= vax1_date, 2, NA),
prior_covid_cat = ifelse(prior_covid_date < vax1_date, 3, prior_covid_cat),
prior_covid_cat = fct_case_when(
prior_covid_cat == 1 ~ "Between second and third dose",
prior_covid_cat == 2 ~ "Between first and second dose",
prior_covid_cat == 3 ~ "Prior to first dose",
TRUE ~ NA_character_
)
) %>%
# Remove unneccessary variables including overall and product-specific dates (now replaced by vax{N}_date)
select(
-starts_with(c("covid_vax_", "pfizer_date_", "az_date_", "moderna_date_", "immunosuppression_"))
)
# remove type combinations if latter vaccine not administered
data_processed_updated$vax12_type[is.na(data_processed_updated$vax2_type)] = NA_character_
data_processed_updated$vax123_type[is.na(data_processed_updated$vax3_type)] = NA_character_
# Save dataset as .rds files ----
write_rds(data_processed_updated, here::here("output", "data", "data_processed.rds"), compress = "gz")
write_csv(data_processed_updated, here::here("output", "data", "data_processed.csv"))
## Import libraries ----
library('tidyverse')
library('lubridate')
library('here')
library('glue')
## Import custom user functions
source(here("analysis", "functions.R"))
## Import libraries ----
library('tidyverse')
library('lubridate')
library('here')
library('glue')
## Import custom user functions
source(here("analysis", "functions.R"))
## Import processed data ----
data_processed <- read_rds(here("output", "data", "data_processed.rds"))
# vaccine initiation dates
first_pfizer = as_date("2020-12-08")
first_az = as_date("2021-01-04")
first_moderna = as_date("2021-04-13")
# Define selection criteria ----
data_criteria <- data_processed %>%
transmute(
patient_id,
has_ckd = !is.na(ckd_inclusion) & ckd_inclusion==1,
has_age = !is.na(age) & age >=16 & age<120,
has_sex = !is.na(sex),
has_imd = !is.na(imd),
has_ethnicity = !is.na(ethnicity),
has_region = !is.na(region),
#isnot_hscworker = !hscworker,
#isnot_carehomeresident = !care_home_combined,
#isnot_endoflife = !endoflife,
#isnot_housebound = !housebound,
vax_afterfirstvaxdate = case_when(
(vax1_type=="pfizer") & (vax1_date >= first_pfizer) ~ TRUE,
(vax1_type=="az") & (vax1_date >= first_az) ~ TRUE,
(vax1_type=="moderna") & (vax1_date >= first_moderna) ~ TRUE,
(vax2_type=="pfizer") & (vax2_date >= first_pfizer) ~ TRUE,
(vax2_type=="az") & (vax2_date >= first_az) ~ TRUE,
(vax2_type=="moderna") & (vax2_date >= first_moderna) ~ TRUE,
(vax3_type=="pfizer") & (vax3_date >= first_pfizer) ~ TRUE,
(vax3_type=="az") & (vax3_date >= first_az) ~ TRUE,
(vax3_type=="moderna") & (vax3_date >= first_moderna) ~ TRUE,
TRUE ~ FALSE
),
#vax2_beforelastvaxdate = !is.na(vax2_date) & (vax2_date <= study_dates$lastvax2_date),
#vax3_afterstudystartdate = (vax3_date >= study_dates$studystart_date) | is.na(vax3_date),
#vax3_beforelastvaxdate = (vax3_date <= study_dates$lastvax3_date) & !is.na(vax3_date),
#vax12_homologous = vax1_type==vax2_type,
has_vaxgap12 = tbv1_2 >= 14 | is.na(vax2_date), # at least 14 days between dose 1 and dose 2 if dose 2 given
has_vaxgap23 = tbv2_3 >= 14 | is.na(vax3_date), # at least 14 days between dose 2 and dose 3 if dose 3 given
has_vaxgap34 = tbv3_4 >= 14 | is.na(vax4_date), # at least 14 days between dose 3 and dose 4 f dose 3 given
#has_knownvax1 = vax1_type %in% c("pfizer", "az", "moderna"),
#has_knownvax2 = vax2_type %in% c("pfizer", "az", "moderna"),
#has_knownvax3 = vax3_type %in% c("pfizer", "az", "moderna"),
#has_knownvax4 = vax4_type %in% c("pfizer", "az", "moderna"),
#jcvi_group_6orhigher = jcvi_group %in% as.character(1:6),
include = (
#jcvi_group_6orhigher & # temporary until more data available
has_ckd & has_age &
has_sex & has_imd & has_ethnicity & has_region &
vax_afterfirstvaxdate & has_vaxgap12 & has_vaxgap23 & has_vaxgap34 #&
#has_knownvax1 & has_knownvax2 & has_knownvax3 & has_knownvax4 & #vax12_homologous &
#isnot_hscworker &
#isnot_carehomeresident & isnot_endoflife &
#isnot_housebound
)
)
?case_when
# Define selection criteria ----
data_criteria <- data_processed %>%
transmute(
patient_id,
has_ckd = !is.na(ckd_inclusion) & ckd_inclusion==1,
has_age = !is.na(age) & age >=16 & age<120,
has_sex = !is.na(sex),
has_imd = !is.na(imd),
has_ethnicity = !is.na(ethnicity),
has_region = !is.na(region),
#isnot_hscworker = !hscworker,
#isnot_carehomeresident = !care_home_combined,
#isnot_endoflife = !endoflife,
#isnot_housebound = !housebound,
vax_afterfirstvaxdate = case_when(
(vax1_type=="pfizer") & (vax1_date >= first_pfizer) ~ TRUE,
(vax1_type=="az") & (vax1_date >= first_az) ~ TRUE,
(vax1_type=="moderna") & (vax1_date >= first_moderna) ~ TRUE,
(vax2_type=="pfizer") & (vax2_date >= first_pfizer) ~ TRUE,
(vax2_type=="az") & (vax2_date >= first_az) ~ TRUE,
(vax2_type=="moderna") & (vax2_date >= first_moderna) ~ TRUE,
(vax3_type=="pfizer") & (vax3_date >= first_pfizer) ~ TRUE,
(vax3_type=="az") & (vax3_date >= first_az) ~ TRUE,
(vax3_type=="moderna") & (vax3_date >= first_moderna) ~ TRUE,
is.na(vax1_type) ~ TRUE,
TRUE ~ FALSE
),
#vax2_beforelastvaxdate = !is.na(vax2_date) & (vax2_date <= study_dates$lastvax2_date),
#vax3_afterstudystartdate = (vax3_date >= study_dates$studystart_date) | is.na(vax3_date),
#vax3_beforelastvaxdate = (vax3_date <= study_dates$lastvax3_date) & !is.na(vax3_date),
#vax12_homologous = vax1_type==vax2_type,
has_vaxgap12 = tbv1_2 >= 14 | is.na(vax2_date), # at least 14 days between dose 1 and dose 2 if dose 2 given
has_vaxgap23 = tbv2_3 >= 14 | is.na(vax3_date), # at least 14 days between dose 2 and dose 3 if dose 3 given
has_vaxgap34 = tbv3_4 >= 14 | is.na(vax4_date), # at least 14 days between dose 3 and dose 4 f dose 3 given
#has_knownvax1 = vax1_type %in% c("pfizer", "az", "moderna"),
#has_knownvax2 = vax2_type %in% c("pfizer", "az", "moderna"),
#has_knownvax3 = vax3_type %in% c("pfizer", "az", "moderna"),
#has_knownvax4 = vax4_type %in% c("pfizer", "az", "moderna"),
#jcvi_group_6orhigher = jcvi_group %in% as.character(1:6),
include = (
#jcvi_group_6orhigher & # temporary until more data available
has_ckd & has_age &
has_sex & has_imd & has_ethnicity & has_region &
vax_afterfirstvaxdate & has_vaxgap12 & has_vaxgap23 & has_vaxgap34 #&
#has_knownvax1 & has_knownvax2 & has_knownvax3 & has_knownvax4 & #vax12_homologous &
#isnot_hscworker &
#isnot_carehomeresident & isnot_endoflife &
#isnot_housebound
)
)
View(data_criteria)
# Define selection criteria ----
data_criteria <- data_processed %>%
transmute(
patient_id,
has_ckd = !is.na(ckd_inclusion) & ckd_inclusion==1,
has_age = !is.na(age) & age >=16 & age<120,
has_sex = !is.na(sex),
has_imd = !is.na(imd),
has_ethnicity = !is.na(ethnicity),
has_region = !is.na(region),
#isnot_hscworker = !hscworker,
#isnot_carehomeresident = !care_home_combined,
#isnot_endoflife = !endoflife,
#isnot_housebound = !housebound,
# vax_afterfirstvaxdate = case_when(
#   (vax1_type=="pfizer") & (vax1_date >= first_pfizer) ~ TRUE,
#   (vax1_type=="az") & (vax1_date >= first_az) ~ TRUE,
#   (vax1_type=="moderna") & (vax1_date >= first_moderna) ~ TRUE,
#   (vax2_type=="pfizer") & (vax2_date >= first_pfizer) ~ TRUE,
#   (vax2_type=="az") & (vax2_date >= first_az) ~ TRUE,
#   (vax2_type=="moderna") & (vax2_date >= first_moderna) ~ TRUE,
#   (vax3_type=="pfizer") & (vax3_date >= first_pfizer) ~ TRUE,
#   (vax3_type=="az") & (vax3_date >= first_az) ~ TRUE,
#   (vax3_type=="moderna") & (vax3_date >= first_moderna) ~ TRUE,
#   is.na(vax1_type) ~ TRUE,
#   TRUE ~ FALSE
# ),
#vax2_beforelastvaxdate = !is.na(vax2_date) & (vax2_date <= study_dates$lastvax2_date),
#vax3_afterstudystartdate = (vax3_date >= study_dates$studystart_date) | is.na(vax3_date),
#vax3_beforelastvaxdate = (vax3_date <= study_dates$lastvax3_date) & !is.na(vax3_date),
#vax12_homologous = vax1_type==vax2_type,
has_vaxgap12 = tbv1_2 >= 14 | is.na(vax2_date), # at least 14 days between dose 1 and dose 2 if dose 2 given
has_vaxgap23 = tbv2_3 >= 14 | is.na(vax3_date), # at least 14 days between dose 2 and dose 3 if dose 3 given
has_vaxgap34 = tbv3_4 >= 14 | is.na(vax4_date), # at least 14 days between dose 3 and dose 4 f dose 3 given
#has_knownvax1 = vax1_type %in% c("pfizer", "az", "moderna"),
#has_knownvax2 = vax2_type %in% c("pfizer", "az", "moderna"),
#has_knownvax3 = vax3_type %in% c("pfizer", "az", "moderna"),
#has_knownvax4 = vax4_type %in% c("pfizer", "az", "moderna"),
#jcvi_group_6orhigher = jcvi_group %in% as.character(1:6),
include = (
#jcvi_group_6orhigher & # temporary until more data available
has_ckd & has_age &
has_sex & has_imd & has_ethnicity & has_region &
#vax_afterfirstvaxdate &
has_vaxgap12 & has_vaxgap23 & has_vaxgap34 #&
#has_knownvax1 & has_knownvax2 & has_knownvax3 & has_knownvax4 & #vax12_homologous &
#isnot_hscworker &
#isnot_carehomeresident & isnot_endoflife &
#isnot_housebound
)
)
data_cohort <- data_criteria %>%
filter(include) %>%
select(patient_id) %>%
left_join(data_processed, by="patient_id") %>%
select(-ckd_inclusion) %>%
droplevels()
write_rds(data_cohort, here("output", "data", "data_cohort.rds"), compress="gz")
write_csv(data_cohort, here::here("output", "data", "data_cohort.csv"))
data_flowchart <- data_criteria %>%
transmute(
c0 = has_age & has_ckd,
c1 = c0 & (has_sex & has_imd & has_ethnicity & has_region),
c2 = c1 & (has_vaxgap12 & has_vaxgap23 & has_vaxgap34)
#c0 = vax1_afterfirstvaxdate & vax2_beforelastvaxdate & vax3_afterstudystartdate & jcvi_group_6orhigher,
#c1_1yearfup = c0_all & (has_follow_up_previous_year),
#c1 = c0 & (has_age & has_sex & has_imd & has_ethnicity & has_region),
#c2 = c1 & (has_vaxgap12 & has_vaxgap23 & has_knownvax1 & has_knownvax2 & vax12_homologous),
#c3 = c2 & (isnot_hscworker ),
#c4 = c3 & (isnot_carehomeresident & isnot_endoflife & isnot_housebound),
#c5 = c4 & vax3_beforelastvaxdate & has_expectedvax3type
) %>%
summarise(
across(.fns=sum)
) %>%
pivot_longer(
cols=everything(),
names_to="criteria",
values_to="n"
) %>%
mutate(
n_exclude = lag(n) - n,
pct_exclude = n_exclude/lag(n),
pct_all = n / first(n),
pct_step = n / lag(n),
crit = str_extract(criteria, "^c\\d+"),
criteria = fct_case_when(
crit == "c0" ~ "Aged 16+ with eGFR<60 in 2 years before first dose or any prior dialysis/end-stage renal disease flag", # paste0("Aged 18+\n with 2 doses on or before ", format(study_dates$lastvax2_date, "%d %b %Y")),
crit == "c1" ~ "  with no missing demographic information",
crit == "c2" ~ "  with no vaccines administered at an interval of <14 days or before product introduction",
TRUE ~ NA_character_
)
)
data_flowchart <- data_criteria %>%
transmute(
c0 = has_age & has_ckd,
c1 = c0 & (has_sex & has_imd & has_ethnicity & has_region),
c2 = c1 & (has_vaxgap12 & has_vaxgap23 & has_vaxgap34)
#c0 = vax1_afterfirstvaxdate & vax2_beforelastvaxdate & vax3_afterstudystartdate & jcvi_group_6orhigher,
#c1_1yearfup = c0_all & (has_follow_up_previous_year),
#c1 = c0 & (has_age & has_sex & has_imd & has_ethnicity & has_region),
#c2 = c1 & (has_vaxgap12 & has_vaxgap23 & has_knownvax1 & has_knownvax2 & vax12_homologous),
#c3 = c2 & (isnot_hscworker ),
#c4 = c3 & (isnot_carehomeresident & isnot_endoflife & isnot_housebound),
#c5 = c4 & vax3_beforelastvaxdate & has_expectedvax3type
) %>%
summarise(
across(.fns=sum)
) %>%
pivot_longer(
cols=everything(),
names_to="criteria",
values_to="n"
) %>%
mutate(
n_exclude = lag(n) - n,
pct_exclude = n_exclude/lag(n),
pct_all = n / first(n),
pct_step = n / lag(n),
crit = str_extract(criteria, "^c\\d+"),
criteria = fct_case_when(
crit == "c0" ~ "Aged 16+ with eGFR<60 in 2 years before first dose or any prior dialysis/end-stage renal disease flag", # paste0("Aged 18+\n with 2 doses on or before ", format(study_dates$lastvax2_date, "%d %b %Y")),
crit == "c1" ~ "  with no missing demographic information",
crit == "c2" ~ "  with no vaccines administered at an interval of <14 days",
TRUE ~ NA_character_
)
)
write_csv(data_flowchart, here("output", "data", "flowchart.csv"))
## Import libraries
library('tidyverse')
library('here')
library('glue')
library('gt')
library('gtsummary')
library('reshape2')
## Create output directory
fs::dir_create(here::here("output", "tables"))
## Import data
data_processed <- read_rds(here::here("output", "data", "data_cohort.rds"))
## Format data
data_processed <- data_processed %>%
mutate(group = ifelse(care_home_65plus == 1, 1, NA),
group = ifelse(is.na(group) & ageband == 3, 2, group),
group = ifelse(is.na(group) & hscworker == 1, 3, group),
group = ifelse(is.na(group) & ageband == 2, 4, group),
group = ifelse(is.na(group) & shielded == 1, 5, group),
group = ifelse(is.na(group) & age >=50 & age <70, 6, group),
group = ifelse(is.na(group), 7, group),
group = factor(group),
ageband3 = cut(
age,
breaks = c(16, 50, 60, 70, 80, Inf),
labels = c("16-50", "50-59", "60-69", "70-79", "80+"),
right = FALSE)) %>%
group_by(patient_id) %>%
ungroup()
## Counts
counts0 <- data_processed %>%
mutate(time_between_vaccinations1_2 = cut(tbv1_2,
breaks = c(0, 42, 84, Inf),
labels = c("6 weeks or less", "6-12 weeks", "12 weeks or more"),
right = FALSE),
time_between_vaccinations2_3 = cut(tbv2_3,
breaks = c(0, 84, 168, Inf),
labels = c("12 weeks or less", "12-24 weeks", "24 weeks or more"),
right = FALSE),
smoking_status = ifelse(is.na(smoking_status), "N&M", smoking_status)) %>%
select(ageband3,
sex,
bmi,
smoking_status,
ethnicity,
imd,
region,
asthma,
asplenia,
bpcat,
cancer,
diabetes,
chd,
haem_cancer,
immunosuppression,
#chronic_kidney_disease,
learning_disability,
cld,
chronic_neuro_dis_inc_sig_learn_dis,
chronic_resp_dis,
dialysis,
sev_mental_ill,
organ_transplant,
time_between_vaccinations1_2,
time_between_vaccinations2_3,
prior_covid_cat) %>%
tbl_summary()
counts0$inputs$data <- NULL
table1 <- counts0$table_body %>%
select(group = variable, variable = label, count = stat_0) %>%
separate(count, c("count","perc"), sep = "([(])") %>%
mutate(count = gsub(" ", "", count),
count = as.numeric(gsub(",", "", count))) %>%
filter(!(is.na(count))) %>%
select(-perc) %>%
filter(!(group == "prior_covid_cat" & variable == "Unknown"))
table1$percent = round(table1$count/nrow(data_processed)*100,1)
colnames(table1) = c("Group", "Variable", "Count", "Percent")
## Redact values < 8
threshold = 8
table1_redacted <- table1 %>%
mutate(Count = ifelse(Count < threshold, NA, as.numeric(Count)),
Percent = ifelse(is.na(Count), NA, Percent))
## Round to nearest 5
table1_redacted <- table1_redacted %>%
mutate(Count = plyr::round_any(Count, 5))
table1_redacted$percent = round(table1$count/nrow(data_processed)*100,1)
table1_redacted
table1_redacted$percent = round(table1_redacted$count/nrow(data_processed)*100,1)
table1_redacted$Percent = round(table1_redacted$Count/nrow(data_processed)*100,1)
table1_redacted
# Save as html ----
gt::gtsave(gt(table1_redacted), here::here("output","tables", "table1_redacted.html"))
knitr::opts_chunk$set(echo = FALSE)
## Import libraries
library('tidyverse')
library('here')
library('glue')
library('gt')
library('gtsummary')
library('reshape2')
library('plyr')
## Import custom user functions
source(here("analysis", "functions.R"))
knitr::opts_chunk$set(echo = FALSE)
## Import libraries
library('tidyverse')
## packages
library('tidyverse')
library('lubridate')
library('here')
## Import custom user functions and packages
source(here("analysis", "functions.R"))
