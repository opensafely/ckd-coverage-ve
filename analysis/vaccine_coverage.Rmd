---
title: "Vaccine coverag over time - CKD"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

## Import libraries
library('tidyverse')
library('here')
library('glue')
library('gt')
library('gtsummary')
library('reshape2')
library('plyr')
library('kableExtra')

## Import custom user functions
source(here::here("analysis", "functions.R"))

## Create output directory
fs::dir_create(here::here("output", "tables"))

## Import data
data_cohort <- read_rds(here::here("output", "data", "data_cohort.rds"))

if (data_cohort$mock_data_flag[1]==1) { flag = "present" } else { flag = "absent" }
```

### Cohort summary
* Total N of `r formatC(nrow(data_cohort), big.mark=",")` meeting inclusion criteria (see *output/data/flowchart.csv*)   
* See *output/tables/table1_redacted.html* for summary of key covariates    
* Dummy data flag: `r flag` (should be _absent_ if data processing has been performed on OpenSAFELY server)

### Coverage over time
```{r, message=FALSE}
# Create vector of dates between first and last recorded vaccines
campaign_start <- min(data_cohort$vax1_date, na.rm=T)
end_date <- max(c(data_cohort$vax1_date, data_cohort$vax2_date, data_cohort$vax3_date, data_cohort$vax4_date), na.rm=T)

# create vector containing every other week
date_vec <- seq(campaign_start, end_date, by="weeks")
date_vec <- date_vec[seq(1, length(date_vec), 2)]

# cumulative table
t_all <- data.frame(date = date_vec)
for (i in 1:nrow(t_all)) {
  date_ref = t_all$date[i]
  t_all$dose1_total[i] = round_any(sum(data_cohort$vax1_date<date_ref, na.rm=T), 5)
  t_all$dose2_total[i] = round_any(sum(data_cohort$vax2_date<date_ref, na.rm=T), 5) 
  t_all$dose3_total[i] = round_any(sum(data_cohort$vax3_date<date_ref, na.rm=T), 5)
  t_all$dose4_total[i] = round_any(sum(data_cohort$vax4_date<date_ref, na.rm=T), 5)

  t_all$dose1_pfizer[i] = round_any(sum(data_cohort$vax1_type=="pfizer" & data_cohort$vax1_date<date_ref, na.rm=T), 5)
  t_all$dose2_pfizer[i] = round_any(sum(data_cohort$vax2_type=="pfizer" &data_cohort$vax2_date<date_ref, na.rm=T), 5) 
  t_all$dose3_pfizer[i] = round_any(sum(data_cohort$vax2_type=="pfizer" &data_cohort$vax3_date<date_ref, na.rm=T), 5) 
  t_all$dose4_pfizer[i] = round_any(sum(data_cohort$vax2_type=="pfizer" &data_cohort$vax4_date<date_ref, na.rm=T), 5)

  t_all$dose1_az[i] = round_any(sum(data_cohort$vax1_type=="az" & data_cohort$vax1_date<date_ref, na.rm=T), 5) 
  t_all$dose2_az[i] = round_any(sum(data_cohort$vax2_type=="az" &data_cohort$vax2_date<date_ref, na.rm=T), 5) 
  t_all$dose3_az[i] = round_any(sum(data_cohort$vax3_type=="az" &data_cohort$vax3_date<date_ref, na.rm=T), 5) 
  t_all$dose4_az[i] = round_any(sum(data_cohort$vax4_type=="az" &data_cohort$vax4_date<date_ref, na.rm=T), 5)

  t_all$dose1_moderna[i] = round_any(sum(data_cohort$vax1_type=="moderna" & data_cohort$vax1_date<date_ref, na.rm=T), 5)
  t_all$dose2_moderna[i] = round_any(sum(data_cohort$vax2_type=="moderna" &data_cohort$vax2_date<date_ref, na.rm=T), 5) 
  t_all$dose3_moderna[i] = round_any(sum(data_cohort$vax3_type=="moderna" &data_cohort$vax3_date<date_ref, na.rm=T), 5) 
  t_all$dose4_moderna[i] = round_any(sum(data_cohort$vax4_type=="moderna" &data_cohort$vax4_date<date_ref, na.rm=T), 5)
  
  t_all$az_az[i] = round_any(sum(data_cohort$vax2_date<date_ref & data_cohort$vax12_type=="az-az", na.rm=T), 5)
  t_all$pfizer_pfizer[i] = round_any(sum(data_cohort$vax2_date<date_ref & data_cohort$vax12_type=="pfizer-pfizer", na.rm=T), 5)
  t_all$moderna_moderna[i] = round_any(sum(data_cohort$vax2_date<date_ref & data_cohort$vax12_type=="moderna-moderna", na.rm=T), 5)
  t_all$heterologous_dose2[i] = round_any(sum(data_cohort$vax2_date<date_ref & (data_cohort$vax1_type!=data_cohort$vax2_type), na.rm=T), 5)
}

# Save as html ----
write_csv(t_all, here::here("output", "tables", "coverage_over_time_rounded.csv"))
```

### Cumulative dose distribution over time
```{r}
palette = c("#3B9AB2","#78B7C5","#EBCC2A","#E1AF00","#B40F20")
t_plot = rbind(
  data.frame(dose = "dose 1", total = t_all$dose1_total, date = t_all$date),
  data.frame(dose = "dose 2", total = t_all$dose2_total, date = t_all$date),
  data.frame(dose = "dose 3", total = t_all$dose3_total, date = t_all$date),
  data.frame(dose = "dose 4", total = t_all$dose4_total, date = t_all$date)
)
ggplot(t_plot, aes(x = date, y = total, colour = dose)) + geom_line() +
          theme_bw() + ylab("doses given") + scale_colour_manual(values = palette[c(1,2,4,5)]) +
          theme(legend.position="right") +
  theme(plot.title = element_text(size=14, hjust=0.5), axis.text = element_text(size=14), axis.title = element_text(size=14))
```

### Primary series product distribution over time
```{r}
palette = c("#003c30","#b2182b","#74add1","grey")
t_plot = rbind(
  data.frame(Product = "2 x ChAdOx1-S", total = t_all$az_az, date = t_all$date),
  data.frame(Product = "2 x Pfizer", total = t_all$pfizer_pfizer, date = t_all$date),
  data.frame(Product = "2 x Moderna", total = t_all$moderna_moderna, date = t_all$date),
  data.frame(Product = "Heterologous", total = t_all$heterologous, date = t_all$date)
)
ggplot(t_plot, aes(x = date, y = total, colour = Product)) + geom_line() +
          theme_bw() + ylab("doses given") + scale_colour_manual(values = palette[c(1,2,3,4)]) +
          theme(legend.position="right") +
  theme(plot.title = element_text(size=14, hjust=0.5), axis.text = element_text(size=14), axis.title = element_text(size=14))
```

## Population profile

### Dose 1 profile
```{r}
t_dose = data.frame(table(data_cohort$vax1_type_descr))
t_dose$Freq = round_any(t_dose$Freq,5)
t_dose$Prop = round(t_dose$Freq/sum(t_dose$Freq)*100,1)
names(t_dose) = c("Vaccine", "Frequency", "Percent")
t_dose
```
Rounded to nearest 5

### Dose 2 profile
```{r}
t_dose = data.frame(table(data_cohort$vax2_type_descr))
t_dose$Freq = round_any(t_dose$Freq,5)
t_dose$Prop = round(t_dose$Freq/sum(t_dose$Freq)*100,1)
names(t_dose) = c("Vaccine", "Frequency", "Percent")
t_dose
```
Rounded to nearest 5

### Dose 3 profile
```{r}
t_dose = data.frame(table(data_cohort$vax3_type_descr))
t_dose$Freq = round_any(t_dose$Freq,5)
t_dose$Prop = round(t_dose$Freq/sum(t_dose$Freq)*100,1)
names(t_dose) = c("Vaccine", "Frequency", "Percent")
t_dose
```
Rounded to nearest 5

### Dose 4 profile
```{r}
t_dose = data.frame(table(data_cohort$vax4_type_descr))
t_dose$Freq = round_any(t_dose$Freq,5)
t_dose$Prop = round(t_dose$Freq/sum(t_dose$Freq)*100,1)
names(t_dose) = c("Vaccine", "Frequency", "Percent")
t_dose
```
Rounded to nearest 5


### Dose 1-2 combination 
```{r}
t_dose = data.frame(table(data_cohort$vax12_type))
t_dose$Freq = round_any(t_dose$Freq,5)
t_dose$Prop = round(t_dose$Freq/sum(t_dose$Freq)*100,1)
names(t_dose) = c("Vaccine", "Frequency", "Percent")
t_dose
```
Rounded to nearest 5

### Dose 1-2-3 combination 
```{r}
t_dose = data.frame(table(data_cohort$vax123_type))
t_dose$Freq = round_any(t_dose$Freq,5)
t_dose$Prop = round(t_dose$Freq/sum(t_dose$Freq)*100,1)
names(t_dose) = c("Vaccine", "Frequency", "Percent")
t_dose
```
Rounded to nearest 5
