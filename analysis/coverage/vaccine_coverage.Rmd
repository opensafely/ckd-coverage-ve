---
title: "Factors associated with COVID-19 vaccine coverage in kidney disease patients"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

## Import libraries
library('here')
library('tidyverse')
library('readr')
library('tidyr')
library('lubridate')
library('glue')
library('gt')
library('gtsummary')
library('reshape2')
library('kableExtra')
library('cowplot')
library('fs')
library('survival')
library('survminer')

# Define analysis cut-off date
end_date <- as_date("2022-04-20")

## Import custom user functions
source(here::here("analysis", "functions.R"))

## Import data
data_cohort <- read_rds(here::here("output", "data", "data_cohort_coverage.rds"))
data_uncensored <- read_rds(here::here("output", "data", "data_cohort_coverage_logistic.rds"))

## Calculate rounded population totals
rounded_n = plyr::round_any(nrow(data_cohort), 5)
rounded_n_uncensored = plyr::round_any(nrow(data_uncensored), 5)

if (data_cohort$mock_data_flag[1]==1) { flag = "present" } else { flag = "absent" }
```
<br/><br/>  

#### Background
Kidney disease is a significant risk factor for COVID-19-related mortality. Although vaccination has the potential to mitigate this risk, chronic kidney disease (CKD) and kideny failure requiring renal replacement therapy (RRT) have been linked with impaired COVID-19 vaccine immunogenicity and high rates of breakthrough infection among individuals who have received a 2-dose primary vaccine series.

Vaccine recommendations for people with kidney disease in the UK have evolved over time (see [protocol](https://docs.google.com/document/d/1w48W-bCMfn0RdkfxlU6fbRkPv3MnIYd3/edit#heading=h.1fob9te). Relative uptake of different vaccines in this population remains uncertain, as does the relative vaccine effectiveness (VE) of different regimens, including homologous versus heterologous vaccine usage. This project seeks to address these key evidence gaps.
<br/><br/>

#### Inclusion criteria
* Registered for at least 3m before index date (01-Dec-2020)    
* Alive on index date    
* Aged â‰¥16 and <120 on index date
* eGFR<60 in 2 years before 01-Dec-2020 OR present in UK renal registry on 31-Dec-2020   
* No missing demographic data   
* Maximum of 5 COVID-19 doses recorded
* No dose intervals of <14 days across first 4 doses

A total of **`r prettyNum(rounded_n)`** (rounded to the nearest 5) met the inclusion criteria (see *output/data/flowchart.csv* for additional details), of which **`r prettyNum(rounded_n_uncensored)`** remained uncensored (alive and registered) throughout follow-up (01-Dec-2020 to 20-Apr-2022).

`r if(flag=="present") { paste0("NB: Dummy data processing flag detected!") }`    
<br/><br/>  

#### Cohort selection
```{r}
flowchart <- read.csv(here::here("output", "tables", "flowchart_coverage.csv"))
names(flowchart)[1] = "Criteria"
flowchart %>%
  mutate(`N (rounded)` = plyr::round_any(flowchart$n, 5)) %>%
  select(Criteria, `N (rounded)`) %>%
  gt() %>%
  tab_options(table.font.size = pct(95))
```
<br/><br/>

#### Table 1: Summary of population
```{r}
table_1 <- read_rds(here::here("output", "tables", "table1_coverage_redacted_by_CKD.rds"))

## Set factor levels for group
table_1$Group[table_1$Group=="Other"] = "Risk group"

## Render table
table_1 %>% 
   gt(groupname_col = "Group") %>%
   tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold") %>%
   tab_style(
     style = cell_text(indent = pct(5)),
     locations = cells_body(columns = "Variable")
     ) %>%
   tab_options(table.font.size = pct(95)) %>% #table.width = pct(80) 
   tab_footnote(
     footnote = "All counts rounded to nearest 5; any rounded counts <=10 or within <=10 of population total redacted.",
     locations = cells_column_labels(columns = "Variable")
   )

## Calculate breakdown of CKD4-5 
ckd4_5_sum = plyr::round_any(sum(data_cohort$ckd_6cat=="CKD4" | data_cohort$ckd_6cat=="CKD5"),5)
ckd4_sum = plyr::round_any(sum(data_cohort$ckd_6cat=="CKD4"),5)
ckd5_sum = plyr::round_any(sum(data_cohort$ckd_6cat=="CKD5"),5)
```
<br/>Of the `r prettyNum(ckd4_5_sum)` individuals with CKD4-5, `r prettyNum(ckd4_sum)` had CKD 4 and `r prettyNum(ckd5_sum)` had CKD 5. 
<br/><br/>    

#### Coverage as of 20-Apr-2022
```{r}
#### Generate Kaplan-Meier tte data for each dose
data_km <- data_cohort %>%
  mutate(
    # Start date
    start_date = as.Date("2020-12-01", format = "%Y-%m-%d"),
    
    # End date
    end_date = as.Date("2022-04-20", format = "%Y-%m-%d"),
    
    # Censoring
    censor_date = pmin(death_date, 
                       dereg_date, 
                       end_date, 
                       na.rm=TRUE),
    
    # Follow-up time
    follow_up_time_dose1 = tte(start_date, vax1_date, censor_date),
    follow_up_time_dose2 = tte(start_date, vax2_date, censor_date),
    follow_up_time_dose3 = tte(start_date, vax3_date, censor_date),
    follow_up_time_dose4 = tte(start_date, vax4_date, censor_date),

    # COVID vaccination: 1 of vaccinated before end date, 0 otherwise
    covid_vax_dose1 = dplyr::if_else((vax1_date>censor_date) | is.na(vax1_date), 0, 1),
    covid_vax_dose2 = dplyr::if_else((vax2_date>censor_date) | is.na(vax2_date), 0, 1),
    covid_vax_dose3 = dplyr::if_else((vax3_date>censor_date) | is.na(vax3_date), 0, 1),
    covid_vax_dose4 = dplyr::if_else((vax4_date>censor_date) | is.na(vax4_date), 0, 1),
    
    # Uncensored pre cut-off
    uncensored_at_cut_off = ifelse(
                              (is.na(death_date) & is.na(dereg_date)) | 
                              (!is.na(death_date) & death_date>end_date) | 
                              (!is.na(dereg_date) & dereg_date>end_date), 1, 0)
)

## Function to generate rounded survival table (steps delayed to include at least 10 events)
surv_table = function(dose, dosenum, data_input, threshold=10) {
  #decimal_threshold = 10/nrow(data_input)
  surv = survfit(as.formula(paste0("Surv(follow_up_time_",dose,", covid_vax_",dose,") ~ 1")), data = data_input) %>% 
    broom::tidy() %>% 
    filter(estimate > 0) %>%
    mutate(
      N = plyr::round_any(max(n.risk, na.rm=TRUE),threshold),
      cml.event = cumsum(replace_na(n.event, 0)),
      cml.censor = cumsum(replace_na(n.censor, 0)),
      cml.event.floor = floor_any(cml.event, threshold),
      cml.censor.floor = floor_any(cml.censor, threshold),
      n.event.floor = diff(c(0,cml.event.floor)),
      n.censor.floor = diff(c(0,cml.censor.floor)),
      n.risk.floor = N - lag(cml.event.floor + cml.censor.floor,1,0),
      surv.floor = cumprod(1 - n.event.floor / n.risk.floor),
      cum.in.floor = 1 - surv.floor,
      #estimate_rounded = pmin(1,plyr::round_any(estimate, decimal_threshold), na.rm=TRUE),
      #cum.in_rounded = 1 - estimate_rounded,
      dose = paste0("dose ",dosenum),
      date = as.Date("2020-12-01", format = "%Y-%m-%d")+time
    ) %>%
    select(time, n.risk.floor, n.censor.floor, cum.in.floor, dose, date) %>%
    filter(time>=0)
}

km_collated = rbind(
  surv_table("dose1", 1, data_km),
  surv_table("dose2", 2, data_km),
  surv_table("dose3", 3, data_km),
  surv_table("dose4", 4, data_km)
)


## Calculate coverage in total and uncensored populations
collated = data.frame(
  Dose = c("1", "2", "3", "4"),
  N_cohort_total = rep(rounded_n, 4),
  N_vaccinated_total = c(sum(data_cohort$vax1_date<=end_date, na.rm=T), sum(data_cohort$vax2_date<=end_date, na.rm=T), 
                         sum(data_cohort$vax3_date<=end_date, na.rm=T), sum(data_cohort$vax4_date<=end_date, na.rm=T))
) %>%
  mutate(
    N_vaccinated_total = plyr::round_any(N_vaccinated_total, 5),
    coverage_total = round(N_vaccinated_total/N_cohort_total*100,1),
    N_cohort_uncensored = rep(rounded_n_uncensored, 4),
    N_vaccinated_uncensored = c(sum(data_uncensored$vax1_date<=end_date, na.rm=T), sum(data_uncensored$vax2_date<=end_date, na.rm=T), 
                                sum(data_uncensored$vax3_date<=end_date, na.rm=T), sum(data_uncensored$vax4_date<=end_date, na.rm=T)),
    N_vaccinated_uncensored = plyr::round_any(N_vaccinated_uncensored, 5),
    coverage_uncensored = round(N_vaccinated_uncensored/N_cohort_uncensored*100,1)
  )
names(collated) = c("Dose", "N (total)", "n vaccinated (total)", "Coverage (total), %",
                            "N (uncensored)", "n vaccinated (uncensored)", "Coverage (uncensored), %")

collated$`Cumulative coverage` = c(round(max(subset(km_collated, dose=="dose 1")$cum.in.floor)*100,1),
                      round(max(subset(km_collated, dose=="dose 2")$cum.in.floor)*100,1),
                      round(max(subset(km_collated, dose=="dose 3")$cum.in.floor)*100,1),
                      round(max(subset(km_collated, dose=="dose 4")$cum.in.floor)*100,1))

## Generate table
gt(collated) %>%
   tab_spanner(
    label = "Total",
    columns = c("N (total)", "n vaccinated (total)", "Coverage (total), %")
  ) %>%
    tab_spanner(
    label = "Uncensored",
    columns = c("N (uncensored)", "n vaccinated (uncensored)", "Coverage (uncensored), %")
  ) %>%
    tab_spanner(
    label = "KM",
    columns = c("Cumulative coverage")
  ) %>%
  tab_options(table.font.size = pct(95))
```
<br/><br/>

#### Subgroup coverage as of 20-Apr-2022 (1 - KM)
```{r}
extract_subset_max = function(selected_subset) {
  data.frame(
    cov = c(round(max(surv_table("dose1", 1, subset(data_km, ckd_5cat==selected_subset))$cum.in.floor)*100,1),
        round(max(surv_table("dose2", 2, subset(data_km, ckd_5cat==selected_subset))$cum.in.floor)*100,1),
        round(max(surv_table("dose3", 3, subset(data_km, ckd_5cat==selected_subset))$cum.in.floor)*100,1),
        round(max(surv_table("dose4", 4, subset(data_km, ckd_5cat==selected_subset))$cum.in.floor)*100,1))
  )
}
collated_cov = cbind(
  dose = 1:4,
  extract_subset_max("CKD3a"),
  extract_subset_max("CKD3b"),
  extract_subset_max("CKD4-5"),
  extract_subset_max("RRT (dialysis)"),
  extract_subset_max("RRT (Tx)")
)
names(collated_cov) = c("Dose", "CKD3a", "CKD3b", "CKD4-5", "RRT (dialysis)", "RRT (Tx)")
collated_cov %>% gt() %>%
  tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold") %>%
  tab_options(table.font.size = pct(95))
```
<br/><br/>


#### Product profile by dose
```{r}
## Dose 1
t_dose_dose1 = data.frame(table(data_cohort$vax1_type_descr)) %>% 
  redact_table(multiple=FALSE) %>%
  mutate(Group = "Dose 1")

## Dose 2
t_dose_dose2 = data.frame(table(data_cohort$vax2_type_descr)) %>% 
  redact_table(multiple=FALSE) %>%
  mutate(Group = "Dose 2")

## Dose 3
t_dose_dose3 = data.frame(table(data_cohort$vax3_type_descr)) %>% 
  redact_table(multiple=FALSE) %>%
  mutate(Group = "Dose 3")

## Dose 4
t_dose_dose4 = data.frame(table(data_cohort$vax4_type_descr)) %>% 
  redact_table(multiple=FALSE) %>%
  mutate(Group = "Dose 4")

# Generate combined table
collated = rbind(t_dose_dose1, t_dose_dose2, t_dose_dose3, t_dose_dose4)
collated %>% 
  mutate(`N (%)` = paste0(Frequency," (",Percent,"%)")) %>%
  select(-Frequency,-Percent) %>%
  gt(groupname_col = "Group") %>%
  tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold") %>%
  tab_options(table.font.size = pct(95))
```
<br/>Data for full cohort (censored/uncensored). Any counts of <=100 grouped as 'other'; all counts rounded to nearest 5; any rounded counts <=10 redacted.
<br/><br/>  

#### Product combinations across doses
```{r}
## Dose 1-2
t_dose_dose12 = data.frame(table(data_cohort$vax12_type)) %>% 
  redact_table() %>%
  mutate(Group = "Dose 1-2 combination")

## Dose 1-2-3
t_dose_dose123 = data.frame(table(data_cohort$vax123_type)) %>% 
  redact_table() %>%
  mutate(Group = "Dose 1-2-3 combination")

# Generate combined table
rbind(t_dose_dose12, t_dose_dose123) %>% 
  mutate(`N (%)` = paste0(Frequency," (",Percent,"%)")) %>%
  select(-Frequency,-Percent) %>%
  gt(groupname_col = "Group") %>%
  tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold") %>%
  tab_options(table.font.size = pct(95))
```
<br/>
Data for full cohort (censored/uncensored). Any counts of <=100 grouped as 'other'; all counts rounded to nearest 5; any rounded counts or non-counts <=10 redacted.
<br/><br/>  

#### Figure 1: Cumulative coverage and product profile by dose
```{r, fig.width=9, fig.height=3}
## Coverage plot
palette = c("#3B9AB2","#78B7C5","#EBCC2A","#E1AF00","#B40F20")
km_plot = ggplot(km_collated, aes(x = date, y = cum.in.floor*100, colour = factor(dose))) + geom_line() +
          theme_bw()+ scale_colour_manual(values = palette[c(1,2,4,5)]) +
          theme(legend.position="right") + scale_x_date(date_labels = "%b %Y") +
  ylim(0,100) + xlab("Date") + ylab("Cumulative coverage (%)") + labs(colour="Dose") +
  theme(legend.title = element_text(size=14), legend.text = element_text(size=12), 
        axis.text = element_text(size=14), axis.title = element_text(size=14))

### Product profile plot
palette = c("#8da0cb","#fc8d62","#66c2a5","grey")
collated$vaccine = factor(collated$Combination, levels = c("other", "Moderna", "ChAdOx1", "BNT162b2"))
collated$dose = str_replace(collated$Group, "Dose ", "")

# Frequency plot
profile_plot = ggplot(collated, aes(fill=vaccine, y=as.numeric(Frequency)/1000, x=dose)) + 
    geom_bar(position="stack", stat="identity") +
    theme_bw() + ylab("N doses (thousands)") + scale_fill_manual(values = palette[c(2,1,3)]) +
    theme(legend.position="right") + xlab("Dose") + labs(fill="Vaccine") +
    theme(legend.title = element_text(size=14), legend.text = element_text(size=12), 
        axis.text = element_text(size=14), axis.title = element_text(size=14))

plot_grid(km_plot, profile_plot, 
          ncol=2,  align="h", axis = c("tb"), rel_widths=c(1.5,1))
```
<br/>Data delayed for full cohort (censored/uncensored). Kaplan-Meier steps are delayed until at least 10 events have occurred.
<br/><br/>




#### Covariates associated with vaccine coverage: dose 3 by 20 April 2022

##### Approach (1): Cox proportional hazards
```{r}
data_cox <- read_rds(here::here("output", "data", "data_cox_coverage_dose3.rds"))

## Censored populations
total_vax = plyr::round_any(sum(data_cox$covid_vax),5)
total_N = plyr::round_any(nrow(data_cox),5)
vax_perc = round(total_vax/total_N*100,1)

## Uncensored population totals
total_vax_uncensored = plyr::round_any(sum(data_cox$uncensored_at_cut_off==1 & data_cox$unvax_uncensored_at_cut_off==0),5)
total_N_uncensored = plyr::round_any(sum(data_cox$uncensored_at_cut_off),5)
vax_perc_uncensored = round(total_vax_uncensored/total_N_uncensored*100,1)
```

Cox proportional hazards models were used to explore factors associated with completion of a 2-dose series via any product combination between **08-Dec-2020** and **20-Apr-2022**.  
    
Follow-up was censored on the date of death, deregistration, or the end of the study period (20-Apr-2022). Overall coverage among individuals uncensored on 20-Apr-2022 was `r vax_perc_uncensored`% (`r prettyNum(total_vax_uncensored)` / `r prettyNum(total_N_uncensored)`, rounded to nearest 5). 
<br/><br/>
   
##### Sequential adjustment model structure 
* Minimally adjusted models stratified by region included the following covariates: age (5-cat), care home residence (1/0), healthcare worked status (1/0).    
* Partially adjusted models stratified by region included the following covariates: age (5-cat), care home residence (1/0), healthcare worked status (1/0), end of life care (1/0), rurality (3-cat), sex (M/F), ethnicity (6-cat), IMD (5-cat), and prior COVID at baseline (1/0)    
* Fully adjusted models stratified by region included all covariates.
<br/><br/>

##### Multivariate model outputs (scroll left/right for full table)
```{r}
## Function to create clean table of dose-specific cox outputs
create_reduced_tbl = function(input_tbl) {
  ## Add % unvaccinated at cut-off
  input_tbl$perc_vac <- 100-round(as.numeric(input_tbl$n_unvax_at_cut_off)/as.numeric(input_tbl$n_uncensored_at_cut_off)*100,1)
  
  ## Select variables of interes
  tbl_reduced <- input_tbl %>%
    select(var_group, var_label, label, n_obs,  n_event, n_uncensored_at_cut_off, perc_vac,
           estimate_minimal, conf.low_minimal, conf.high_minimal, p.value_minimal,
           estimate_partial, conf.low_partial, conf.high_partial, p.value_partial,
           estimate, conf.low, conf.high, p.value)
  
  ## Relabel columns
  names(tbl_reduced) = c("var_group", "group", "level", "n (total)", "n (vaccinated)", "n (uncensored)", "% vaccinated",
                              "HR (min)", "lower CI (min)", "upper CI (min)", "p (min)",
                              "HR (multi)", "lower CI (multi)", "upper CI (multi)", "p (multi)",
                              "HR (full)", "lower CI (full)", "upper CI (full)", "p (full)")
  return(tbl_reduced)
}

## Function to create formatted gt output
tabulate_reduced_tbl = function(input_tbl) {
  input_tbl %>% 
    gt(rowname_col = "level", groupname_col = "group") %>%
    tab_spanner(
      label = "minimally adjusted",
      columns = c("HR (min)", "lower CI (min)", "upper CI (min)", "p (min)")
    ) %>%
      tab_spanner(
      label = "partially adjusted",
      columns = c("HR (multi)", "lower CI (multi)", "upper CI (multi)", "p (multi)")
    ) %>%
    tab_spanner(
      label = "fully adjusted",
      columns = c("HR (full)", "lower CI (full)", "upper CI (full)", "p (full)")
    )  %>%
    cols_hide(columns = "var_group") %>%
    tab_options(table.font.size = pct(85)) %>%
     tab_style(
        style = list(
          cell_borders(
            sides = c("right"), color = "#cccccc"
          )
          ),
        locations = list(
          cells_body(
            columns = c("p (min)", "p (multi)", "% vaccinated")
          )
        )
     ) %>%
    tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold")
}

dose3_tbl <- read_rds(here::here("output", "model", paste0("mod_strat_coxph_redacted_dose3_full.rds"))) %>%
  create_reduced_tbl()
tabulate_reduced_tbl(dose3_tbl)
```
All counts rounded to nearest 5; data redacted for any rows with rounded values of <=10 for n (vaccinated) or n (unvaccinated), where n (unvaccinated) is the difference between n (total) and n (vaccinated) after rounding. % unvaccinated calculated among individuals who were uncensored at cut-off.<br/><br/>    

#### Plot of partially adjusted model outputs
```{r, fig.width=8, fig.height=12}
## Function to create plot of cox outputs
plot_reduced_tbl = function(input_tbl, dose4=FALSE, level = c("partial", "full")) {
  
  if (level=="partial") {
      input_tbl$HR = input_tbl$`HR (multi)`
      input_tbl$lowerCI = input_tbl$`lower CI (multi)`
      input_tbl$upperCI = input_tbl$`upper CI (multi)`
  } else {
      input_tbl$HR = input_tbl$`HR (full)`
      input_tbl$lowerCI = input_tbl$`lower CI (full)`
      input_tbl$upperCI = input_tbl$`upper CI (full)`
  }
  
  ## Remove redacted components from plot
  input_tbl$HR[input_tbl$HR=="[Redacted]"] = NA
  input_tbl$lowerCI[input_tbl$HR=="[Redacted]"] = NA
  input_tbl$upperCI[input_tbl$HR=="[Redacted]"] = NA
  
  ## Recode HRs and CIs as numerics
  input_tbl$HR = as.numeric(input_tbl$HR)
  input_tbl$lowerCI = as.numeric(input_tbl$lowerCI)
  input_tbl$upperCI = as.numeric(input_tbl$upperCI)
  
  ## Set plot min
  plot_min = 0.5
  if(min(input_tbl$lowerCI, na.rm=T) < plot_min) { plot_min = min(input_tbl$lowerCI, na.rm=T) }
  
  ## Set plot max
  plot_max = 2
  if(max(input_tbl$upperCI, na.rm=T) > plot_max) { plot_max = max(input_tbl$upperCI, na.rm=T) }
  
  ## Add redaction text variable
  input_tbl$redaction = NA
  input_tbl$redaction[input_tbl$`n (total)`=="[Redacted]"] = "[R]"
  
  ## Generate plot of HRs
  g1 = ggplot(input_tbl, aes(y = HR, x = level, colour = var_group)) + 
    geom_point(size = 2, alpha=0.8) +
    geom_text(aes(y = 0.52, label = redaction)) +
    geom_errorbar(aes(ymin=as.numeric(lowerCI), ymax=as.numeric(upperCI), colour = var_group), width=0) + 
    coord_flip() + facet_grid(group~., scales = "free", space = "free") + 
    theme_bw() + theme(strip.background = element_blank()) + labs(colour = "Group") +
    geom_hline(yintercept=1, linetype="dotted") + 
    ylab("Hazard ratio") + xlab("") +
    scale_colour_manual(values = c("#3B9AB2", "#E1AF00", "#B40F20")) +
    theme(axis.title = element_text(size=12), axis.text = element_text(size=12), strip.text = element_blank(), 
          legend.title = element_text(size = 12), legend.text = element_text(size = 12), legend.position = c(-1.5,0.95))
  
  ## Set axis breaks depending on outcome
  if (dose4==TRUE) { 
      g1 = g1 + scale_y_continuous(trans="log",limits=c(plot_min, plot_max), breaks=c(0.5,1,2,4,8,16)) 
  } else { 
      g1 = g1 + scale_y_continuous(trans="log",limits=c(plot_min, plot_max), breaks=c(0.5,1,2)) 
  }

  if (dose4==TRUE) { plot_min = 0 } else { plot_min = min(input_tbl$`% vaccinated`, na.rm=T)-20 }
  if (dose4==TRUE) { plot_max = max(input_tbl$`% vaccinated`, na.rm=T)+10 } else { plot_max = 100 }
  g2 = ggplot(input_tbl, aes(y = `% vaccinated`, x = level,  colour = var_group)) + 
    geom_point(size = 2, alpha=0.8) +
    geom_segment(aes(xend=level), yend=0) +
    ylim(plot_min,plot_max) + coord_flip() + facet_grid(group~., scales = "free", space = "free") + 
    theme_bw() + theme(strip.background = element_blank()) + 
    ylab("Coverage (%)") + xlab("") +
    scale_colour_manual(values = c("#3B9AB2", "#E1AF00", "#B40F20")) +
    theme(axis.title = element_text(size=12), axis.text.x = element_text(size=12), axis.text.y = element_blank(), strip.text = element_blank(), 
          legend.title = element_text(size = 12), legend.text = element_text(size = 12), legend.position = "none")
  
  plot_grid(g1, g2, ncol=2,  align="h", axis = c("tb"), rel_widths = c(3,0.9))
}
plot_reduced_tbl(dose3_tbl, level="partial")
```
<br/><br/> 

#### Plot of fully adjusted model outputs
```{r, fig.width=8, fig.height=12}
plot_reduced_tbl(dose3_tbl, level="full")
```
<br/><br/> 





##### Approach (2): Logistic regression (sensitivity analysis)
```{r}
data_lr <- read_rds(here::here("output", "data", "data_lr.rds"))
total_vax = plyr::round_any(sum(data_lr$covid_vax),5)
total_N = plyr::round_any(nrow(data_lr),5)
vax_perc = round(total_vax/total_N*100,1)
```

Logistic regression models were used to explore factors associated with completion of a 2-dose series via any product combination by **20 Apr 2022** as a binary outcome variable. Individuals were included if they were registered and alive up to the analysis cut-off (N = `r prettyNum(total_N)`, rounded to nearest 5).    
    
Overall coverage as of **20 Apr 2022** was `r vax_perc`% (`r prettyNum(total_vax)` / `r prettyNum(total_N)`, rounded to nearest 5).    
    
Minimally adjusted, partially adjusted, and fully adjusted models were used to explore the potential influence of each covariate, reflecting the structure of the Cox proportional hazard models but with region as a covariate rather than a stratification factor.
<br/><br/>    

##### Multivariate model outputs (scroll left/right for full table)
```{r}
## Import logistic regression results
tbl_summary <- read_rds(here::here("output", "model", "mod_strat_logistic_redacted.rds"))

## Add % vaccinated at cut-off
tbl_summary$perc_vac <- round((as.numeric(tbl_summary$n_event) / as.numeric(tbl_summary$n_obs))*100,1)

## Select variables of interes
tbl_reduced <- tbl_summary %>%
   select(var_group, var_label, label, n_obs, n_event, perc_vac,
         estimate_partial, conf.low_partial, conf.high_partial, p.value_partial)

## Relabel columns
names(tbl_reduced) = c("var_group", "group", "level", "n (total)", "n (vaccinated)", "% vaccinated",
                            "OR (multi)", "lower CI (multi)", "upper CI (multi)", "p (multi)")

## Create formatted gt output
tbl_reduced %>% 
  gt(rowname_col = "level", groupname_col = "group") %>%
    tab_spanner(
    label = "partially adjusted",
    columns = c("OR (multi)", "lower CI (multi)", "upper CI (multi)", "p (multi)")
  ) %>%
  cols_hide(columns = "var_group") %>%
  tab_options(table.font.size = pct(85)) %>%
   tab_style(
      style = list(
        cell_borders(
          sides = c("right"), color = "#cccccc"
        )
        ),
      locations = list(
        cells_body(
          columns = c("p (multi)", "% vaccinated")
        )
      )
   ) %>%
  tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold") %>%
  tab_footnote(
    footnote = "All counts rounded to nearest 5; data redacted for any rows with rounded values of <=10 for 
            n (vaccinated) or n (unvaccinated), where n (unvaccinated) is the difference between n (total) and n (vaccinated) after rounding.",
    locations = cells_column_labels(columns = "n (vaccinated)")
  ) %>%
  tab_footnote(
    footnote = "Calculated among individuals who were uncensored at cut-off.",
    locations = cells_column_labels(columns = "% vaccinated")
  )
```
<br/><br/>     

#### Plot of partially adjusted model outputs
```{r, fig.width=8, fig.height=12}
## Remove redacted components from plot
tbl_reduced$`OR (multi)`[tbl_reduced$`OR (multi)`=="[Redacted]"] = NA
tbl_reduced$`lower CI (multi)`[tbl_reduced$`OR (multi)`=="[Redacted]"] = NA
tbl_reduced$`upper CI (multi)`[tbl_reduced$`OR (multi)`=="[Redacted]"] = NA

## Recode ORs and CIs as numerics
tbl_reduced$`OR (multi)` = as.numeric(tbl_reduced$`OR (multi)`)
tbl_reduced$`lower CI (multi)` = as.numeric(tbl_reduced$`lower CI (multi)`)
tbl_reduced$`upper CI (multi)` = as.numeric(tbl_reduced$`upper CI (multi)`)

## Set plot min
plot_min = 0.5
if(min(tbl_reduced$`lower CI (multi)`, na.rm=T) < plot_min) { plot_min = min(tbl_reduced$`lower CI (multi)`, na.rm=T) }

## Set plot max
plot_max = 2
if(max(tbl_reduced$`upper CI (multi)`, na.rm=T) > plot_max) { plot_max = max(tbl_reduced$`upper CI (multi)`, na.rm=T) }

## Add redaction text variable
tbl_reduced$redaction = NA
tbl_reduced$redaction[tbl_reduced$`n (total)`=="[Redacted]"] = "[R]"

## Generate plot of HRs
g1 = ggplot(tbl_reduced, aes(y = `OR (multi)`, x = level, colour = var_group)) + 
  geom_point(size = 2, alpha=0.8) +
  geom_text(aes(y = plot_min+0.02, label = redaction)) +
  geom_errorbar(aes(ymin=as.numeric(`lower CI (multi)`), ymax=as.numeric(`upper CI (multi)`), colour = var_group), width=0) + 
  coord_flip() + facet_grid(group~., scales = "free", space = "free") + 
  theme_bw() + theme(strip.background = element_blank()) + labs(colour = "Group") +
  geom_hline(yintercept=1, linetype="dotted") + 
  ylab("Odds ratio") + xlab("") +
  scale_colour_manual(values = c("#3B9AB2", "#E1AF00", "#B40F20")) +
  scale_y_continuous(trans="log",limits=c(plot_min, plot_max), breaks=c(0.5,1,2)) +
  theme(axis.title = element_text(size=12), axis.text = element_text(size=12), strip.text = element_blank(), 
        legend.title = element_text(size = 12), legend.text = element_text(size = 12), legend.position = c(-1.5,0.95))

plot_min = min(tbl_reduced$`% vaccinated`, na.rm=T)-20
g2 = ggplot(tbl_reduced, aes(y = `% vaccinated`, x = level,  colour = var_group)) + 
  geom_point(size = 2, alpha=0.8) +
  geom_segment(aes(xend=level), yend=0) +
  ylim(plot_min,100) + coord_flip() + facet_grid(group~., scales = "free", space = "free") + 
  theme_bw() + theme(strip.background = element_blank()) + 
  ylab("Coverage (%)") + xlab("") +
  scale_colour_manual(values = c("#3B9AB2", "#E1AF00", "#B40F20")) +
  theme(axis.title = element_text(size=12), axis.text.x = element_text(size=12), axis.text.y = element_blank(), strip.text = element_blank(), 
        legend.title = element_text(size = 12), legend.text = element_text(size = 12), legend.position = "none")

plot_grid(g1, g2, ncol=2,  align="h", axis = c("tb"), rel_widths = c(3,0.9))
```
<br/><br/><br/><br/>





#### Covariates associated with vaccine coverage: dose 4 by 20 Apr 2022 (full cohort)

##### Cox proportional hazards
```{r}
data_cox <- read_rds(here::here("output", "data", "data_cox_coverage_dose4.rds"))

## Censored populations
total_vax = plyr::round_any(sum(data_cox$covid_vax),5)
total_N = plyr::round_any(nrow(data_cox),5)
vax_perc = round(total_vax/total_N*100,1)

## Uncensored population totals
total_vax_uncensored = plyr::round_any(sum(data_cox$uncensored_at_cut_off==1 & data_cox$unvax_uncensored_at_cut_off==0),5)
total_N_uncensored = plyr::round_any(sum(data_cox$uncensored_at_cut_off),5)
vax_perc_uncensored = round(total_vax_uncensored/total_N_uncensored*100,1)
```

Follow-up was censored on the date of death, deregistration, or the end of the study period (20-Apr-2022). Overall coverage among individuals uncensored on 20-Apr-2022 was `r vax_perc_uncensored`% (`r prettyNum(total_vax_uncensored)` / `r prettyNum(total_N_uncensored)`, rounded to nearest 5). 
<br/><br/>

##### Multivariate model outputs (scroll left/right for full table)
```{r}
dose4_tbl <- read_rds(here::here("output", "model", paste0("mod_strat_coxph_redacted_dose4_full.rds"))) %>%
  create_reduced_tbl()
tabulate_reduced_tbl(dose4_tbl)
```
<br/><br/>    

#### Plot of partially adjusted model outputs
```{r, fig.width=8, fig.height=12}
plot_reduced_tbl(dose4_tbl, dose4=TRUE, level="partial")
```
<br/><br/><br/><br/>







#### Subgroup analyses

##### Dose 3 summary
```{r}
## Function to create clean table of dose-specific cox subgroup outputs
create_reduced_tbl_subgroup = function(selected_dose=c("dose3", "dose4")) {
  # Example: selected_dose = "dose2"
  
  # Define strata
  subgroups = c("CKD3a", "CKD3b", "CKD4-5", "RRT (dialysis)", "RRT (Tx)")
  
  ## Import cox regression results for subgroup analyses
  for (i in 1:length(subgroups)) {
    tbl_subset <- read_rds(here::here("output", "model", paste0("mod_strat_coxph_redacted_",selected_dose,"_",subgroups[i],".rds")))
    tbl_subset$subgroup = subgroups[i]
    tbl_subset$subgroup_id = i
    if (i == 1) { tbl_summary = tbl_subset } else { tbl_summary = rbind(tbl_summary, tbl_subset) }
  }

  ## Add % vaccinated at cut-off
  tbl_summary$perc_vac <- 100 - round(as.numeric(tbl_summary$n_unvax_at_cut_off)/as.numeric(tbl_summary$n_uncensored_at_cut_off)*100,1)
  return(tbl_summary)
}

## Function to create formatted gt output
tabulate_reduced_tbl_subgroup = function(input_tbl, selected_dose=c("dose3", "dose4")) { 
  # Example: input_tbl = tbl_summary

  ## Select variables of interes
  tbl_reduced <- input_tbl %>%
    mutate(
      # Collate summary outputs
      HR_summary_partial = paste0(estimate_partial," (", conf.low,"-",conf.high,")"),

      # Clean summary outputs
      HR_summary_partial = ifelse(HR_summary_partial=="[Redacted] ([Redacted]-[Redacted])", "[Redacted]", HR_summary_partial),
      HR_summary_partial = ifelse(HR_summary_partial=="1 (NA-NA)", "1", HR_summary_partial),
    ) %>%
    select(subgroup, subgroup_id, var_group, var_label, label, n_obs, n_uncensored_at_cut_off, perc_vac, HR_summary_partial)
  
  ## Relabel columns
  names(tbl_reduced) = c("subgroup", "subgroup_id", "var_group", "group", "level", "n (total)", "n (uncen)", "% vax", "HR partial")

  ## Pivot to wide format based on subgroup
  tbl_wide = tbl_reduced %>% 
    pivot_wider(    
      names_from = c(subgroup, subgroup_id),
      values_from = c(`n (total)`, `n (uncen)`, `% vax`, `HR partial`),
      names_glue = "{.value} [{subgroup_id}]"
    ) 
  
  ## Generate table
  tbl_wide = tbl_wide %>%
    gt(rowname_col = "level", groupname_col = "group") %>%
    tab_spanner(
      label = "CKD3a",
      columns = paste0(c("n (total)", "n (uncen)", "% vax", "HR partial")," [1]")
    )  %>%
    tab_spanner(
      label = "CKD3b",
      columns = paste0(c("n (total)", "n (uncen)", "% vax", "HR partial")," [2]")
    )  %>%
    tab_spanner(
      label = "CKD4-5",
      columns = paste0(c("n (total)", "n (uncen)", "% vax", "HR partial")," [3]")
    )  %>%
    tab_spanner(
      label = "RRT (dialysis)",
      columns = paste0(c("n (total)", "n (uncen)", "% vax", "HR partial")," [4]")
    )  %>%
    tab_spanner(
      label = "RRT (Tx)",
      columns = paste0(c("n (total)", "n (uncen)", "% vax", "HR partial")," [5]")
    ) %>%
    cols_hide(columns = "var_group") %>%
    tab_options(table.font.size = pct(70)) %>%
     tab_style(
        style = list(
          cell_borders(
            sides = c("right"), color = "#cccccc"
          )
          ),
        locations = list(
          cells_body(
            columns = starts_with("HR partial")
          )
        )
     ) %>%
    tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold")

  return(tbl_wide)
}

## Create table for dose 3 data
dose3_tbl_subgroup = create_reduced_tbl_subgroup("dose3")
tabulate_reduced_tbl_subgroup(dose3_tbl_subgroup, "dose3")
```
<br/>All counts rounded to nearest 5; data redacted for any rows with rounded values of <=10 for n (vaccinated) or n (unvaccinated), where n (unvaccinated) is the difference between n (total) and n (vaccinated) after rounding. % unvaccinated calculated among individuals who were uncensored at cut-off.
<br/><br/>

##### Dose 3 plot
```{r, fig.width=13, fig.height=10}
## Function to create plot of cox subgroup outputs 
plot_reduced_tbl_subgroup = function(input_tbl, dose4=FALSE) {
  ## Remove redacted components from plot
  input_tbl$estimate_partial[input_tbl$estimate_partial=="[Redacted]"] = NA
  input_tbl$conf.low_partial[input_tbl$conf.low_partial=="[Redacted]"] = NA
  input_tbl$conf.high_partial[input_tbl$conf.high_partial=="[Redacted]"] = NA
  
  ## Recode HRs and CIs as numerics
  input_tbl$estimate_partial = as.numeric(input_tbl$estimate_partial)
  input_tbl$conf.low_partial = as.numeric(input_tbl$conf.low_partial)
  input_tbl$conf.high_partial = as.numeric(input_tbl$conf.high_partial)
  
  ## Set CKD factor levels
  input_tbl$subgroup = factor(input_tbl$subgroup, level = c("CKD3a", "CKD3b", "CKD4-5", "RRT (dialysis)", "RRT (Tx)"))
  
  ## Set plot min
  plot_min = 0.5
  if(min(input_tbl$conf.low_partial, na.rm=T) < plot_min) { plot_min = min(input_tbl$conf.low_partial, na.rm=T) }
  
  ## Set plot max
  plot_max = 2
  if(max(input_tbl$conf.high_partial, na.rm=T) > plot_max) { plot_max = max(input_tbl$conf.high_partial, na.rm=T) }
  
  ## Add redaction text variable
  input_tbl$redaction = NA
  input_tbl$redaction[input_tbl$n_obs=="[Redacted]"] = "[R]"

  ## Generate plot of HRs
  g1 = ggplot(input_tbl, aes(y = estimate_partial, x = label, colour = var_group)) + 
    geom_point(size = 2, alpha=0.8) +
    geom_text(aes(y = plot_min+0.02, label = redaction)) +
    geom_errorbar(aes(ymin=as.numeric(conf.low_partial), ymax=as.numeric(conf.high_partial), colour = var_group), width=0) + 
    coord_flip() + facet_grid(var_label~subgroup, scales = "free", space = "free") + 
    theme_bw() + theme(strip.background = element_blank()) + labs(colour = "Group") +
    geom_hline(yintercept=1, linetype="dotted") + 
    ylab("Hazard ratio") + xlab("") +
    scale_colour_manual(values = c("#3B9AB2", "#E1AF00", "#B40F20")) +
    theme(axis.title = element_text(size=12), axis.text = element_text(size=12), strip.text.y = element_blank(), strip.text.x = element_text(size=12), 
          legend.title = element_text(size = 12), legend.text = element_text(size = 12), legend.position = c(-1.5,0.95))
  
  ## Set axis breaks depending on outcome
  if (dose4==TRUE) { 
      g1 = g1 + scale_y_continuous(trans="log",limits=c(plot_min, plot_max), breaks=c(0.5,1,2,4,8,16)) 
  } else { 
      g1 = g1 + scale_y_continuous(trans="log",limits=c(plot_min, plot_max), breaks=c(0.5,1,2)) 
  }
  g1
}
plot_reduced_tbl_subgroup(dose3_tbl_subgroup, dose4=FALSE)
```
<br/><br/><br/><br/>  





##### Dose 4 summary (full cohort)
```{r}
tbl_subgroup = create_reduced_tbl_subgroup("dose4")
tabulate_reduced_tbl_subgroup(tbl_subgroup, "dose4")
```
<br/>All counts rounded to nearest 5; data redacted for any rows with rounded values of <=10 for n (total), n (vaccinated), or n (unvaccinated), where n (unvaccinated) is the difference between n (total) and n (vaccinated) after rounding. % unvaccinated calculated among individuals who were uncensored at cut-off.
<br/><br/>  

##### Dose 4 plot (full cohort)
```{r, fig.width=13, fig.height=10}
plot_reduced_tbl_subgroup(tbl_subgroup, dose4=TRUE)
```
<br/><br/><br/><br/>  




##### Session info
```{r}
print(sessionInfo())
```

