---
title: "Factors associated with COVID-19 vaccine coverage in people with kidney disease in England: an OpenSAFELY cohort study"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

## Import libraries
library('here')
library('tidyverse')
library('readr')
library('tidyr')
library('lubridate')
library('glue')
library('gt')
library('gtsummary')
library('reshape2')
library('kableExtra')
library('cowplot')
library('fs')
library('survival')
library('survminer')

# Define analysis cut-off date
end_date <- as_date("2022-05-11")

## Import custom user functions
source(here::here("analysis", "functions.R"))

## Import data
data_cohort <- read_rds(here::here("output", "data", "data_cohort_coverage.rds"))
data_uncensored <- read_rds(here::here("output", "data", "data_cohort_coverage_logistic.rds"))
data_dose4 <- read_rds(here::here("output", "data", "data_cohort_coverage_dose4.rds"))
data_dose4_uncensored <- subset(data_dose4, is.na(death_date) & is.na(dereg_date))

## Calculate rounded population totals
rounded_n = plyr::round_any(nrow(data_cohort), 5)
rounded_n_uncensored = plyr::round_any(nrow(data_uncensored), 5)
rounded_n_dose4 = plyr::round_any(nrow(data_dose4), 5)
rounded_n_dose4_uncensored = plyr::round_any(nrow(data_dose4_uncensored), 5)
```
<br/><br/>  

#### Background
Kidney disease is a significant risk factor for COVID-19-related mortality. Although vaccination has the potential to mitigate this risk, chronic kidney disease (CKD) and kidney failure requiring renal replacement therapy (RRT) have been linked with impaired COVID-19 vaccine immunogenicity and high rates of breakthrough infection among individuals who have received a 2-dose primary vaccine series.

Vaccine recommendations for people with kidney disease in the UK have evolved over time (see [protocol](https://docs.google.com/document/d/1w48W-bCMfn0RdkfxlU6fbRkPv3MnIYd3/edit#heading=h.1fob9te). Relative uptake of different vaccines in this population remains uncertain, as does the relative vaccine effectiveness (VE) of different regimens. This project seeks to address these key evidence gaps.
<br/><br/>

#### Inclusion criteria
* Registered for at least 3m before index date (01-Dec-2020)    
* Alive on index date    
* Aged ≥16 on index date
* eGFR<60 in 2 years before 01-Dec-2020 OR present in UK renal registry on 31-Dec-2020   
* No missing demographic data   
* Maximum of 5 COVID-19 doses recorded
* No dose intervals of <14 days across first 4 doses

A total of **`r prettyNum(rounded_n)`** (rounded to the nearest 5) met the inclusion criteria (see *output/data/flowchart.csv* for additional details), of which **`r prettyNum(rounded_n_uncensored)`** remained uncensored (alive and registered) throughout follow-up (01-Dec-2020 to 11-May-2022).

Of the total population, **`r prettyNum(rounded_n_dose4)`** were >=75 years or had a history of immunosuppression, haematologic cancer, or transplant on the index date. This population includes individuals eligible for an extended primary series or second booster dose, and was therefore included in the dose 4 analysis subset. **`r prettyNum(rounded_n_dose4_uncensored)`** of the dose 4 analysis subset remained uncensored (alive and registered) throughout follow-up (01-Dec-2020 to 11-May-2022).
<br/><br/>  

#### Cohort selection
```{r}
flowchart <- read.csv(here::here("output", "tables", "flowchart_coverage.csv"))
names(flowchart)[1] = "Criteria"

# Correct wording relating to analysis cut-off
flowchart$Criteria = str_replace(flowchart$Criteria, "20 April 2022", "analysis cut-off")

# Render flowchart
flowchart %>%
  mutate(`N (rounded)` = prettyNum(plyr::round_any(flowchart$n, 5), big.mark=",")) %>%
  select(Criteria, `N (rounded)`) %>%
  gt() %>%
  tab_options(table.font.size = pct(95), column_labels.font.weigh="bold")
```
<br/><br/>

#### Table 1: Summary of primary outcome population
```{r}
table_1 <- read_rds(here::here("output", "tables", "table1_coverage_redacted_by_CKD.rds")) %>%
  filter(Group != "JCVI group" & Group != "Kidney disease subgroup")

## Calculate breakdown of CKD4-5 
ckd4_5_sum = plyr::round_any(sum(data_cohort$ckd_6cat=="CKD4" | data_cohort$ckd_6cat=="CKD5"),5)
ckd4_sum = plyr::round_any(sum(data_cohort$ckd_6cat=="CKD4"),5)
ckd5_sum = plyr::round_any(sum(data_cohort$ckd_6cat=="CKD5"),5)

## Render table
table_1 %>% 
   gt(groupname_col = "Group") %>%
   tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold") %>%
   tab_style(
     style = cell_text(indent = pct(5)),
     locations = cells_body(columns = "Variable")
     ) %>%
   tab_options(table.font.size = pct(95))
```
<br/>
Data are n (%) after rounding to the nearest 5. Any cells with rounded counts or non-counts (relative to the denominator) of >0 and <=10 are redacted. Primary care codes and risk groups are coded by separate binary variables; percentages in these subheadings therefore do not sum to 100. Among people with CKD4–5, `r prettyNum(ckd4_sum)` had stage 4 CKD (eGFR 15–29 ml/min/1.73 m2) and `r prettyNum(ckd5_sum)` had stage 5 CKD (eGFR <15ml/min/1.73 m2). Prior SARS-CoV-2 was determined based on evidence of a positive SARS-CoV-2 test, COVID-19-related primary care code, or COVID-19-related hospitalisation as of 1st December 2020. Clinically extremely vulnerable (other) was determined based on the presence of shielding primary care codes in the absence of any of the comorbidities listed above (including RRT). CKD, chronic kidney disease; CND, chronic neurological disease; RRT, renal replacement therapy. 
<br/><br/>

#### Supplementary table: Summary of population for subset eligible for dose 4
```{r}
table_1 <- read_rds(here::here("output", "tables", "table1_coverage_redacted_by_CKD_dose4.rds")) %>%
  filter(Group != "JCVI group" & Group != "Kidney disease subgroup")

## Calculate breakdown of CKD4-5 
ckd4_5_sum = plyr::round_any(sum(data_dose4$ckd_6cat=="CKD4" | data_dose4$ckd_6cat=="CKD5"),5)
ckd4_sum = plyr::round_any(sum(data_dose4$ckd_6cat=="CKD4"),5)
ckd5_sum = plyr::round_any(sum(data_dose4$ckd_6cat=="CKD5"),5)

## Render table
table_1 %>% 
   gt(groupname_col = "Group") %>%
   tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold") %>%
   tab_style(
     style = cell_text(indent = pct(5)),
     locations = cells_body(columns = "Variable")
     ) %>%
   tab_options(table.font.size = pct(95))
```
<br/>
See footnotes above. Among people with CKD4–5, `r prettyNum(ckd4_sum)` had stage 4 CKD (eGFR 15–29 ml/min/1.73 m2) and `r prettyNum(ckd5_sum)` had stage 5 CKD (eGFR <15ml/min/1.73 m2).
<br/><br/>

#### Coverage as of 11-May-2022
```{r}
#### Generate Kaplan-Meier tte data for each dose
data_km <- data_cohort %>%
  mutate(
    # Start date
    start_date = as.Date("2020-12-01", format = "%Y-%m-%d"),
    
    # End date
    end_date = as.Date("2022-05-11", format = "%Y-%m-%d"),
    
    # Censoring
    censor_date = pmin(death_date, 
                       dereg_date, 
                       end_date, 
                       na.rm=TRUE),
    
    # Follow-up time
    follow_up_time_dose1 = tte(start_date, vax1_date, censor_date),
    follow_up_time_dose2 = tte(start_date, vax2_date, censor_date),
    follow_up_time_dose3 = tte(start_date, vax3_date, censor_date),
    follow_up_time_dose4 = tte(start_date, vax4_date, censor_date),
    follow_up_time_dose5 = tte(start_date, vax5_date, censor_date),

    # COVID vaccination: 1 if vaccinated before end date, 0 otherwise
    covid_vax_dose1 = dplyr::if_else((vax1_date>censor_date) | is.na(vax1_date), 0, 1),
    covid_vax_dose2 = dplyr::if_else((vax2_date>censor_date) | is.na(vax2_date), 0, 1),
    covid_vax_dose3 = dplyr::if_else((vax3_date>censor_date) | is.na(vax3_date), 0, 1),
    covid_vax_dose4 = dplyr::if_else((vax4_date>censor_date) | is.na(vax4_date), 0, 1),
    covid_vax_dose5 = dplyr::if_else((vax5_date>censor_date) | is.na(vax5_date), 0, 1)
)

#### Generate Kaplan-Meier tte data for dose 4 subset
data_km_dose4 <- data_dose4 %>%
  mutate(
    start_date = as.Date("2020-12-01", format = "%Y-%m-%d"),
    end_date = as.Date("2022-05-11", format = "%Y-%m-%d"),
    censor_date = pmin(death_date, 
                       dereg_date, 
                       end_date, 
                       na.rm=TRUE),
    follow_up_time_dose4 = tte(start_date, vax4_date, censor_date),
    follow_up_time_dose5 = tte(start_date, vax5_date, censor_date),
    covid_vax_dose4 = dplyr::if_else((vax4_date>censor_date) | is.na(vax4_date), 0, 1),
    covid_vax_dose5 = dplyr::if_else((vax5_date>censor_date) | is.na(vax5_date), 0, 1)
)

## Function to generate rounded survival table (steps delayed to include at least 10 events)
surv_table = function(dose, dosenum, doselabel, data_input, threshold=10) {
  surv = survfit(as.formula(paste0("Surv(follow_up_time_",dose,", covid_vax_",dose,") ~ 1")), data = data_input) %>% 
    broom::tidy() %>% 
    filter(estimate > 0) %>%
    mutate(
      N = plyr::round_any(max(n.risk, na.rm=TRUE),threshold),
      cml.event = cumsum(replace_na(n.event, 0)),
      cml.censor = cumsum(replace_na(n.censor, 0)),
      cml.event.floor = floor_any(cml.event, threshold),
      cml.censor.floor = floor_any(cml.censor, threshold),
      n.event.floor = diff(c(0,cml.event.floor)),
      n.censor.floor = diff(c(0,cml.censor.floor)),
      n.risk.floor = N - lag(cml.event.floor + cml.censor.floor,1,0),
      surv.floor = cumprod(1 - n.event.floor / n.risk.floor),
      cum.in.floor = 1 - surv.floor,
      date = as.Date("2020-12-01", format = "%Y-%m-%d")+time,
      dose = doselabel, 
    ) %>%
    select(time, n.risk.floor, n.censor.floor, cum.in.floor, dose, date) %>%
    filter(time>=0)
}

## Collate KM estimates
km_collated = rbind(
  surv_table("dose1", 1, "1", data_km),
  surv_table("dose2", 2, "2",  data_km),
  surv_table("dose3", 3, "3", data_km),
  surv_table("dose4", 4, "4 (full)", data_km),
  surv_table("dose5", 5, "5 (full)", data_km),
  surv_table("dose4", 4, "4 (subset)", data_km_dose4),
  surv_table("dose5", 5, "5 (subset)", data_km_dose4)
)

## Calculate coverage in total and uncensored populations
collated = data.frame(
  Dose = c("1", "2", "3", "4 (full)", "5 (full)", "4 (subset)", "5 (subset)"),
  N_cohort_total = c(rep(rounded_n, 5), rep(rounded_n_dose4,2)),
  N_vaccinated_total = c(sum(data_km$covid_vax_dose1==1), sum(data_km$covid_vax_dose2==1), 
                         sum(data_km$covid_vax_dose3==1), sum(data_km$covid_vax_dose4==1),
                         sum(data_km$covid_vax_dose5==1),
                         sum(data_km_dose4$covid_vax_dose4==1), sum(data_km_dose4$covid_vax_dose5==1))
  ) %>%
  mutate(
    N_vaccinated_total = plyr::round_any(N_vaccinated_total, 5),
    coverage_total = round(N_vaccinated_total/N_cohort_total*100,1),
    N_cohort_uncensored = c(rep(rounded_n_uncensored, 5), rep(rounded_n_dose4_uncensored,2)),
    N_vaccinated_uncensored = c(sum(data_uncensored$vax1_date<=end_date, na.rm=T), sum(data_uncensored$vax2_date<=end_date, na.rm=T), 
                                sum(data_uncensored$vax3_date<=end_date, na.rm=T), sum(data_uncensored$vax4_date<=end_date, na.rm=T),
                                sum(data_uncensored$vax5_date<=end_date, na.rm=T),
                                sum(data_dose4_uncensored$vax4_date<=end_date, na.rm=T),  sum(data_dose4_uncensored$vax5_date<=end_date, na.rm=T)),
    N_vaccinated_uncensored = plyr::round_any(N_vaccinated_uncensored, 5),
    coverage_uncensored = round(N_vaccinated_uncensored/N_cohort_uncensored*100,1)
  )
names(collated) = c("Dose", "N (total)", "n vaccinated (total)", "Coverage (total), %",
                            "N (uncensored)", "n vaccinated (uncensored)", "Coverage (uncensored), %")

collated$`Cumulative (KM), %` = c(round(max(subset(km_collated, dose=="1")$cum.in.floor)*100,1),
                      round(max(subset(km_collated, dose=="2")$cum.in.floor)*100,1),
                      round(max(subset(km_collated, dose=="3")$cum.in.floor)*100,1),
                      round(max(subset(km_collated, dose=="4 (full)")$cum.in.floor)*100,1),
                      round(max(subset(km_collated, dose=="5 (full)")$cum.in.floor)*100,1),
                      round(max(subset(km_collated, dose=="4 (subset)")$cum.in.floor)*100,1),
                      round(max(subset(km_collated, dose=="5 (subset)")$cum.in.floor)*100,1)
                      )

## Generate table
gt(collated) %>%
   tab_spanner(
    label = "Total",
    columns = c("N (total)", "n vaccinated (total)", "Coverage (total), %")
  ) %>%
    tab_spanner(
    label = "Uncensored",
    columns = c("N (uncensored)", "n vaccinated (uncensored)", "Coverage (uncensored), %")
  ) %>%
    tab_spanner(
    label = "KM",
    columns = c("Cumulative (KM), %")
  ) %>%
  tab_options(table.font.size = pct(95))
```
<br/><br/>

#### Subgroup coverage as of 11-May-2022 (cumulative incidence based on Kaplan-Meier estimates)
```{r}
## Function to extract subgroup-specific Kaplan-Meier estimates
extract_subset_max = function(selected_subset) {
  data.frame(
    cov = c(
        round(max(surv_table("dose1", 1, "1", subset(data_km, ckd_5cat==selected_subset))$cum.in.floor)*100,1),
        round(max(surv_table("dose2", 2, "2", subset(data_km, ckd_5cat==selected_subset))$cum.in.floor)*100,1),
        round(max(surv_table("dose3", 3, "3", subset(data_km, ckd_5cat==selected_subset))$cum.in.floor)*100,1),
        round(max(surv_table("dose4", 4, "4 (full)", subset(data_km, ckd_5cat==selected_subset))$cum.in.floor)*100,1),
        round(max(surv_table("dose5", 5, "5 (full)", subset(data_km, ckd_5cat==selected_subset))$cum.in.floor)*100,1),
        round(max(surv_table("dose4", 4, "4 (subset)", subset(data_km_dose4, ckd_5cat==selected_subset))$cum.in.floor)*100,1),
        round(max(surv_table("dose5", 5, "5 (subset)", subset(data_km_dose4, ckd_5cat==selected_subset))$cum.in.floor)*100,1)
        )
  )
}

## Collate estimates
collated_cov = cbind(
  Dose = c("1", "2", "3", "4 (full)", "5 (full)", "4 (subset)", "5 (subset)"),
  extract_subset_max("CKD3a"),
  extract_subset_max("CKD3b"),
  extract_subset_max("CKD4-5"),
  extract_subset_max("RRT (dialysis)"),
  extract_subset_max("RRT (Tx)")
)
names(collated_cov) = c("Dose", "CKD3a", "CKD3b", "CKD4-5", "RRT (dialysis)", "RRT (Tx)")

## Render table
collated_cov %>% gt() %>%
  tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold") %>%
  tab_options(table.font.size = pct(95))
```
<br/><br/>

#### Product profile by dose
```{r}
## Dose 1
t_dose_dose1 = data.frame(table(data_cohort$vax1_type_descr)) %>% 
  redact_table(multiple=FALSE) %>%
  mutate(`Dose 1` = paste0(prettyNum(Frequency,  big.mark=",")," (",Percent,"%)"))

## Dose 2
t_dose_dose2 = data.frame(table(data_cohort$vax2_type_descr)) %>% 
  redact_table(multiple=FALSE) %>%
  mutate(`Dose 2` = paste0(prettyNum(Frequency,  big.mark=",")," (",Percent,"%)")) 

## Dose 3
t_dose_dose3 = data.frame(table(data_cohort$vax3_type_descr)) %>% 
  redact_table(multiple=FALSE) %>%
  mutate(`Dose 3` = paste0(prettyNum(Frequency,  big.mark=",")," (",Percent,"%)")) 

## Dose 4
t_dose_dose4 = data.frame(table(data_cohort$vax4_type_descr)) %>% 
  redact_table(multiple=FALSE) %>%
  mutate(`Dose 4` = paste0(prettyNum(Frequency,  big.mark=",")," (",Percent,"%)"))

## Dose 5
# t_dose_dose5 = data.frame(table(data_cohort$vax5_type_descr)) %>% 
#   redact_table(multiple=FALSE) %>%
#   mutate(`Dose 5` = paste0(prettyNum(Frequency,  big.mark=",")," (",Percent,"%)"))

# Render combined table
left_join(t_dose_dose1, t_dose_dose2, by = "Combination") %>%
  left_join(.,  t_dose_dose3, by = "Combination") %>%
  left_join(.,  t_dose_dose4, by = "Combination") %>%
  # left_join(.,  t_dose_dose5, by = "Combination") %>%
  select(-starts_with(c("Frequency", "Percent"))) %>%
  mutate(Combination = str_replace_all(Combination, c("ChAdOx1" = "AZ", "BNT162b2" = "BNT", "Moderna" = "MOD"))) %>%
  gt() %>%
  tab_options(column_labels.font.weigh="bold") %>%
  tab_options(table.font.size = pct(95))
```
<br/><br/>  

#### Product combinations across doses
```{r}
## Dose 1-2
t_dose_dose12 = data.frame(table(data_cohort$vax12_type)) %>% 
  redact_table() %>%
  mutate(Group = "2-dose combination") %>%
  arrange(desc(Frequency))

## Dose 1-2-3
t_dose_dose123 = data.frame(table(data_cohort$vax123_type)) %>% 
  redact_table() %>%
  mutate(Group = "3-dose combination") %>%
  arrange(desc(as.numeric(Frequency)))

# Generate combined table
rbind(t_dose_dose12, t_dose_dose123) %>% 
  mutate(
    `N (%)` = paste0(prettyNum(Frequency,  big.mark=",")," (",Percent,"%)"),
    Combination = str_replace_all(Combination, c("az" = "AZ", "pfizer" = "BNT", "moderna" = "MOD")),
    ) %>%
  select(-Frequency,-Percent) %>%
  gt(groupname_col = "Group") %>%
  tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold") %>%
  tab_options(table.font.size = pct(95))
```
<br/>
Data are n (%) after rounding to the nearest 5. Any product combinations given to <1000 individuals are grouped as 'Other'. Any cells with rounded counts or non-counts (relative to the denominator) of >0 and <=10 are redacted.
<br/><br/>  

#### Figure 1: Coverage over time and product profile by dose
```{r, fig.width=9, fig.height=3}
## Coverage plot
palette = c("#053061","#2166ac","#d6604d","#b2182b","#67001f")

## Create simplified dose variable for plotting
km_collated$dose_plot = km_collated$dose
km_collated$dose_plot[km_collated$dose %in% c("4 (full)", "4 (subset)")] = "4"
km_collated$dose_plot[km_collated$dose %in% c("5 (full)", "5 (subset)")] = "5"

## Create variable for full vs subset
km_collated$Population = "Full"
km_collated$Population[km_collated$dose %in% c("4 (subset)", "5 (subset)")] = "Subset"

## Generate plot
km_plot = ggplot(subset(km_collated, dose!="5 (subset)"), aes(x = date, y = cum.in.floor*100, colour = factor(dose_plot))) + geom_line(aes(linetype=Population)) +
          theme_bw()+ scale_colour_manual(values = palette[c(1,2,3,4,5)]) +
          theme(legend.position="right") + scale_x_date(date_labels = "%b %Y") +
          ylim(0,100) + xlab("Date") + ylab("Cumulative coverage (%)") + labs(colour="Dose") +
          theme(legend.title = element_text(size=14), legend.text = element_text(size=12), 
              axis.text = element_text(size=14), axis.title = element_text(size=14))

### Product profile plot
palette = c("#8da0cb","#fc8d62","#66c2a5","grey")

## Collate dose-specific 
collated = rbind(t_dose_dose1 %>% select(-`Dose 1`) %>% mutate(dose = 1), 
                 t_dose_dose2 %>% select(-`Dose 2`) %>% mutate(dose = 2), 
                 t_dose_dose3 %>% select(-`Dose 3`) %>% mutate(dose = 3), 
                 t_dose_dose4 %>% select(-`Dose 4`) %>% mutate(dose = 4)) %>%
      mutate(Combination = str_replace_all(Combination, c("Moderna" = "mRNA-1273", "ChAdOx1" = "ChAdOx1-S")))
collated$vaccine = factor(collated$Combination, levels = c("mRNA-1273", "ChAdOx1-S", "BNT162b2"))

## Generate plot
profile_plot = ggplot(collated, aes(fill=vaccine, y=as.numeric(Frequency)/1000, x=dose)) + 
    geom_bar(position="stack", stat="identity") +
    theme_bw() + ylab("N doses (thousands)") + scale_fill_manual(values = palette[c(2,1,3)]) +
    theme(legend.position="right") + xlab("Dose") + labs(fill="Vaccine") +
    theme(legend.title = element_text(size=14), legend.text = element_text(size=12), 
        axis.text = element_text(size=14), axis.title = element_text(size=14))

## Render combined plot
plot_grid(km_plot, profile_plot, 
          ncol=2,  align="h", axis = c("tb"), rel_widths=c(1.5,1))
```
<br/>Kaplan-Meier steps are delayed until at least 10 events have occurred. Subset = subset of overall cohort based on fourth dose eligibility, including individuals aged >=75 years at baseline, care home residents, transplant recipients (kidney/other), individuals with any history of haematologic cancer, and individuals with any history of immunosuppression.
<br/><br/>





#### Covariates associated with vaccine coverage: dose 3 by 11 May 2022
```{r}
data_cox <- read_rds(here::here("output", "data", "data_cox_coverage_dose3.rds"))

## Censored populations
total_vax = plyr::round_any(sum(data_cox$covid_vax),5)
total_N = plyr::round_any(nrow(data_cox),5)
vax_perc = round(total_vax/total_N*100,1)

## Uncensored population totals
total_vax_uncensored = plyr::round_any(sum(data_cox$uncensored_at_cut_off==1 & data_cox$vax_uncensored_at_cut_off==1),5)
total_N_uncensored = plyr::round_any(sum(data_cox$uncensored_at_cut_off),5)
vax_perc_uncensored = round(total_vax_uncensored/total_N_uncensored*100,1)

## Logistic regression population
data_lr <- read_rds(here::here("output", "data", "data_lr.rds"))
total_vax_lr = plyr::round_any(sum(data_lr$covid_vax),5)
total_N_lr = plyr::round_any(nrow(data_lr),5)
vax_perc_lr = round(total_vax/total_N*100,1)
```

Cox proportional hazards models were used to explore factors associated with completion of a 3-dose series via any product combination between **08-Dec-2020** and **11-May-2022**.  
    
Follow-up was censored on the date of death, deregistration, or the end of the study period (11-May-2022). Overall coverage among individuals uncensored on 11-May-2022 was `r vax_perc_uncensored`% (`r prettyNum(total_vax_uncensored)` / `r prettyNum(total_N_uncensored)`, rounded to nearest 5).
<br/><br/>
   
##### Sequential adjustment model structure 
* Minimally adjusted models stratified by region included the following covariates: age (5-cat), care home residence (1/0), healthcare worker status (1/0).    
* Partially adjusted models stratified by region included the following covariates: age (5-cat), care home residence (1/0), healthcare worker status (1/0), end of life care (1/0), rural/urband setting (3-cat), sex (M/F), ethnicity (6-cat), IMD (5-cat), prior SARS-CoV-2 at baseline (1/0), haematologic cancer (1/0), and immunosuppression (1/0).
* Fully adjusted models stratified by region included all covariates.
<br/><br/>

#### Sensitivity analysis
Logistic regression models were used as a sensitivity analysis to explore factors associated with completion of a 3-dose among individuals who were registered and alive up to the analysis cut-off (N = `r prettyNum(total_N_lr)`, rounded to nearest 5).    
<br/><br/>
Overall coverage as of **11 May 2022** was `r vax_perc_lr`% (`r prettyNum(total_vax_lr)` / `r prettyNum(total_N_lr)`, rounded to nearest 5).  
<br/><br/>
Minimally adjusted, partially adjusted, and fully adjusted models were used to explore the potential influence of each covariate, reflecting the structure of the Cox proportional hazard models but with region as an additional covariate (not shown) rather than a stratification factor.
<br/><br/>    

##### Multivariate model outputs (scroll left/right for full table)
```{r}
## Import and format dose 3 results
dose3_tbl <- read_rds(here::here("output", "model", paste0("mod_strat_coxph_redacted_dose3_full.rds"))) 

dose3_tbl_formatted <- dose3_tbl %>% 
    mutate(
      Variable = label_clean,
      `N (events)`= paste0(prettyNum(n_obs, big.mark = ",")," (",prettyNum(n_event, big.mark = ","),")"),
      `Coverage (%)` = format(km_coverage, nsmall=1),
      `HR (95% CI), minimally adjusted` = paste0(format(estimate_minimal,nsmall=2),
             " (",format(conf.low_minimal,nsmall=2),"-",format(conf.high_minimal,nsmall=2),")"),
      `HR (95% CI), partially adjusted` = paste0(format(estimate_partial,nsmall=2),
             " (",format(conf.low_partial,nsmall=2),"-",format(conf.high_partial,nsmall=2),")"),
      `HR (95% CI), fully adjusted` = paste0(format(estimate_full,nsmall=2),
             " (",format(conf.low_full,nsmall=2),"-",format(conf.high_full,nsmall=2),")"),
    ) %>%
    # Remove gaps in reference rows for clean HRs
    mutate(
        n_obs_cox = n_obs,
        n_event_cox = n_event,
       `HR (95% CI), minimally adjusted` =  gsub(" (  NA-  NA)", "", `HR (95% CI), minimally adjusted`, fixed = TRUE),
       `HR (95% CI), partially adjusted` =  gsub(" (  NA-  NA)", "", `HR (95% CI), partially adjusted`, fixed = TRUE),
       `HR (95% CI), fully adjusted` =  gsub(" (  NA-  NA)", "", `HR (95% CI), fully adjusted`, fixed = TRUE),
    ) %>%
    select(c(group, plot_group, Variable, `N (events)`, `Coverage (%)`, 
             `HR (95% CI), minimally adjusted`, `HR (95% CI), partially adjusted`, `HR (95% CI), fully adjusted`,
             n_obs_cox, n_event_cox)) 

## Import and format logistic regression results
logistic_tbl <- read_rds(here::here("output", "model", "mod_strat_logistic_redacted.rds")) %>%
  filter(group != "region") %>%
  mutate(
    Variable = label_clean,
    `N (events), LR`= paste0(prettyNum(n_obs, big.mark = ",")," (",prettyNum(n_event, big.mark = ","),")"),
    `Coverage (%), LR`= format(round(n_event/n_obs*100,1), nsmall=1),
    # `OR (95% CI), minimally adjusted` = paste0(format(estimate_minimal,nsmall=2),
    #                                            " (",format(conf.low_minimal,nsmall=2),"-",format(conf.high_minimal,nsmall=2),")"),
    `OR (95% CI), partially adjusted` = paste0(format(estimate_partial,nsmall=2),
                                               " (",format(conf.low_partial,nsmall=2),"-",format(conf.high_partial,nsmall=2),")")
    # `OR (95% CI), fully adjusted` = paste0(format(estimate_full,nsmall=2),
    #                                            " (",format(conf.low_full,nsmall=2),"-",format(conf.high_full,nsmall=2),")")
  ) %>%
  # Remove gaps in reference rows for clean HRs
  mutate(
        n_obs_lr = n_obs,
        n_event_lr = n_event,
       #`OR (95% CI), minimally adjusted` =  gsub(" (  NA-  NA)", "", `OR (95% CI), minimally adjusted`, fixed = TRUE),
       `OR (95% CI), partially adjusted` =  gsub(" (  NA-  NA)", "", `OR (95% CI), partially adjusted`, fixed = TRUE),
       #`OR (95% CI), fully adjusted` =  gsub(" (  NA-  NA)", "", `OR (95% CI), fully adjusted`, fixed = TRUE)
  ) %>%
  select(
    c(Variable,  `N (events), LR`, `Coverage (%), LR`, # `OR (95% CI), minimally adjusted`,
      `OR (95% CI), partially adjusted`, #`OR (95% CI), fully adjusted`,
      n_obs_lr, n_event_lr)
  )

## Combine and render table
tbl_combined <- left_join(dose3_tbl_formatted, logistic_tbl, by = "Variable") %>%
  mutate(
    diff_n_obs = n_obs_cox-n_obs_lr,
    diff_n_event = n_event_cox-n_event_lr,
    `N (events), LR` = ifelse((diff_n_obs>0 & diff_n_obs<=10) | (diff_n_event>0 & diff_n_event<=10), "[Redacted]", `N (events), LR`)
  ) %>% select(-c(diff_n_obs, n_obs_cox, n_obs_lr, diff_n_event, n_event_cox, n_event_lr))

tbl_combined %>%
    gt(rowname_col = "Variable", groupname_col = "group") %>%
    cols_hide(columns = "plot_group") %>%
    tab_options(table.font.size = pct(85)) %>%
     tab_style(
        style = list(
          cell_borders(
            sides = c("right"), color = "#cccccc"
          )
          ),
        locations = list(
          cells_body(
            columns = c("HR (95% CI), fully adjusted")
          )
        )
     ) %>%
    tab_spanner(
      label = "Cox models",
      columns = c("N (events)", "Coverage (%)", 
             "HR (95% CI), minimally adjusted", "HR (95% CI), partially adjusted", "HR (95% CI), fully adjusted")
    )  %>%
    tab_spanner(
      label = "Logistic regression",
      columns = c("N (events), LR", "Coverage (%), LR", "OR (95% CI), partially adjusted")
    )%>%
    tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold")
```
All counts are rounded to nearest 5. Data are redacted for any rows with rounded counts of >0 and <=10 for n (vaccinated) or n (unvaccinated and uncensored at cut-off). Coverage was determined based on Kaplan-Meier estimates (Cox models) or n/N (logistic regression models).
<br/><br/>    

#### Plot of partially adjusted model outputs
```{r, fig.width=8, fig.height=12}
## Function to create plot of cox outputs
plot_reduced_tbl = function(input_tbl, dose4=FALSE, level = c("partial", "full")) {
  
  if (level=="partial") {
      input_tbl$HR = input_tbl$estimate_partial
      input_tbl$lowerCI = input_tbl$conf.low_partial
      input_tbl$upperCI = input_tbl$conf.high_partial
  } else {
      input_tbl$HR = input_tbl$estimate
      input_tbl$lowerCI = input_tbl$conf.low
      input_tbl$upperCI = input_tbl$conf.high
  }
  
  ## Remove redacted components from plot
  input_tbl$HR[input_tbl$HR=="[Redacted]"] = NA
  input_tbl$lowerCI[input_tbl$HR=="[Redacted]"] = NA
  input_tbl$upperCI[input_tbl$HR=="[Redacted]"] = NA
  
  ## Recode HRs and CIs as numerics
  input_tbl$HR = as.numeric(input_tbl$HR)
  input_tbl$lowerCI = as.numeric(input_tbl$lowerCI)
  input_tbl$upperCI = as.numeric(input_tbl$upperCI)
  
  ## Set plot min
  plot_min = 0.5
  if(min(input_tbl$lowerCI, na.rm=T) < plot_min) { plot_min = min(input_tbl$lowerCI, na.rm=T) }
  
  ## Set plot max
  plot_max = 2
  if(max(input_tbl$upperCI, na.rm=T) > plot_max) { plot_max = max(input_tbl$upperCI, na.rm=T) }
  
  ## Add redaction text variable
  input_tbl$redaction = NA
  input_tbl$redaction[input_tbl$N_event=="[Redacted]"] = "[R]"
  
  ## Generate plot of HRs
  g1 = ggplot(input_tbl, aes(y = HR, x = label_clean, colour = plot_group)) + 
    geom_point(size = 2, alpha=0.8) +
    geom_text(aes(y = 0.52, label = redaction), show.legend = FALSE) +
    geom_errorbar(aes(ymin=as.numeric(lowerCI), ymax=as.numeric(upperCI), colour = plot_group), width=0) + 
    coord_flip() + facet_grid(group~., scales = "free", space = "free") + 
    theme_bw() + theme(strip.background = element_blank()) + labs(colour = "Group") +
    geom_hline(yintercept=1, linetype="dotted") + 
    ylab("Hazard ratio") + xlab("") +
    scale_colour_manual(values = c("#3B9AB2", "#E1AF00", "#7570B3", "#B40F20")) +
    theme(axis.title = element_text(size=12), axis.text = element_text(size=12), strip.text = element_blank(), 
          legend.title = element_text(size = 12), legend.text = element_text(size = 12), legend.position = c(-1.5,0.95))
  
  ## Set axis breaks depending on outcome
  if (dose4==TRUE) { 
      g1 = g1 + scale_y_continuous(trans="log",limits=c(plot_min, plot_max), breaks=c(0.5,1,2,4,8)) 
  } else { 
      g1 = g1 + scale_y_continuous(trans="log",limits=c(plot_min, plot_max), breaks=c(0.5,1,2)) 
  }

  ## Set axis limits for coverage estimates
  if (dose4==TRUE) { plot_min = 0 } else { plot_min = min(input_tbl$km_coverage, na.rm=T)-10 }
  if (dose4==TRUE) { plot_max = max(input_tbl$km_coverage, na.rm=T)+10 } else { plot_max = 100 }
  
  ## Set facet labels
  facet_labs = c("Age", "Sex", "Ethnicity", "IMD", "Setting", "Subgroup", "", "Access", "Clinical risk group")
  names(facet_labs) <- unique(input_tbl$group)

  ## Generate coverage plot
  g2 = ggplot(input_tbl, aes(y = km_coverage, x = label_clean, colour = plot_group)) + 
    geom_point(size = 2, alpha=0.8) +
    geom_segment(aes(xend=label_clean), yend=0) +
    ylim(plot_min,plot_max) + coord_flip() + facet_grid(group~., scales = "free", space = "free", labeller = labeller(group = facet_labs)) + 
    theme_bw() + theme(strip.background = element_blank()) + 
    ylab("Coverage (%)") + xlab("") +
    scale_colour_manual(values = c("#3B9AB2", "#E1AF00", "#7570B3", "#B40F20")) +
    theme(axis.title = element_text(size=12), axis.text.x = element_text(size=12), axis.text.y = element_blank(), strip.text = element_text(size = 12), 
          legend.title = element_text(size = 12), legend.text = element_text(size = 12), legend.position = "none")
  
  plot_grid(g1, g2, ncol=2,  align="h", axis = c("tb"), rel_widths = c(3,0.9))
}
plot_reduced_tbl(dose3_tbl, level="partial")
```
<br/><br/>





#### Covariates associated with vaccine coverage: dose 4 by 11 May 2022

##### Cox proportional hazards
```{r}
data_cox <- read_rds(here::here("output", "data", "data_cox_coverage_dose4.rds"))

## Censored populations
total_vax = plyr::round_any(sum(data_cox$covid_vax),5)
total_N = plyr::round_any(nrow(data_cox),5)
vax_perc = round(total_vax/total_N*100,1)

## Uncensored population totals
total_vax_uncensored = plyr::round_any(sum(data_cox$uncensored_at_cut_off==1 & data_cox$vax_uncensored_at_cut_off==1),5)
total_N_uncensored = plyr::round_any(sum(data_cox$uncensored_at_cut_off),5)
vax_perc_uncensored = round(total_vax_uncensored/total_N_uncensored*100,1)
```

Analysis restricted to individuals who were >=75 years or had a history of immunosuppression, haematologic cancer, or transplant on the index date. Follow-up was censored on the date of death, deregistration, or the end of the study period (11-May-2022). Overall coverage among individuals uncensored on 11-May-2022 was `r vax_perc_uncensored`% (`r prettyNum(total_vax_uncensored)` / `r prettyNum(total_N_uncensored)`, rounded to nearest 5). 
<br/><br/>

##### Multivariate model outputs (scroll left/right for full table)
```{r}
dose4_tbl <- read_rds(here::here("output", "model", paste0("mod_strat_coxph_redacted_dose4_full.rds"))) 

dose4_tbl %>% 
    mutate(
      Variable = label_clean,
      `N (events)` = paste0(prettyNum(n_obs, big.mark = ",")," (",prettyNum(n_event, big.mark = ","),")"),
      `Coverage (%)` = format(km_coverage, nsmall=1),
      `HR (95% CI), minimally adjusted` = paste0(format(estimate_minimal,nsmall=2),
                                                 " (",format(conf.low_minimal,nsmall=2),"-",format(conf.high_minimal,nsmall=2),")"),
      `HR (95% CI), partially adjusted` = paste0(format(estimate_partial,nsmall=2),
                                                 " (",format(conf.low_partial,nsmall=2),"-",format(conf.high_partial,nsmall=2),")"),
      `HR (95% CI), fully adjusted` = paste0(format(estimate_full,nsmall=2),
                                             " (",format(conf.low_full,nsmall=2),"-",format(conf.high_full,nsmall=2),")"),
    ) %>%
    # Remove gaps in reference rows for clean HRs
    mutate(
       `HR (95% CI), minimally adjusted` =  gsub(" (  NA-  NA)", "", `HR (95% CI), minimally adjusted`, fixed = TRUE),
       `HR (95% CI), partially adjusted` =  gsub(" (  NA-  NA)", "", `HR (95% CI), partially adjusted`, fixed = TRUE),
       `HR (95% CI), fully adjusted` =  gsub(" (  NA-  NA)", "", `HR (95% CI), fully adjusted`, fixed = TRUE),
    ) %>%
    select(c(group, plot_group, Variable, `N (events)`, `Coverage (%)`, 
             `HR (95% CI), minimally adjusted`, `HR (95% CI), partially adjusted`, `HR (95% CI), fully adjusted`)) %>%
    gt(rowname_col = "Variable", groupname_col = "group") %>%
    cols_hide(columns = "plot_group") %>%
    tab_options(table.font.size = pct(85)) %>%
     tab_style(
        style = list(
          cell_borders(
            sides = c("right"), color = "#cccccc"
          )
          ),
        locations = list(
          cells_body(
            columns = c("Coverage (%)")
          )
        )
     ) %>%
    tab_spanner(
      label = "Cox models",
      columns = starts_with("HR")
    ) %>%
    tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold")
```
See footnotes above for details.<br/><br/>    

#### Plot of partially adjusted model outputs
```{r, fig.width=8, fig.height=12}
plot_reduced_tbl(dose4_tbl, dose4=TRUE, level="partial")
```
<br/><br/><br/><br/>







#### Subgroup analyses

##### Dose 3 summary
```{r}
## Function to create clean table of dose-specific cox subgroup outputs
create_reduced_tbl_subgroup = function(selected_dose=c("dose3", "dose4")) {

  # Define strata
  subgroups = c("CKD3a", "CKD3b", "CKD4-5", "RRT (dialysis)", "RRT (Tx)")
  
  ## Import cox regression results for subgroup analyses
  for (i in 1:length(subgroups)) {
    tbl_subset <- read_rds(here::here("output", "model", paste0("mod_strat_coxph_redacted_",selected_dose,"_",subgroups[i],".rds")))
    tbl_subset$subgroup = subgroups[i]
    tbl_subset$subgroup_id = i
    if (i == 1) { tbl_summary = tbl_subset } else { tbl_summary = rbind(tbl_summary, tbl_subset) }
  }

  return(tbl_summary)
}

## Function to create formatted gt output
tabulate_reduced_tbl_subgroup = function(input_tbl, selected_dose=c("dose3", "dose4")) { 
  # Example: input_tbl = tbl_summary

  ## Select variables of interes
  tbl_reduced <- input_tbl %>%
    mutate(
      Variable = label_clean,
      `N (events)` = paste0(prettyNum(as.numeric(n_obs), big.mark = ","),
                              " (",prettyNum(as.numeric(n_event), big.mark = ","),")"),
      `Coverage (%)` = format(as.numeric(km_coverage), nsmall=1),
      # Collate summary outputs
      `HR (95% CI)` = paste0(format(as.numeric(estimate_partial),nsmall=2),
                                  " (",format(as.numeric(conf.low_partial),nsmall=2),"-",format(as.numeric(conf.high_partial),nsmall=2),")"),
      `HR (95% CI)` =  gsub(" ", "", `HR (95% CI)`, fixed = TRUE),
      `HR (95% CI)` =  gsub("(", " (", `HR (95% CI)`, fixed = TRUE),
      `HR (95% CI)` =  gsub(" (NA-NA)", "", `HR (95% CI)`, fixed = TRUE),

      # Apply redactions
      `N (events)` = ifelse(n_obs=="[Redacted]", "[Redacted]", `N (events)`),
      `Coverage (%)` = ifelse(n_obs=="[Redacted]", "[Redacted]", `Coverage (%)`),
      `HR (95% CI)` =  ifelse(n_obs=="[Redacted]", "[Redacted]", `HR (95% CI)`),
    ) %>%
    select(group, Variable, subgroup, subgroup_id, `N (events)`, `Coverage (%)`, `HR (95% CI)`)
  
  ## Pivot to wide format based on subgroup
  tbl_wide = tbl_reduced %>% 
    pivot_wider(    
      names_from = c(subgroup, subgroup_id),
      values_from = c(`N (events)`, `Coverage (%)`, `HR (95% CI)`),
      names_glue = "{.value} [{subgroup_id}]"
    ) 
  
  ## Generate table
  tbl_wide = tbl_wide %>%
    gt(rowname_col = "Variable", groupname_col = "group") %>%
    tab_spanner(
      label = "CKD3a",
      columns = paste0(c("N (events)", "Coverage (%)", "HR (95% CI)")," [1]")
    )  %>%
    tab_spanner(
      label = "CKD3b",
      columns = paste0(c("N (events)", "Coverage (%)", "HR (95% CI)")," [2]")
    )  %>%
    tab_spanner(
      label = "CKD4-5",
      columns = paste0(c("N (events)", "Coverage (%)", "HR (95% CI)")," [3]")
    )  %>%
    tab_spanner(
      label = "RRT (dialysis)",
      columns = paste0(c("N (events)", "Coverage (%)", "HR (95% CI)")," [4]")
    )  %>%
    tab_spanner(
      label = "RRT (Tx)",
      columns = paste0(c("N (events)", "Coverage (%)", "HR (95% CI)")," [5]")
    ) %>%
    tab_options(table.font.size = pct(70)) %>%
     tab_style(
        style = list(
          cell_borders(
            sides = c("right"), color = "#cccccc"
          )
          ),
        locations = list(
          cells_body(
            columns = starts_with("HR")
          )
        )
     ) %>%
    tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold")

  return(tbl_wide)
}

## Create table for dose 3 data
dose3_tbl_subgroup = create_reduced_tbl_subgroup("dose3")
tabulate_reduced_tbl_subgroup(dose3_tbl_subgroup, "dose3")
```
<br/>All counts rounded to nearest 5; data redacted for any rows with rounded values of <=10 for n (vaccinated) or n (unvaccinated and uncensored at cut-off). Cumulative coverage was determined based on Kaplan-Meier estimates.
<br/><br/>

##### Dose 3 plot
```{r, fig.width=15, fig.height=10}
## Function to create plot of cox subgroup outputs 
plot_reduced_tbl_subgroup = function(input_tbl, dose4=FALSE) {
  ## Remove redacted components from plot
  input_tbl$estimate_partial[input_tbl$estimate_partial=="[Redacted]"] = NA
  input_tbl$conf.low_partial[input_tbl$conf.low_partial=="[Redacted]"] = NA
  input_tbl$conf.high_partial[input_tbl$conf.high_partial=="[Redacted]"] = NA
  
  ## Recode HRs and CIs as numerics
  input_tbl$estimate_partial = as.numeric(input_tbl$estimate_partial)
  input_tbl$conf.low_partial = as.numeric(input_tbl$conf.low_partial)
  input_tbl$conf.high_partial = as.numeric(input_tbl$conf.high_partial)
  
  ## Set CKD factor levels
  input_tbl$subgroup = factor(input_tbl$subgroup, level = c("CKD3a", "CKD3b", "CKD4-5", "RRT (dialysis)", "RRT (Tx)"))
  
  ## Set plot min
  plot_min = 0.5
  if(min(input_tbl$conf.low_partial, na.rm=T) < plot_min) { plot_min = min(input_tbl$conf.low_partial, na.rm=T) }
  
  ## Set plot max
  plot_max = 2
  if(max(input_tbl$conf.high_partial, na.rm=T) > plot_max) { plot_max = max(input_tbl$conf.high_partial, na.rm=T) }
  
  ## Add redaction text variable
  input_tbl$redaction = NA
  input_tbl$redaction[input_tbl$n_obs=="[Redacted]"] = "[R]"

  facet_labs = c("Age", "Sex", "Ethnicity", "IMD", "Setting", "", "Access", "Clinical risk group")
  names(facet_labs) <- unique(input_tbl$group)

  ## Generate plot of HRs
  g1 = ggplot(input_tbl, aes(y = estimate_partial, x = label_clean, colour = plot_group)) + 
    geom_point(size = 2, alpha=0.8) +
    geom_text(aes(y = plot_min+0.02, label = redaction), show.legend = FALSE) +
    geom_errorbar(aes(ymin=as.numeric(conf.low_partial), ymax=as.numeric(conf.high_partial), colour = plot_group), width=0) + 
    coord_flip() + facet_grid(group~subgroup, scales = "free", space = "free", labeller = labeller(group = facet_labs)) + 
    theme_bw() + theme(strip.background = element_blank()) + labs(colour = "Group") +
    geom_hline(yintercept=1, linetype="dotted") + 
    ylab("Hazard ratio") + xlab("") +
    scale_colour_manual(values = c("#3B9AB2", "#E1AF00", "#7570B3", "#B40F20")) +
    theme(axis.title = element_text(size=12), axis.text = element_text(size=12), strip.text.y = element_text(size=12), strip.text.x = element_text(size=12), 
          legend.title = element_text(size = 12), legend.text = element_text(size = 12), legend.position = "left")
  
  ## Set axis breaks depending on outcome
  if (dose4==TRUE) { 
      g1 = g1 + scale_y_continuous(trans="log",limits=c(plot_min, plot_max), breaks=c(0.5,1,2)) 
  } else { 
      g1 = g1 + scale_y_continuous(trans="log",limits=c(plot_min, plot_max), breaks=c(0.5,1,2)) 
  }
  g1
}
plot_reduced_tbl_subgroup(dose3_tbl_subgroup, dose4=FALSE)
```
<br/><br/><br/><br/>  





##### Dose 4 summary
```{r}
tbl_subgroup = create_reduced_tbl_subgroup("dose4")
tabulate_reduced_tbl_subgroup(tbl_subgroup, "dose4")
```
<br/>See footnotes above.
<br/><br/>  

##### Dose 4 plot
```{r, fig.width=15, fig.height=10}
plot_reduced_tbl_subgroup(tbl_subgroup, dose4=TRUE)
```
<br/><br/><br/><br/>  




##### Session info
```{r}
print(sessionInfo())
```

