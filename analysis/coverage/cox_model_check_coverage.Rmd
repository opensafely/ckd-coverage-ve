---
title: "Check of Cox model assumptions for coverage models"
output: html_document
---


### Dose 3 models (primary outcome)

#### Summary of univariate model without stratification
```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

## Import libraries
library('here')
library('readr')
library('tidyr')
library('tidyverse')
library('lubridate')
library('survival')
library('gtsummary')
library('gt')
library('survminer')
library('glue')
library('fs')
library('cowplot')


## Import custom user functions
source(here::here("analysis", "functions.R"))

## Import data for dose 2 analyses
data_cox <- read_rds(here::here("output", "data", "data_cox_coverage_dose3.rds"))

## Set vafriable list
var_list <- c("ageband2", "care_home", "hscworker", "housebound", "endoflife", "rural_urban_group",
              "sex", "ethnicity", "imd", "ckd_7cat", "any_ckd_flag",
              "prior_covid", "immunosuppression", "mod_sev_obesity", "diabetes", "any_resp_dis", "chd", "cld", "asplenia", "cancer",
              "haem_cancer", "non_kidney_transplant", "chronic_neuro_dis_inc_sig_learn_dis","sev_mental_ill",
              "cev_other") 
```

#### Visualisation of KM for each coveriate in turn
```{r, fig.width=10, fig.height=35}
for (i in 1:length(var_list)) {
  surv = survfit(as.formula(paste0("Surv(follow_up_time, covid_vax) ~",var_list[i])), data = data_cox)
  plot = ggsurvplot(surv)[[1]]
  assign(paste0("p_", i), plot) # saves to environment
}

plot_grid(
  p_1, p_2, p_3, p_4, p_5, p_6, p_7, p_8, p_9, p_10,
  p_11, p_12, p_13, p_14, p_15, p_16, p_17, p_18, p_19, p_20,
  p_21, p_22, p_23, p_24, p_25,
  ncol=2
)
```

####

```{r}
cox_full <- coxph(as.formula(paste0("Surv(follow_up_time, covid_vax) ~", paste(var_list, collapse="+"),"+ strata(region)")),
                    data = data_cox)
test.ph = cox.zph(cox_full)
test.ph
```
#### Schoenfeld residuals (ggplot)
```{r, fig.width=8, fig.height=30}
for (i in 1:length(var_list)) {
  plot = ggcoxzph(test.ph, var=var_list[i])[[1]]
  assign(paste0("p_", i), plot) # saves to environment
}
plot_grid(
  p_1, p_2, p_3, p_4, p_5, p_6, p_7, p_8, p_9, p_10,
  p_11, p_12, p_13, p_14, p_15, p_16, p_17, p_18, p_19, p_20,
  p_21, p_22, p_23, p_24, p_25,
  ncol=2
)
```

#### Schoenfeld residuals (base plot)
```{r}
plot(test.ph)
```





Session info {.hidden}
===================================== 

```{r}
print(sessionInfo())
```
.

