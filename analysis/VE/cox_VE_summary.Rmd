---
title: "Comparative effectiveness of BNT162b2 vs ChAdOx1-S in CKD patients"
output: html_document
---

```{r setup, include=FALSE}
## Set whether or not to import matched data - ONLY UPDATE THIS LINE BETWEEN MATCHED/UNMATCHED OUTPUTS
matched = FALSE

## Set reference database for model outputs
if (matched) { db = "VE_matched" } else { db = "VE"}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

## Import libraries
library('here')
library('tidyverse')
library('readr')
library('tidyr')
library('lubridate')
library('glue')
library('gt')
library('gtsummary')
library('reshape2')
library('kableExtra')
library('cowplot')
library('fs')
library('survival')
library('survminer')
library('scales')

## Import custom user functions
source(here::here("analysis", "functions.R"))

## Import data
if (matched) {
  data_cohort <- read_rds(here::here("output", "data", "data_cohort_VE_matched.rds")) 
} else {
  data_cohort <- read_rds(here::here("output", "data", "data_cohort_VE.rds")) 
  }

## Set list of outcomes and date variable names
outcomes <- read_rds(
  here::here("output", "lib", "outcomes.rds")
)
outcome_list = outcomes$short_name
clean_list = outcomes$clean_name
date_list = outcomes$date_name

## Read in data for cumulative incidence curves
if (matched) {
  data_tte <- read_rds(here::here("output", "data", "data_cohort_VE_matched.rds"))
} else {
  data_tte <- read_rds(here::here("output", "data", "data_cohort_VE.rds"))
  }
data_tte <- data_tte %>%
  mutate(
    vax2_type_descr = recode(vax2_type_descr, "BNT162b2" = "BNT", "ChAdOx1" = "AZ")
  )

## Import outcome time periods
postvax_list <- read_rds(
  here::here("output", "lib", "postvax_list.rds")
)
postvaxcuts = postvax_list$postvaxcuts
postvax_periods = postvax_list$postvax_periods
period_length = postvaxcuts[2]

## Set rounding threshold for calculation of KM steps
threshold = 10

## Calculated total cohort size rounded to nearest 5
rounded_n = plyr::round_any(nrow(data_cohort), 5)

## Check for mock data flag
if (data_cohort$mock_data_flag[1]==1) { flag = "present" } else { flag = "absent" }
```

#### Background
Chronic kidney disease (CKD) is a significant risk factor for COVID-19-related mortality. Although vaccination has the potential to mitigate this risk, CKD has been linked with impaired COVID-19 vaccine immunogenicity and high rates of breakthrough infection among individuals who have received a 2-dose primary vaccine series.

Vaccine recommendations for CKD patients in the UK have evolved over time (see [protocol](https://docs.google.com/document/d/1w48W-bCMfn0RdkfxlU6fbRkPv3MnIYd3/edit#heading=h.1fob9te). Relative uptake of different vaccines in this population remains uncertain, as does the relative vaccine effectiveness (VE) of different regimens, including homologous versus heterologous vaccine usage. This project seeks to address these key evidence gaps.

Most CKD patients received a 2-dose homologous primary series of either BNT162b2 or ChAdOx1-S between January and June 2021 (see outputs of vaccine coverage analyses).
<br/><br/>

#### Inclusion criteria
* Registered for at least 3m before index date (01-Dec-2020)    
* Alive on index date    
* Aged â‰¥16 and <120 on index date
* eGFR<60 in 2 years before 01 Dec 2020 OR dialysis code (opensafely/dialysis/3ce108ac) OR kidney transplant code (opensafely/kidney-transplant//2020-07-15)    
* No missing demographic data   
* Received 2 x ChAdOx1-S or 2 x BNT162b2 as first two vaccine doses
* Received first dose after 04 January 2021 (the period in which vaccines were in use)
* Dose interval was in the range of 8-16 weeks
* Events designated as postvaccination outcomes occurred after the date of the second dose
* Not a healthcare worker, care home resident, receiving end-of-life care, or housebound

A total of **`r formatC(rounded_n, big.mark=",")`** (rounded to the nearest 5) met the inclusion criteria (see *output/data/flowchart.csv* for additional details).    
`r if(flag=="present") { paste0("NB: Dummy data processing flag detected!") }`    
<br/><br/>

#### Table 1: Summary of population for VE analysis
```{r}
if (matched) {
  table_1 <- read_rds(here::here("output", "tables", "table1_VE_matched_redacted.rds"))
} else {
  table_1 <- read_rds(here::here("output", "tables", "table1_VE_redacted.rds"))
  }

subset(table_1) %>% 
   gt(groupname_col = "Group") %>%
   tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold") %>%
   tab_style(
     style = cell_text(indent = pct(5)),
     locations = cells_body(columns = "Variable")
     ) %>%
   tab_options(table.font.size = pct(85)) %>% #table.width = pct(80) 
   tab_footnote(
     footnote = "All counts rounded to nearest 5; any rounded counts <=10 or within <=10 of population total redacted.",
     locations = cells_column_labels(columns = c("ChAdOx1-S", "BNT162b2"))
   ) %>%
    cols_width(
    starts_with("Variable") ~ px(350)
    )
```
<br/><br/>

#### Follow-up time distribution (quartiles rounded to nearest 5)
```{r}
hist_data = data.frame(data_cohort)
fup_time_dist = function(db, outcome) { plyr::round_any(as.numeric(quantile(db[,outcome])),5) }
summary_df = t(
  tibble(
  `tte (+ test)` = fup_time_dist(hist_data, "tte_covid_postest_or_censor"),
  `tte (COVID A&E)` = fup_time_dist(hist_data, "tte_covid_emergency_or_censor"),
  `tte (COVID hosp.)` = fup_time_dist(hist_data, "tte_covid_hosp_or_censor"),
  `tte (COVID death)` = fup_time_dist(hist_data, "tte_covid_death_or_censor"),
  )
)
colnames(summary_df) = c("min", "q1", "median", "q3", "max") 
data.frame(summary_df[,c("q1", "median", "q3")]) %>% 
  gt(rownames_to_stub = TRUE) %>%
  tab_options(table.font.size = pct(85))
```
<br/><br/>

#### Date distribution of events
```{r, fig.width=14, fig.height=3, message=FALSE}
dose_dates = rbind(
   data.frame(event = "dose 2", dates = hist_data$vax2_date, type = "dose"),
   data.frame(event = "dose 3", dates = hist_data$vax3_date, type = "dose"),
   data.frame(event = "+ve test", dates = hist_data$postvax_positive_test_date, type = "outcome"),
   data.frame(event = "hosp.", dates = hist_data$postvax_covid_hospitalisation_date, type = "outcome"),
   data.frame(event = "censor", dates = hist_data$censor_date, type = "outcome")
 )
dose_dates$event = factor(dose_dates$event, levels = c("dose 2", "dose 3", "+ve test", "hosp.", "censor")) 

ggplot(dose_dates, aes(x=dates, group=event, fill=event)) + 
     geom_histogram(alpha=0.8, adjust = 1.5) +
     scale_x_date(labels = date_format("%m/%y"),
               limits = c(as.Date("2021-01-01"), as.Date("2021-12-31")), 
               breaks = c(as.Date("2021-01-01"),as.Date("2021-04-01"),as.Date("2021-07-01"),as.Date("2021-10-01"))) +
     theme_bw() + xlab("date") + ylab("density (smoothed)") + 
     scale_fill_brewer(palette="Dark2") +
     theme(strip.background = element_blank(), strip.text = element_text(size=12),
           axis.text = element_text(size=12), axis.title = element_text(size=12),
           legend.title = element_text(size=12), legend.text = element_text(size=12)) +
  facet_grid(.~event, scales="free") + 
  annotate("rect", xmin = as.Date("2021-01-01"), xmax = as.Date("2021-12-31"), ymin = 0, ymax = 10, alpha = 1, colour="grey")
```
<br/>Histograms display raw event counts. A grey rectangle with y axis limits 0 and 10 redacts any bars with values <=10.
<br/><br/>

#### Cumulative incidence plots and hazard ratios over time (figure)
```{r, fig.width=21, fig.height=15}
create_rounded_surv_table = function(outcome_number) {
  data_surv <-
    data_tte %>%
    mutate(
      ind_outcome = get(paste0("ind_",outcome_list[outcome_number])),
      tte_outcome = get(paste0("tte_",outcome_list[outcome_number],"_or_censor"))
    ) %>%
    group_by(vax2_type_descr) %>%
    nest() %>%
    mutate(
      n_events = map_int(data, ~sum(.x$ind_outcome, na.rm=TRUE)),
      surv_obj = map(data, ~{
        survfit(Surv(tte_outcome, ind_outcome) ~ 1, data = .x, conf.type="log-log")
      }),
      surv_obj_tidy = map(surv_obj, ~tidy_surv(.x, times=seq_len(max(postvaxcuts)))), # return survival table for each day of follow up
    ) %>%
    select(vax2_type_descr, n_events, surv_obj_tidy) %>%
    unnest(surv_obj_tidy)

  data_surv_rounded <-
    data_surv %>%
    mutate(
      N = plyr::round_any(max(n.risk, na.rm=TRUE),threshold),
      cml.event = cumsum(replace_na(n.event, 0)),
      cml.censor = cumsum(replace_na(n.censor, 0)),
      cml.event.floor = floor_any(cml.event, threshold),
      cml.censor.floor = floor_any(cml.censor, threshold),
      n.event.floor = diff(c(0,cml.event.floor)),
      n.censor.floor = diff(c(0,cml.censor.floor)),
      n.risk.floor = N - lag(cml.event.floor + cml.censor.floor,1,0),
      summand.floor = n.event.floor / ((n.risk.floor - n.event.floor) * n.risk.floor),
      surv.floor = cumprod(1 - n.event.floor / n.risk.floor),
      surv.se.floor = surv.floor * sqrt(cumsum(replace_na(summand.floor, 0))),
      llsurv.floor = log(-log(surv.floor)),
      llsurv.se.floor = sqrt((1 / log(surv.floor)^2) * cumsum(summand.floor)),
      surv.ll.floor = exp(-exp(llsurv.floor + qnorm(0.025)*llsurv.se.floor)),
      surv.ul.floor = exp(-exp(llsurv.floor + qnorm(0.975)*llsurv.se.floor)),
      cum.in.floor = 1 - surv.floor,
      haz.floor = -(surv.floor-lag(surv.floor, 1, 1))/lag(surv.floor, 1, 1), # n.event / (n.risk * interval),
      haz.se.floor = haz.floor * sqrt((n.risk.floor - n.event.floor) / (n.risk.floor* n.event.floor)),
      cml.haz.floor = cumsum(haz.floor),
      cml.haz.se.floor = surv.se.floor/surv.floor,
    ) %>%
    select(
      vax2_type_descr, time, lagtime, leadtime, interval,
      n.risk.floor, n.event.floor, n.censor.floor, summand.floor,
      surv.floor, surv.se.floor, surv.ll.floor, surv.ul.floor,
      haz.floor, haz.se.floor,
      cml.haz.floor, cml.haz.se.floor
    )
  #write.csv(data_surv_rounded, "data_surv_rounded.csv")
  data_surv_rounded
}

surv_covid_postest = create_rounded_surv_table(1) %>% mutate(outcome_clean = clean_list[1])
surv_covid_emergency = create_rounded_surv_table(2) %>% mutate(outcome_clean = clean_list[2])
surv_covid_hosp = create_rounded_surv_table(3) %>% mutate(outcome_clean = clean_list[3])
surv_covid_death = create_rounded_surv_table(4) %>% mutate(outcome_clean = clean_list[4])

## Collate across outcomes
surv_collated = rbind(surv_covid_postest, surv_covid_emergency, surv_covid_hosp, surv_covid_death)
surv_collated$outcome_clean = factor(surv_collated$outcome_clean, levels = clean_list)
#write.csv(subset(surv_collated, outcome_clean==clean_list[1]), "surv_collated.csv")

## Generate KM plot across 4 outcomes
g1 = surv_collated %>%
  ggplot(aes(x = time, y = 1-surv.floor, colour = vax2_type_descr, fill = vax2_type_descr)) + geom_step(size = 0.8) +
  facet_wrap(.~outcome_clean, nrow=1) +
  geom_rect(aes(xmin=lagtime, xmax=time, ymin=1-surv.ll.floor, ymax=1-surv.ul.floor), alpha=0.1, colour="transparent") +
  scale_x_continuous(breaks=postvaxcuts, limits=c(0, max(postvaxcuts)+period_length), expand = c(0, 0)) +
  scale_y_continuous(expand = expansion(mult=c(0,0.01))) +
  labs(
    x = "",
    y = "cumulative incidence",
    colour = "",
    title = "") +
  theme_bw() +
  guides(fill="none") +
  scale_colour_manual(values = c("#CC79A7", "#0072B2")) +
  scale_fill_manual(values = c("#CC79A7", "#0072B2")) +
  theme(
    strip.text = element_text(size=20),
    axis.text = element_text(size=20),
    axis.title = element_text(size=20),
    legend.text = element_text(size=20),
    panel.border = element_blank(),
    axis.line.y = element_line(colour = "black"),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_blank(),
    strip.placement = "outside",
    strip.text.y.left = element_text(angle = 0),
    panel.spacing = unit(0.8, "lines"),
    plot.title = element_text(hjust = 0),
    plot.title.position = "plot",
    plot.caption.position = "plot",
    plot.caption = element_text(hjust = 0, face= "italic"),
    legend.position = "right"  
    )

### Generate plot of hazard ratios over time
model = rbind(
  read_rds(here::here("output", "model", paste0("modelcox_tidy_reduced_unmatched_persontime_",outcome_list[1],".rds"))) %>%
    mutate(outcome_clean = clean_list[1]),
  read_rds(here::here("output", "model", paste0("modelcox_tidy_reduced_unmatched_persontime_",outcome_list[2],".rds"))) %>%
    mutate(outcome_clean = clean_list[2]),
  read_rds(here::here("output", "model", paste0("modelcox_tidy_reduced_unmatched_persontime_",outcome_list[3],".rds"))) %>%
    mutate(outcome_clean = clean_list[3]),
  read_rds(here::here("output", "model", paste0("modelcox_tidy_reduced_unmatched_persontime_",outcome_list[4],".rds"))) %>%
    mutate(outcome_clean = clean_list[4])
)

## Set factor levels
model$model_name = factor(model$model_name, levels = c("unadjusted", "region/date adjusted", "fully adjusted"))

## Remove redacted components from plot
model$estimate = as.numeric(model$estimate)
model$conf.low = as.numeric(model$conf.low)
model$conf.high = as.numeric(model$conf.high)

## Add left, right, and midpoint for full models
model$term_midpoint[model$term=="1-168"] = max(postvaxcuts)+period_length/2
model$term_left[model$term=="1-168"] = max(postvaxcuts)
model$term_right[model$term=="1-168"] = max(postvaxcuts)+period_length

## Add redaction text
model$redaction = NA
model$redaction[model$p.value=="[Redacted]" & model$model==0] = "[R]"
model$n_event = as.numeric(model$AZ_events) + as.numeric(model$BNT_events)
model$redaction[model$n_event==0 & model$model==0] = "[N]"
write.csv(model, "model.csv")


## Generate HR plot for 4 ouctomes
g2 = ggplot(data = model) +
    geom_point(size = 2.5, aes(y=exp(estimate), x=term_midpoint, colour=model_name), position = position_dodge(width = 20)) +
    geom_linerange(aes(ymin=exp(conf.low), ymax=exp(conf.high), x=term_midpoint, colour=model_name), position = position_dodge(width = 20)) +
    geom_hline(aes(yintercept=1), colour='grey') +
    scale_y_log10(
      limits = c(0.25,4),
      breaks=c(0.25, 0.5, 0.67, 1, 1.5, 2, 4),
      sec.axis = dup_axis(name="<- favours BNT / favours AZ ->", breaks = NULL)
    ) +
  facet_wrap(.~outcome_clean, nrow=1) +
  scale_x_continuous(breaks=postvaxcuts, limits=c(0, max(postvaxcuts)+period_length), expand = c(0, 0)) +
  scale_colour_manual(values = c("#3B9AB2", "#E1AF00", "#B40F20")) +
  labs(
    y="hazard ratio (95% CI)",
    x="time since second dose (days)",
    colour=NULL,
    title=NULL
  ) +
  theme_bw()+
  annotate("rect", xmin = 6*28, xmax = 7*28, ymin = 0.25, ymax = 4, alpha = .3, fill = "grey") +
  annotate("text", x = 6*28+14, y = 3.3, label = "All", size=7) +
  geom_text(aes(x = term_midpoint, y = 1, label = redaction), size=6) +
  theme(
    strip.text = element_text(size=20, colour="white"), # set as white to avoid repeating text in aligned plot
    axis.text = element_text(size=20),
    axis.title.y.right = element_text(size=18),
    axis.title = element_text(size=20),
    legend.text = element_text(size=20),
    panel.border = element_blank(),
    axis.line.y = element_line(colour = "black"),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_blank(),
    strip.placement = "outside",
    strip.text.y.left = element_text(angle = 0),
    panel.spacing = unit(0.8, "lines"),
    plot.title = element_text(hjust = 0),
    plot.title.position = "plot",
    plot.caption.position = "plot",
    plot.caption = element_text(hjust = 0, face= "italic"),
    legend.position = "right",
    axis.line.y.right = element_line(size=0)
  )

### Generate plot of hazard ratios over time
model_cal = rbind(
  read_rds(here::here("output", "model", paste0("modelcox_tidy_reduced_unmatched_calendartime_",outcome_list[1],".rds"))) %>%
    mutate(outcome_clean = clean_list[1]),
  read_rds(here::here("output", "model", paste0("modelcox_tidy_reduced_unmatched_calendartime_",outcome_list[2],".rds"))) %>%
    mutate(outcome_clean = clean_list[2]),
  read_rds(here::here("output", "model", paste0("modelcox_tidy_reduced_unmatched_calendartime_",outcome_list[3],".rds"))) %>%
    mutate(outcome_clean = clean_list[3]),
  read_rds(here::here("output", "model", paste0("modelcox_tidy_reduced_unmatched_calendartime_",outcome_list[4],".rds"))) %>%
    mutate(outcome_clean = clean_list[4])
)

## Set factor levels
model_cal$model_name = factor(model_cal$model_name, levels = c("unadjusted", "region/date adjusted", "fully adjusted"))

## Remove redacted components from plot
model_cal$estimate = as.numeric(model_cal$estimate)
model_cal$conf.low = as.numeric(model_cal$conf.low)
model_cal$conf.high = as.numeric(model_cal$conf.high)

## Add left, right, and midpoint for full models
model_cal$term_midpoint[model_cal$term=="1-168"] = max(postvaxcuts)+period_length/2
model_cal$term_left[model_cal$term=="1-168"] = max(postvaxcuts)
model_cal$term_right[model_cal$term=="1-168"] = max(postvaxcuts)+period_length

## Add redaction text
model_cal$redaction = NA
model_cal$redaction[model_cal$p.value=="[Redacted]" & model_cal$model==0] = "[R]"
model_cal$n_event = as.numeric(model_cal$AZ_events) + as.numeric(model_cal$BNT_events)
model_cal$redaction[model_cal$n_event==0 & model_cal$model==0] = "[N]"

## Generate HR plot for 4 ouctomes
g3 = ggplot(data = model_cal) +
    geom_point(size = 2.5, aes(y=exp(estimate), x=term_midpoint, colour=model_name), position = position_dodge(width = 20)) +
    geom_linerange(aes(ymin=exp(conf.low), ymax=exp(conf.high), x=term_midpoint, colour=model_name), position = position_dodge(width = 20)) +
    geom_hline(aes(yintercept=1), colour='grey') +
    scale_y_log10(
      limits = c(0.25,4),
      breaks=c(0.25, 0.5, 0.67, 1, 1.5, 2, 4),
      sec.axis = dup_axis(name="<- favours BNT / favours AZ ->", breaks = NULL)
    ) +
  facet_wrap(.~outcome_clean, nrow=1) +
  scale_x_continuous(breaks=postvaxcuts, limits=c(0, max(postvaxcuts)+period_length), expand = c(0, 0)) +
  scale_colour_manual(values = c("#3B9AB2", "#E1AF00", "#B40F20")) +
  labs(
    y="hazard ratio (95% CI)",
    x="time since second dose (days)",
    colour=NULL,
    title=NULL
  ) +
  theme_bw()+
  #annotate("rect", xmin = 6*28, xmax = 7*28, ymin = 0.25, ymax = 4, alpha = .3, fill = "grey") +
  #annotate("text", x = 6*28+14, y = 3.3, label = "All", size=7) +
  geom_text(aes(x = term_midpoint, y = 1, label = redaction), size=6) +
  theme(
    strip.text = element_text(size=20, colour="white"), # set as white to avoid repeating text in aligned plot
    axis.text = element_text(size=20),
    axis.title.y.right = element_text(size=18),
    axis.title = element_text(size=20),
    legend.text = element_text(size=20),
    panel.border = element_blank(),
    axis.line.y = element_line(colour = "black"),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_blank(),
    strip.placement = "outside",
    strip.text.y.left = element_text(angle = 0),
    panel.spacing = unit(0.8, "lines"),
    plot.title = element_text(hjust = 0),
    plot.title.position = "plot",
    plot.caption.position = "plot",
    plot.caption = element_text(hjust = 0, face= "italic"),
    legend.position = "right",
    axis.line.y.right = element_line(size=0)
  )

## Generate aligned plot
plot_grid(g1, g2, g3, ncol=1,  align="v", axis = c("lr"))
```
Cumulative incidence = 1 - Kaplan-Meier estimate for probability of survival in unadjusted models. Steps occur every 10 events for disclosure control. [R] = redacted (rounded count <=10 in either vaccine group); [N] = rounded count of 0 events in both vaccine groups. 
<br/><br/>

#### Crude incidence rate ratios and hazard ratios over time (table)
```{r}
## Read in table of IRRs
if (matched) {
  table_irr <- read_rds(here::here("output", "tables", "table_irr_matched_redacted.rds"))
} else {
  table_irr <- read_rds(here::here("output", "tables", "table_irr_redacted.rds"))
}

## Update column names
table_irr <- table_irr %>%
  select(c(period, BNT_n, BNT_events, BNT_personyears, BNT_rate, AZ_n, AZ_events, AZ_personyears, AZ_rate, rr, outcome_clean))
names(table_irr) <- c("Period (days)", "n, BNT (total)", "n, BNT (events)", "person-years, BNT", "rate, BNT", 
                      "n, AZ (total)", "n, AZ (events)", "person-years, AZ", "rate, AZ", 
                      "IRR", "outcome_clean")

## Generate table of HRs
HR_summary <- model %>% select(model_name, term, estimate, conf.low, conf.high, outcome_clean) %>%
  mutate(
    `HR (95% CI)` = paste0(round(exp(estimate),2)," (",round(exp(conf.low),2),"-",round(exp(conf.high),2),")"),
    `HR (95% CI)` = if_else(`HR (95% CI)`=="NA (NA-NA)", "--", `HR (95% CI)`),
    term = recode(term, "vax2_az"="1-168")
  ) %>%
  select(-c(estimate, conf.low, conf.high)) %>%
  pivot_wider(
    names_from = model_name,
    values_from = `HR (95% CI)` 
    ) %>%
  rename(`Period (days)` = term)

## Merge tables
left_join(table_irr, HR_summary, by = c("Period (days)", "outcome_clean")) %>%
  gt(groupname_col = "outcome_clean") %>%
  tab_spanner(
    label = "BNT162b2",
    columns = c("n, BNT (total)", "n, BNT (events)", "person-years, BNT", "rate, BNT")
  ) %>%
  tab_spanner(
    label = "ChAdOx1-S",
    columns = c("n, AZ (total)", "n, AZ (events)", "person-years, AZ", "rate, AZ")
  ) %>%
  tab_spanner(
    label = "Hazard ratios",
    columns = c("unadjusted", "region/date adjusted", "fully adjusted")
  ) %>%
   tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold") %>%
   tab_options(table.font.size = pct(80)) %>% #table.width = pct(80) 
   tab_footnote(
     footnote = "IRR = incidence rate ratio.",
     locations = cells_column_labels(columns = c("IRR"))
   ) %>%
   cols_width(
    starts_with("Period") ~ px(100),
    starts_with("IRR") ~ px(200),
    ends_with("adjusted") ~ px(200)
    )
```
<br/>Frequencies are rounded to the nearest 5. Rounded counts of <=10 are redacted. Total event counts are removed to prevent back-calculation of redacted values.

#### Calendar time vs person-time HRs
```{r}
merged <- left_join(
            model[,c("outcome_clean", "term", "model_name", "estimate", "conf.low", "conf.high")], 
            model_cal[,c("outcome_clean",  "term", "model_name", "estimate", "conf.low", "conf.high")], 
            by = c("outcome_clean", "term", "model_name"))

## Generate table of HRs
HR_summary <- merged %>% 
  mutate(
    `HR (95% CI), person-time` = paste0(round(exp(estimate.x),2)," (",round(exp(conf.low.x),2),"-",round(exp(conf.high.x),2),")"),
    `HR (95% CI), person-time` = if_else(`HR (95% CI), person-time`=="NA (NA-NA)", "--", `HR (95% CI), person-time`),
    `HR (95% CI), calender-time` = paste0(round(exp(estimate.y),2)," (",round(exp(conf.low.y),2),"-",round(exp(conf.high.y),2),")"),
    `HR (95% CI), calender-time` = if_else(`HR (95% CI), calender-time`=="NA (NA-NA)", "--", `HR (95% CI), calender-time`),
    term = recode(term, "vax2_az"="1-168")
  ) %>%
  select(-c(estimate.x, estimate.y, conf.low.x, conf.low.y, conf.high.x, conf.high.y)) %>%
  rename(`Period (days)` = term)
HR_summary
```
.