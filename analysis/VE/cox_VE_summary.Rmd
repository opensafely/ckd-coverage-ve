---
title: "Comparative effectiveness of BNT162b2 vs ChAdOx1-S in CKDq patients"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

## Import libraries
library('here')
library('tidyverse')
library('readr')
library('tidyr')
library('lubridate')
library('glue')
library('gt')
library('gtsummary')
library('reshape2')
library('kableExtra')
library('cowplot')
library('fs')

## Import custom user functions
source(here::here("analysis", "functions.R"))

## Import data
data_cohort <- read_rds(here::here("output", "data", "data_cohort_VE.rds"))
rounded_n = plyr::round_any(nrow(data_cohort), 5)

if (data_cohort$mock_data_flag[1]==1) { flag = "present" } else { flag = "absent" }
```

#### Background
Chronic kidney disease (CKD) is a significant risk factor for COVID-19-related mortality. Although vaccination has the potential to mitigate this risk, CKD has been linked with impaired COVID-19 vaccine immunogenicity and high rates of breakthrough infection among individuals who have received a 2-dose primary vaccine series.

Vaccine recommendations for CKD patients in the UK have evolved over time (see [protocol](https://docs.google.com/document/d/1w48W-bCMfn0RdkfxlU6fbRkPv3MnIYd3/edit#heading=h.1fob9te). Relative uptake of different vaccines in this population remains uncertain, as does the relative vaccine effectiveness (VE) of different regimens, including homologous versus heterologous vaccine usage. This project seeks to address these key evidence gaps.

Most CKD patients received a 2-dose homologous primary series of either BNT162b2 or ChAdOx1-S between January and June 2021 (see outputs of vaccine coverage analyses).
$~$

#### Inclusion criteria
* Registered for at least 3m before index date (01-Dec-2020)    
* Alive on index date    
* Aged â‰¥16 and <120 on index date
* eGFR<60 in 2 years before 01 Dec 2020 OR dialysis code (opensafely/dialysis/3ce108ac) OR kidney transplant code (opensafely/kidney-transplant//2020-07-15)    
* No missing demographic data   
* Received 2 x ChAdOx1-S or 2 x BNT162b2 as first two vaccine doses
* Received first dose after 04 January 2021 (the period in which vaccines were in use)
* Dose interval was in the range of 8-16 weeks
* Events designated as postvaccination outcomes occurred after the date of the second dose
* Not a healthcare worker, care home resident, receiving end-of-life care, or housebound

A total of **`r formatC(rounded_n, big.mark=",")`** (rounded to the nearest 5) met the inclusion criteria (see *output/data/flowchart.csv* for additional details).    
`r if(flag=="present") { paste0("NB: Dummy data processing flag detected!") }`    
$~$

#### Table 1: Summary of population
```{r}
table_1 <- read_rds(here::here("output", "tables", "table1_VE_redacted.rds"))

subset(table_1) %>% 
   gt(groupname_col = "Group") %>%
   tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold") %>%
   tab_style(
     style = cell_text(indent = pct(5)),
     locations = cells_body(columns = "Variable")
     ) %>%
   tab_options(table.font.size = pct(95)) %>% #table.width = pct(80) 
   tab_footnote(
     footnote = "All counts rounded to nearest 5; any rounded counts <=10 or within <=10 of population total redacted.",
     locations = cells_column_labels(columns = c("ChAdOx1-S", "BNT162b2"))
   ) %>%
    cols_width(
    starts_with("Variable") ~ px(400)
    )
```
$~$

#### Crude incidence rate ratios in two groups
```{r}
table_irr <- read_rds(here::here("output", "tables", "table_irr_redacted.rds")) %>%
  select(c(period, BNT_n, BNT_events, BNT_personyears, BNT_rate, AZ_n, AZ_events, AZ_personyears, AZ_rate, rr, outcome_clean))
names(table_irr) <- c("Period (days)", "n, BNT (total)", "n, BNT (events)", "person-years, BNT", "rate, BNT", 
                      "n, AZ (total)", "n, AZ (events)", "person-years, AZ", "rate, AZ", 
                      "IRR", "outcome_clean")

table_irr %>%
  gt(groupname_col = "outcome_clean") %>%
  tab_spanner(
    label = "BNT162b2",
    columns = c("n, BNT (total)", "n, BNT (events)", "person-years, BNT", "rate, BNT")
  ) %>%
  tab_spanner(
    label = "ChAdOx1-S",
    columns = c("n, AZ (total)", "n, AZ (events)", "person-years, AZ", "rate, AZ")
  ) %>%
   tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold") %>%
   tab_options(table.font.size = pct(95)) %>% #table.width = pct(80) 
   tab_footnote(
     footnote = "IRR = incidence rate ratio. Data redacted for any rounded counts of >0 and <=5",
     locations = cells_column_labels(columns = c("IRR"))
   ) %>%
   cols_width(
    starts_with("Period") ~ px(100),
    starts_with("IRR") ~ px(150) 
    )
```
$~$

#### Hazard ratios over time (figure)
```{r, fig.width=15, fig.height=4.5}
outcome_list = c("covid_postest", "covid_emergency", "covid_hosp", "covid_death")
clean_list = c("Positive SARS-CoV-2 test", "COVID-related A&E admission", "COVID-related hospitalisation", "COVID-related death")

model = rbind(
  read_rds(here::here("output", "model", "VE", paste0("modelcox_tidy_reduced_",outcome_list[1],".rds"))),
  read_rds(here::here("output", "model", "VE", paste0("modelcox_tidy_reduced_",outcome_list[2],".rds"))),
  read_rds(here::here("output", "model", "VE", paste0("modelcox_tidy_reduced_",outcome_list[3],".rds"))),
  read_rds(here::here("output", "model", "VE", paste0("modelcox_tidy_reduced_",outcome_list[4],".rds")))
)

## Set factor levels
model$model_name = factor(model$model_name, levels = c("unadjusted", "region/date adjusted", "fully adjusted"))

## Remove redacted components from plot
model$estimate = as.numeric(model$estimate)
model$conf.low = as.numeric(model$conf.low)
model$conf.high = as.numeric(model$conf.high)
model$outcome_clean = factor(model$outcome_clean, levels = clean_list)

## Add left, right, and midpoint for full models
model$term_midpoint[model$level=="full"] = 308
model$term_left[model$level=="full"] = 280
model$term_right[model$level=="full"] = 336

## Add redaction text
model$redaction = NA
model$redaction[model$p.value=="[Redacted]" & model$model==0] = "[R]"
model$redaction[model$n_event=="0"] = "[N]"

ggplot(data = model) +
    geom_point(size = 2.5, aes(y=exp(estimate), x=term_midpoint, colour=model_name), position = position_dodge(width = 35)) +
    geom_linerange(aes(ymin=exp(conf.low), ymax=exp(conf.high), x=term_midpoint, colour=model_name), position = position_dodge(width = 35)) +
    geom_hline(aes(yintercept=1), colour='grey') +
    scale_y_log10(
      limits = c(0.25,4),
      breaks=c(0.25, 0.5, 0.67, 1, 1.5, 2, 4),
      sec.axis = dup_axis(name="<--  favours Pfizer  /  favours AZ  -->", breaks = NULL)
    ) +
  facet_wrap(.~outcome_clean, nrow=1) +
  scale_x_continuous(breaks=unique(model$term_left), limits=c(min(model$term_left), max(model$term_right)+1), expand = c(0, 0)) +
  scale_colour_manual(values = c("#3B9AB2", "#E1AF00", "#B40F20")) +
  labs(
    y="hazard ratio (95% CI)",
    x="time since first dose (days)",
    colour=NULL,
    title=NULL
  ) +
  theme_bw()+
  annotate("rect", xmin = 280, xmax = 336, ymin = 0.25, ymax = 4, alpha = .3, fill = "grey") +
  annotate("text", x = 308, y = 3.3, label = "All", size=6) +
  geom_text(aes(x = term_midpoint, y = 1, label = redaction), size=5) +
  theme(
    strip.text = element_text(size=16),
    axis.text = element_text(size=16),
    axis.title = element_text(size=16),
    legend.text = element_text(size=16),
    panel.border = element_blank(),
    axis.line.y = element_line(colour = "black"),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank(),
    strip.background = element_blank(),
    strip.placement = "outside",
    strip.text.y.left = element_text(angle = 0),
    panel.spacing = unit(0.8, "lines"),
    plot.title = element_text(hjust = 0),
    plot.title.position = "plot",
    plot.caption.position = "plot",
    plot.caption = element_text(hjust = 0, face= "italic"),
    legend.position = "bottom"
  )
```
[R] = redacted (between 1 and 5 events in either vaccine group); [N] = 0 events in both vaccine groups.
$~$

#### Hazard ratios over time (table)
```{r}
summary <- model %>% select(model_name, term, estimate, conf.low, conf.high, outcome_clean) %>%
  mutate(
    `HR (95% CI)` = paste0(round(exp(estimate),2)," (",round(exp(conf.low),2),"-",round(exp(conf.high),2),")"),
    `HR (95% CI)` = if_else(`HR (95% CI)`=="NA (NA-NA)", "--", `HR (95% CI)`)
  ) %>%
  select(-c(estimate, conf.low, conf.high)) %>%
  pivot_wider(
    names_from = model_name,
    values_from = `HR (95% CI)` 
    )

# Tidy summary information
summary$term = as.character(summary$term)
summary$term[summary$term=="vax2_az"] = "All"
names(summary)[1] = "Period (days)"
summary %>%
  gt(groupname_col = "outcome_clean") %>%
   tab_options(row_group.font.weight="bold", column_labels.font.weigh="bold") %>%
   tab_options(table.font.size = pct(95))
```
