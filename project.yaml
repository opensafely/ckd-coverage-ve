######################################
# Script defines project pipeline via series of actions
######################################

version: '3.0'

expectations:
  population_size: 500000

actions:

  # Extract data ----
  generate_study_population:
    run: cohortextractor:latest generate_cohort --study-definition study_definition --output-dir=output/data
    outputs:
      highly_sensitive:
        cohort: output/data/input.csv
  
  # Process data ----
  data_process:
    run: r:latest analysis/data_process.R
    needs: [generate_study_population]
    outputs:
      highly_sensitive:
        data: output/data/data_processed.rds
        csv: output/data/data_processed.csv
       
  # Data properties (processed) ----
  data_properties_process:
    run: r:latest analysis/data_properties.R output/data/data_processed.rds output/data_properties
    needs: [data_process]
    outputs:
      moderately_sensitive:
        cohort: output/data_properties/data_processed*.txt

  # Select cohort ----
  data_selection_coverage:
    run: r:latest analysis/coverage/data_selection_coverage.R
    needs: [data_process]
    outputs:
      highly_sensitive:
        data1: output/data/data_cohort_coverage.rds
        csv: output/data/data_cohort_coverage.csv
        data2: output/data/data_cohort_coverage_logistic.rds
        data3: output/data/data_cohort_coverage_dose4.rds
      moderately_sensitive:
        csv: output/tables/flowchart_coverage.csv
  
  # Data properties (coverage) ----
  data_properties_coverage:
    run: r:latest analysis/data_properties.R output/data/data_cohort_coverage.rds output/data_properties
    needs: [data_selection_coverage]
    outputs:
      moderately_sensitive:
        cohort: output/data_properties/data_cohort_coverage*.txt
        
  # Table 1 primary outcome cohort (dose 3) ----
  table_1_coverage_dose3:
    run: r:latest analysis/coverage/table_1_coverage.R dose3
    needs: [data_selection_coverage]
    outputs:
      highly_sensitive:
        data: output/tables/table1_coverage_redacted_by_CKD.rds
      moderately_sensitive:
        table: output/tables/table1_coverage_redacted_by_CKD.html
        
  # Table 1 primary outcome cohort (dose 3) ----
  table_1_coverage_dose4:
    run: r:latest analysis/coverage/table_1_coverage.R dose4
    needs: [data_selection_coverage]
    outputs:
      highly_sensitive:
        data: output/tables/table1_coverage_redacted_by_CKD_dose4.rds
      moderately_sensitive:
        table: output/tables/table1_coverage_redacted_by_CKD_dose4.html
        
  # Cox models - dose-3 coverage ----
  cox_model_dose3:
    run: r:latest analysis/coverage/cox_model.R dose3
    needs: [data_selection_coverage]
    outputs:
      highly_sensitive:
        data1: output/data/data_cox_coverage_dose3*.rds
        data2: output/model/mod_strat_coxph_redacted_dose3*.rds
      moderately_sensitive:
        csv: output/model/mod_strat_coxph_redacted_dose3*.csv
        
  # Cox models - dose-4 coverage ----
  cox_model_dose4:
    run: r:latest analysis/coverage/cox_model.R dose4
    needs: [data_selection_coverage]
    outputs:
      highly_sensitive:
        data1: output/data/data_cox_coverage_dose4*.rds
        data2: output/model/mod_strat_coxph_redacted_dose4*.rds
      moderately_sensitive:
        csv: output/model/mod_strat_coxph_redacted_dose4*.csv
        
  # Logistic models - dose-3 coverage ----
  logistic_model:
    run: r:latest analysis/coverage/logistic_model.R
    needs: [data_selection_coverage]
    outputs:
      highly_sensitive:
        data1: output/data/data_lr.rds
        data2: output/model/mod_strat_logistic_redacted.rds
      moderately_sensitive:
        csv: output/model/mod_strat_logistic_redacted.csv

  # Coverage summaries ----
  vaccine_coverage:
    run: r:latest -e 'rmarkdown::render("analysis/coverage/vaccine_coverage.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown")'
    needs: [data_selection_coverage, table_1_coverage_dose3, table_1_coverage_dose4, cox_model_dose3, cox_model_dose4, logistic_model]
    outputs:
      moderately_sensitive:
        html: output/markdown/vaccine_coverage.html
        
  # Model checks ----
  # Dose 3 - full
  cox_model_check_coverage_dose3_full:
    run: r:latest -e 'rmarkdown::render("analysis/coverage/cox_model_check_coverage.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown/coverage_model_checks/", output_file="dose3_full.html")' dose3 full
    needs: [data_selection_coverage, cox_model_dose3]
    outputs:
      moderately_sensitive:
        html: output/markdown/coverage_model_checks/dose3_full.html
        
  # Dose 3 - CKD3a
  cox_model_check_coverage_dose3_CKD3a:
    run: r:latest -e 'rmarkdown::render("analysis/coverage/cox_model_check_coverage.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown/coverage_model_checks/", output_file="dose3_CKD3a.html")' dose3 CKD3a
    needs: [data_selection_coverage, cox_model_dose3]
    outputs:
      moderately_sensitive:
        html: output/markdown/coverage_model_checks/dose3_CKD3a.html

  # Dose 3 - CKD3b
  cox_model_check_coverage_dose3_CKD3b:
    run: r:latest -e 'rmarkdown::render("analysis/coverage/cox_model_check_coverage.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown/coverage_model_checks/", output_file="dose3_CKD3b.html")' dose3 CKD3b
    needs: [data_selection_coverage, cox_model_dose3]
    outputs:
      moderately_sensitive:
        html: output/markdown/coverage_model_checks/dose3_CKD3b.html

  # Dose 3 - CKD4-5
  cox_model_check_coverage_dose3_CKD4-5:
    run: r:latest -e 'rmarkdown::render("analysis/coverage/cox_model_check_coverage.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown/coverage_model_checks/", output_file="dose3_CKD4-5.html")' dose3 CKD4-5
    needs: [data_selection_coverage, cox_model_dose3]
    outputs:
      moderately_sensitive:
        html: output/markdown/coverage_model_checks/dose3_CKD4-5.html

  # Dose 3 - dialysis
  cox_model_check_coverage_dose3_dialysis:
    run: r:latest -e 'rmarkdown::render("analysis/coverage/cox_model_check_coverage.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown/coverage_model_checks/", output_file="dose3_dialysis.html")' dose3 dialysis
    needs: [data_selection_coverage, cox_model_dose3]
    outputs:
      moderately_sensitive:
        html: output/markdown/coverage_model_checks/dose3_dialysis.html
        
  # Dose 3 - transplant
  cox_model_check_coverage_dose3_transplant:
    run: r:latest -e 'rmarkdown::render("analysis/coverage/cox_model_check_coverage.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown/coverage_model_checks/", output_file="dose3_transplant.html")' dose3 transplant
    needs: [data_selection_coverage, cox_model_dose3]
    outputs:
      moderately_sensitive:
        html: output/markdown/coverage_model_checks/dose3_transplant.html
        
  # Dose 4 - full
  cox_model_check_coverage_dose4_full:
    run: r:latest -e 'rmarkdown::render("analysis/coverage/cox_model_check_coverage.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown/coverage_model_checks/", output_file="dose4_full.html")' dose4 full
    needs: [data_selection_coverage, cox_model_dose4]
    outputs:
      moderately_sensitive:
        html: output/markdown/coverage_model_checks/dose4_full.html
        
  # Dose 4 - CKD3a
  cox_model_check_coverage_dose4_CKD3a:
    run: r:latest -e 'rmarkdown::render("analysis/coverage/cox_model_check_coverage.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown/coverage_model_checks/", output_file="dose4_CKD3a.html")' dose4 CKD3a
    needs: [data_selection_coverage, cox_model_dose4]
    outputs:
      moderately_sensitive:
        html: output/markdown/coverage_model_checks/dose4_CKD3a.html

  # Dose 4 - CKD3b
  cox_model_check_coverage_dose4_CKD3b:
    run: r:latest -e 'rmarkdown::render("analysis/coverage/cox_model_check_coverage.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown/coverage_model_checks/", output_file="dose4_CKD3b.html")' dose4 CKD3b
    needs: [data_selection_coverage, cox_model_dose4]
    outputs:
      moderately_sensitive:
        html: output/markdown/coverage_model_checks/dose4_CKD3b.html

  # Dose 4 - CKD4-5
  cox_model_check_coverage_dose4_CKD4-5:
    run: r:latest -e 'rmarkdown::render("analysis/coverage/cox_model_check_coverage.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown/coverage_model_checks/", output_file="dose4_CKD4-5.html")' dose4 CKD4-5
    needs: [data_selection_coverage, cox_model_dose4]
    outputs:
      moderately_sensitive:
        html: output/markdown/coverage_model_checks/dose4_CKD4-5.html

  # Dose 4 - dialysis
  cox_model_check_coverage_dose4_dialysis:
    run: r:latest -e 'rmarkdown::render("analysis/coverage/cox_model_check_coverage.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown/coverage_model_checks/", output_file="dose4_dialysis.html")' dose4 dialysis
    needs: [data_selection_coverage, cox_model_dose4]
    outputs:
      moderately_sensitive:
        html: output/markdown/coverage_model_checks/dose4_dialysis.html
        
  # Dose 4 - transplant
  cox_model_check_coverage_dose4_transplant:
    run: r:latest -e 'rmarkdown::render("analysis/coverage/cox_model_check_coverage.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown/coverage_model_checks/", output_file="dose4_transplant.html")' dose4 transplant
    needs: [data_selection_coverage, cox_model_dose4]
    outputs:
      moderately_sensitive:
        html: output/markdown/coverage_model_checks/dose4_transplant.html

#############################
### VE cohort selection - matched/unmatched
#############################

# Select cohort (single script used for both matched and unmatched analyses)
  data_selection_VE:
    run: r:latest analysis/VE/data_selection_VE.R
    needs: [data_process]
    outputs:
      highly_sensitive:
        data1: output/data/data_cohort_VE.rds
        data2: output/data/data_cohort_VE_matched.rds
        data3: output/lib/outcomes.rds
        data4: output/lib/postvax_list.rds
        csv1: output/data/data_cohort_VE.csv
        csv2: output/data/data_cohort_VE_matched.csv
      moderately_sensitive:
        csv1: output/tables/flowchart_VE.csv
        csv2: output/tables/flowchart_VE_matched.csv

#############################
### VE table 1 - all, CKD3, CKD4-5, RRT - matched,unmatched
#############################

  # Table 1 (all unmatched)
  table_1_VE_all_unmatched:
    run: r:latest analysis/VE/table_1_VE.R unmatched all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/tables/table1_VE_redacted_unmatched_all.rds
      moderately_sensitive:
        table: output/tables/table1_VE_redacted_unmatched_all.html
  
  # Table 1 (CKD3 unmatched)
  table_1_VE_CKD3_unmatched:
    run: r:latest analysis/VE/table_1_VE.R unmatched CKD3
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/tables/table1_VE_redacted_unmatched_CKD3.rds
      moderately_sensitive:
        table: output/tables/table1_VE_redacted_unmatched_CKD3.html
 
   # Table 1 (CKD4-5 unmatched)
  table_1_VE_CKD4_5_unmatched:
    run: r:latest analysis/VE/table_1_VE.R unmatched CKD4-5
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/tables/table1_VE_redacted_unmatched_CKD4-5.rds
      moderately_sensitive:
        table: output/tables/table1_VE_redacted_unmatched_CKD4-5.html
 
   # Table 1 (RRT unmatched)
  table_1_VE_RRT_unmatched:
    run: r:latest analysis/VE/table_1_VE.R unmatched RRT
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/tables/table1_VE_redacted_unmatched_RRT.rds
      moderately_sensitive:
        table: output/tables/table1_VE_redacted_unmatched_RRT.html
        
  # Table 1 (all matched)
  table_1_VE_all_matched:
    run: r:latest analysis/VE/table_1_VE.R matched all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/tables/table1_VE_redacted_matched_all.rds
      moderately_sensitive:
        table: output/tables/table1_VE_redacted_matched_all.html
  
  # Table 1 (RRT matched)
  table_1_VE_RRT_matched:
    run: r:latest analysis/VE/table_1_VE.R matched RRT
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/tables/table1_VE_redacted_matched_RRT.rds
      moderately_sensitive:
        table: output/tables/table1_VE_redacted_matched_RRT.html
   
#############################
### IRR - all, CKD3, CKD4-5, RRT - matched,unmatched
#############################
   
  # Table IRR (all unmatched)
  table_irr_unmatched_all:
    run: r:latest analysis/VE/table_irr.R unmatched all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/tables/table_irr_redacted_unmatched_all.rds
      moderately_sensitive:
        csv: output/tables/table_irr_redacted_unmatched_all.csv
        
  # Table IRR (CKD3 unmatched)
  table_irr_unmatched_CKD3:
    run: r:latest analysis/VE/table_irr.R unmatched CKD3
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/tables/table_irr_redacted_unmatched_CKD3.rds
      moderately_sensitive:
        csv: output/tables/table_irr_redacted_unmatched_CKD3.csv
 
  # Table IRR (CKD4-5 unmatched)
  table_irr_unmatched_CKD4_5:
    run: r:latest analysis/VE/table_irr.R unmatched CKD4-5
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/tables/table_irr_redacted_unmatched_CKD4-5.rds
      moderately_sensitive:
        csv: output/tables/table_irr_redacted_unmatched_CKD4-5.csv
        
  # Table IRR (RRT unmatched)
  table_irr_unmatched_RRT:
    run: r:latest analysis/VE/table_irr.R unmatched RRT
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/tables/table_irr_redacted_unmatched_RRT.rds
      moderately_sensitive:
        csv: output/tables/table_irr_redacted_unmatched_RRT.csv

  # Table IRR (all matched)
  table_irr_matched_all:
    run: r:latest analysis/VE/table_irr.R matched all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/tables/table_irr_redacted_matched_all.rds
      moderately_sensitive:
        csv: output/tables/table_irr_redacted_matched_all.csv
        
  # Table IRR (CKD3 matched)
  table_irr_matched_CKD3:
    run: r:latest analysis/VE/table_irr.R matched CKD3
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/tables/table_irr_redacted_matched_CKD3.rds
      moderately_sensitive:
        csv: output/tables/table_irr_redacted_matched_CKD3.csv
 
  # Table IRR (CKD4-5 matched)
  table_irr_matched_CKD4_5:
    run: r:latest analysis/VE/table_irr.R matched CKD4-5
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/tables/table_irr_redacted_matched_CKD4-5.rds
      moderately_sensitive:
        csv: output/tables/table_irr_redacted_matched_CKD4-5.csv
        
  # Table IRR (RRT matched)
  table_irr_matched_RRT:
    run: r:latest analysis/VE/table_irr.R matched RRT
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/tables/table_irr_redacted_matched_RRT.rds
      moderately_sensitive:
        csv: output/tables/table_irr_redacted_matched_RRT.csv
        
  # Table IRR - verification (adapted from prior scripts)
  table_irr_verification:
    run: r:latest analysis/VE/table_irr_verification.R
    needs: [data_selection_VE]
    outputs:
      moderately_sensitive:
        csv: output/tables/table_irr_redacted_verification_unmatched_all.csv

#############################
### Cox models - preflight then model
### Outcomes (5): postest, hosp, A&E, death, non-Covid death
### Populations (2): unmatched and matched
### Timescales (2): peron-time, calendar-time (only for full unmatched analysis)
### Subsets: all, CKD3, CKD4-5, RRT (matched and unmatched)
#############################

### OUTCOME #1: covid_postest test

  ### unmatched persontime all
  # preflight
  cox_preflight_unmatched_persontime_covid_postest_VE_all:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime covid_postest all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_covid_postest_all.rds
        formulas: output/model/formulas*unmatched_persontime_covid_postest_all.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_covid_postest_all.txt
  
  # model
  cox_model_unmatched_persontime_covid_postest_VE_all:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime covid_postest all
    needs: [data_selection_VE, table_irr_unmatched_all, cox_preflight_unmatched_persontime_covid_postest_VE_all]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_covid_postest_all.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_covid_postest_all.csv
        logs: output/model/log_cox_model_unmatched_persontime_covid_postest_all.txt

  ### matched persontime all
  # preflight
  cox_preflight_matched_persontime_covid_postest_VE_all:
    run: r:latest analysis/VE/cox_preflight_VE.R matched persontime covid_postest all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*matched_persontime_covid_postest_all.rds
        formulas: output/model/formulas*matched_persontime_covid_postest_all.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_matched_persontime_covid_postest_all.txt
  
  # model
  cox_model_matched_persontime_covid_postest_VE_all:
    run: r:latest analysis/VE/cox_model_VE.R matched persontime covid_postest all
    needs: [data_selection_VE, table_irr_matched_all, cox_preflight_matched_persontime_covid_postest_VE_all]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*matched_persontime_covid_postest_all.rds
      moderately_sensitive:
        csv: output/model/modelcox*matched_persontime_covid_postest_all.csv
        logs: output/model/log_cox_model_matched_persontime_covid_postest_all.txt
        
  ### unmatched calendartime all
  # preflight
  cox_preflight_unmatched_calendartime_covid_postest_VE_all:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched calendartime covid_postest all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_calendartime_covid_postest_all.rds
        formulas: output/model/formulas*unmatched_calendartime_covid_postest_all.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_calendartime_covid_postest_all.txt
  
  # model
  cox_model_unmatched_calendartime_covid_postest_VE_all:
    run: r:latest analysis/VE/cox_model_VE.R unmatched calendartime covid_postest all
    needs: [data_selection_VE, table_irr_unmatched_all, cox_preflight_unmatched_calendartime_covid_postest_VE_all]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_calendartime_covid_postest_all.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_calendartime_covid_postest_all.csv
        logs: output/model/log_cox_model_unmatched_calendartime_covid_postest_all.txt

  ### unmatched persontime CKD3
  # preflight
  cox_preflight_unmatched_persontime_covid_postest_VE_CKD3:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime covid_postest CKD3
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_covid_postest_CKD3.rds
        formulas: output/model/formulas*unmatched_persontime_covid_postest_CKD3.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_covid_postest_CKD3.txt
  
  # model
  cox_model_unmatched_persontime_covid_postest_VE_CKD3:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime covid_postest CKD3
    needs: [data_selection_VE, table_irr_unmatched_CKD3, cox_preflight_unmatched_persontime_covid_postest_VE_CKD3]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_covid_postest_CKD3.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_covid_postest_CKD3.csv
        logs: output/model/log_cox_model_unmatched_persontime_covid_postest_CKD3.txt

  ### unmatched persontime CKD4-5
  # preflight
  cox_preflight_unmatched_persontime_covid_postest_VE_CKD4_5:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime covid_postest CKD4-5
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_covid_postest_CKD4-5.rds
        formulas: output/model/formulas*unmatched_persontime_covid_postest_CKD4-5.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_covid_postest_CKD4-5.txt
  
  # model
  cox_model_unmatched_persontime_covid_postest_VE_CKD4_5:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime covid_postest CKD4-5
    needs: [data_selection_VE, table_irr_unmatched_CKD4_5, cox_preflight_unmatched_persontime_covid_postest_VE_CKD4_5]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_covid_postest_CKD4-5.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_covid_postest_CKD4-5.csv
        logs: output/model/log_cox_model_unmatched_persontime_covid_postest_CKD4-5.txt

  ### unmatched persontime RRT
  # preflight
  cox_preflight_unmatched_persontime_covid_postest_VE_RRT:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime covid_postest RRT
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_covid_postest_RRT.rds
        formulas: output/model/formulas*unmatched_persontime_covid_postest_RRT.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_covid_postest_RRT.txt
  
  # model
  cox_model_unmatched_persontime_covid_postest_VE_RRT:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime covid_postest RRT
    needs: [data_selection_VE, table_irr_unmatched_RRT, cox_preflight_unmatched_persontime_covid_postest_VE_RRT]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_covid_postest_RRT.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_covid_postest_RRT.csv
        logs: output/model/log_cox_model_unmatched_persontime_covid_postest_RRT.txt



### OUTCOME #2: covid_emergency test

  ### unmatched persontime all
  # preflight
  cox_preflight_unmatched_persontime_covid_emergency_VE_all:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime covid_emergency all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_covid_emergency_all.rds
        formulas: output/model/formulas*unmatched_persontime_covid_emergency_all.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_covid_emergency_all.txt
  
  # model
  cox_model_unmatched_persontime_covid_emergency_VE_all:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime covid_emergency all
    needs: [data_selection_VE, table_irr_unmatched_all, cox_preflight_unmatched_persontime_covid_emergency_VE_all]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_covid_emergency_all.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_covid_emergency_all.csv
        logs: output/model/log_cox_model_unmatched_persontime_covid_emergency_all.txt

  ### matched persontime all
  # preflight
  cox_preflight_matched_persontime_covid_emergency_VE_all:
    run: r:latest analysis/VE/cox_preflight_VE.R matched persontime covid_emergency all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*matched_persontime_covid_emergency_all.rds
        formulas: output/model/formulas*matched_persontime_covid_emergency_all.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_matched_persontime_covid_emergency_all.txt
  
  # model
  cox_model_matched_persontime_covid_emergency_VE_all:
    run: r:latest analysis/VE/cox_model_VE.R matched persontime covid_emergency all
    needs: [data_selection_VE, table_irr_matched_all, cox_preflight_matched_persontime_covid_emergency_VE_all]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*matched_persontime_covid_emergency_all.rds
      moderately_sensitive:
        csv: output/model/modelcox*matched_persontime_covid_emergency_all.csv
        logs: output/model/log_cox_model_matched_persontime_covid_emergency_all.txt
        
  ### unmatched calendartime all
  # preflight
  cox_preflight_unmatched_calendartime_covid_emergency_VE_all:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched calendartime covid_emergency all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_calendartime_covid_emergency_all.rds
        formulas: output/model/formulas*unmatched_calendartime_covid_emergency_all.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_calendartime_covid_emergency_all.txt
  
  # model
  cox_model_unmatched_calendartime_covid_emergency_VE_all:
    run: r:latest analysis/VE/cox_model_VE.R unmatched calendartime covid_emergency all
    needs: [data_selection_VE, table_irr_unmatched_all, cox_preflight_unmatched_calendartime_covid_emergency_VE_all]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_calendartime_covid_emergency_all.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_calendartime_covid_emergency_all.csv
        logs: output/model/log_cox_model_unmatched_calendartime_covid_emergency_all.txt

  ### unmatched persontime CKD3
  # preflight
  cox_preflight_unmatched_persontime_covid_emergency_VE_CKD3:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime covid_emergency CKD3
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_covid_emergency_CKD3.rds
        formulas: output/model/formulas*unmatched_persontime_covid_emergency_CKD3.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_covid_emergency_CKD3.txt
  
  # model
  cox_model_unmatched_persontime_covid_emergency_VE_CKD3:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime covid_emergency CKD3
    needs: [data_selection_VE, table_irr_unmatched_CKD3, cox_preflight_unmatched_persontime_covid_emergency_VE_CKD3]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_covid_emergency_CKD3.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_covid_emergency_CKD3.csv
        logs: output/model/log_cox_model_unmatched_persontime_covid_emergency_CKD3.txt

  ### unmatched persontime CKD4-5
  # preflight
  cox_preflight_unmatched_persontime_covid_emergency_VE_CKD4_5:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime covid_emergency CKD4-5
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_covid_emergency_CKD4-5.rds
        formulas: output/model/formulas*unmatched_persontime_covid_emergency_CKD4-5.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_covid_emergency_CKD4-5.txt
  
  # model
  cox_model_unmatched_persontime_covid_emergency_VE_CKD4_5:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime covid_emergency CKD4-5
    needs: [data_selection_VE, table_irr_unmatched_CKD4_5, cox_preflight_unmatched_persontime_covid_emergency_VE_CKD4_5]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_covid_emergency_CKD4-5.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_covid_emergency_CKD4-5.csv
        logs: output/model/log_cox_model_unmatched_persontime_covid_emergency_CKD4-5.txt

  ### unmatched persontime RRT
  # preflight
  cox_preflight_unmatched_persontime_covid_emergency_VE_RRT:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime covid_emergency RRT
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_covid_emergency_RRT.rds
        formulas: output/model/formulas*unmatched_persontime_covid_emergency_RRT.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_covid_emergency_RRT.txt
  
  # model
  cox_model_unmatched_persontime_covid_emergency_VE_RRT:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime covid_emergency RRT
    needs: [data_selection_VE, table_irr_unmatched_RRT, cox_preflight_unmatched_persontime_covid_emergency_VE_RRT]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_covid_emergency_RRT.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_covid_emergency_RRT.csv
        logs: output/model/log_cox_model_unmatched_persontime_covid_emergency_RRT.txt



### OUTCOME #3: covid_hosp test

  ### unmatched persontime all
  # preflight
  cox_preflight_unmatched_persontime_covid_hosp_VE_all:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime covid_hosp all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_covid_hosp_all.rds
        formulas: output/model/formulas*unmatched_persontime_covid_hosp_all.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_covid_hosp_all.txt
  
  # model
  cox_model_unmatched_persontime_covid_hosp_VE_all:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime covid_hosp all
    needs: [data_selection_VE, table_irr_unmatched_all, cox_preflight_unmatched_persontime_covid_hosp_VE_all]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_covid_hosp_all.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_covid_hosp_all.csv
        logs: output/model/log_cox_model_unmatched_persontime_covid_hosp_all.txt

  ### matched persontime all
  # preflight
  cox_preflight_matched_persontime_covid_hosp_VE_all:
    run: r:latest analysis/VE/cox_preflight_VE.R matched persontime covid_hosp all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*matched_persontime_covid_hosp_all.rds
        formulas: output/model/formulas*matched_persontime_covid_hosp_all.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_matched_persontime_covid_hosp_all.txt
  
  # model
  cox_model_matched_persontime_covid_hosp_VE_all:
    run: r:latest analysis/VE/cox_model_VE.R matched persontime covid_hosp all
    needs: [data_selection_VE, table_irr_matched_all, cox_preflight_matched_persontime_covid_hosp_VE_all]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*matched_persontime_covid_hosp_all.rds
      moderately_sensitive:
        csv: output/model/modelcox*matched_persontime_covid_hosp_all.csv
        logs: output/model/log_cox_model_matched_persontime_covid_hosp_all.txt
        
  ### unmatched calendartime all
  # preflight
  cox_preflight_unmatched_calendartime_covid_hosp_VE_all:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched calendartime covid_hosp all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_calendartime_covid_hosp_all.rds
        formulas: output/model/formulas*unmatched_calendartime_covid_hosp_all.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_calendartime_covid_hosp_all.txt
  
  # model
  cox_model_unmatched_calendartime_covid_hosp_VE_all:
    run: r:latest analysis/VE/cox_model_VE.R unmatched calendartime covid_hosp all
    needs: [data_selection_VE, table_irr_unmatched_all, cox_preflight_unmatched_calendartime_covid_hosp_VE_all]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_calendartime_covid_hosp_all.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_calendartime_covid_hosp_all.csv
        logs: output/model/log_cox_model_unmatched_calendartime_covid_hosp_all.txt

  ### unmatched persontime CKD3
  # preflight
  cox_preflight_unmatched_persontime_covid_hosp_VE_CKD3:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime covid_hosp CKD3
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_covid_hosp_CKD3.rds
        formulas: output/model/formulas*unmatched_persontime_covid_hosp_CKD3.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_covid_hosp_CKD3.txt
  
  # model
  cox_model_unmatched_persontime_covid_hosp_VE_CKD3:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime covid_hosp CKD3
    needs: [data_selection_VE, table_irr_unmatched_CKD3, cox_preflight_unmatched_persontime_covid_hosp_VE_CKD3]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_covid_hosp_CKD3.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_covid_hosp_CKD3.csv
        logs: output/model/log_cox_model_unmatched_persontime_covid_hosp_CKD3.txt

  ### unmatched persontime CKD4-5
  # preflight
  cox_preflight_unmatched_persontime_covid_hosp_VE_CKD4_5:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime covid_hosp CKD4-5
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_covid_hosp_CKD4-5.rds
        formulas: output/model/formulas*unmatched_persontime_covid_hosp_CKD4-5.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_covid_hosp_CKD4-5.txt
  
  # model
  cox_model_unmatched_persontime_covid_hosp_VE_CKD4_5:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime covid_hosp CKD4-5
    needs: [data_selection_VE, table_irr_unmatched_CKD4_5, cox_preflight_unmatched_persontime_covid_hosp_VE_CKD4_5]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_covid_hosp_CKD4-5.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_covid_hosp_CKD4-5.csv
        logs: output/model/log_cox_model_unmatched_persontime_covid_hosp_CKD4-5.txt

  ### unmatched persontime RRT
  # preflight
  cox_preflight_unmatched_persontime_covid_hosp_VE_RRT:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime covid_hosp RRT
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_covid_hosp_RRT.rds
        formulas: output/model/formulas*unmatched_persontime_covid_hosp_RRT.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_covid_hosp_RRT.txt
  
  # model
  cox_model_unmatched_persontime_covid_hosp_VE_RRT:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime covid_hosp RRT
    needs: [data_selection_VE, table_irr_unmatched_RRT, cox_preflight_unmatched_persontime_covid_hosp_VE_RRT]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_covid_hosp_RRT.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_covid_hosp_RRT.csv
        logs: output/model/log_cox_model_unmatched_persontime_covid_hosp_RRT.txt



### OUTCOME #4: covid_death test

  ### unmatched persontime all
  # preflight
  cox_preflight_unmatched_persontime_covid_death_VE_all:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime covid_death all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_covid_death_all.rds
        formulas: output/model/formulas*unmatched_persontime_covid_death_all.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_covid_death_all.txt
  
  # model
  cox_model_unmatched_persontime_covid_death_VE_all:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime covid_death all
    needs: [data_selection_VE, table_irr_unmatched_all, cox_preflight_unmatched_persontime_covid_death_VE_all]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_covid_death_all.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_covid_death_all.csv
        logs: output/model/log_cox_model_unmatched_persontime_covid_death_all.txt

  ### matched persontime all
  # preflight
  cox_preflight_matched_persontime_covid_death_VE_all:
    run: r:latest analysis/VE/cox_preflight_VE.R matched persontime covid_death all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*matched_persontime_covid_death_all.rds
        formulas: output/model/formulas*matched_persontime_covid_death_all.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_matched_persontime_covid_death_all.txt
  
  # model
  cox_model_matched_persontime_covid_death_VE_all:
    run: r:latest analysis/VE/cox_model_VE.R matched persontime covid_death all
    needs: [data_selection_VE, table_irr_matched_all, cox_preflight_matched_persontime_covid_death_VE_all]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*matched_persontime_covid_death_all.rds
      moderately_sensitive:
        csv: output/model/modelcox*matched_persontime_covid_death_all.csv
        logs: output/model/log_cox_model_matched_persontime_covid_death_all.txt
        
  ### unmatched calendartime all
  # preflight
  cox_preflight_unmatched_calendartime_covid_death_VE_all:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched calendartime covid_death all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_calendartime_covid_death_all.rds
        formulas: output/model/formulas*unmatched_calendartime_covid_death_all.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_calendartime_covid_death_all.txt
  
  # model
  cox_model_unmatched_calendartime_covid_death_VE_all:
    run: r:latest analysis/VE/cox_model_VE.R unmatched calendartime covid_death all
    needs: [data_selection_VE, table_irr_unmatched_all, cox_preflight_unmatched_calendartime_covid_death_VE_all]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_calendartime_covid_death_all.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_calendartime_covid_death_all.csv
        logs: output/model/log_cox_model_unmatched_calendartime_covid_death_all.txt

  ### unmatched persontime CKD3
  # preflight
  cox_preflight_unmatched_persontime_covid_death_VE_CKD3:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime covid_death CKD3
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_covid_death_CKD3.rds
        formulas: output/model/formulas*unmatched_persontime_covid_death_CKD3.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_covid_death_CKD3.txt
  
  # model
  cox_model_unmatched_persontime_covid_death_VE_CKD3:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime covid_death CKD3
    needs: [data_selection_VE, table_irr_unmatched_CKD3, cox_preflight_unmatched_persontime_covid_death_VE_CKD3]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_covid_death_CKD3.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_covid_death_CKD3.csv
        logs: output/model/log_cox_model_unmatched_persontime_covid_death_CKD3.txt

  ### unmatched persontime CKD4-5
  # preflight
  cox_preflight_unmatched_persontime_covid_death_VE_CKD4_5:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime covid_death CKD4-5
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_covid_death_CKD4-5.rds
        formulas: output/model/formulas*unmatched_persontime_covid_death_CKD4-5.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_covid_death_CKD4-5.txt
  
  # model
  cox_model_unmatched_persontime_covid_death_VE_CKD4_5:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime covid_death CKD4-5
    needs: [data_selection_VE, table_irr_unmatched_CKD4_5, cox_preflight_unmatched_persontime_covid_death_VE_CKD4_5]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_covid_death_CKD4-5.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_covid_death_CKD4-5.csv
        logs: output/model/log_cox_model_unmatched_persontime_covid_death_CKD4-5.txt

  ### unmatched persontime RRT
  # preflight
  cox_preflight_unmatched_persontime_covid_death_VE_RRT:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime covid_death RRT
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_covid_death_RRT.rds
        formulas: output/model/formulas*unmatched_persontime_covid_death_RRT.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_covid_death_RRT.txt
  
  # model
  cox_model_unmatched_persontime_covid_death_VE_RRT:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime covid_death RRT
    needs: [data_selection_VE, table_irr_unmatched_RRT, cox_preflight_unmatched_persontime_covid_death_VE_RRT]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_covid_death_RRT.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_covid_death_RRT.csv
        logs: output/model/log_cox_model_unmatched_persontime_covid_death_RRT.txt



### OUTCOME #5: noncovid_death test

  ### unmatched persontime all
  # preflight
  cox_preflight_unmatched_persontime_noncovid_death_VE_all:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime noncovid_death all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_noncovid_death_all.rds
        formulas: output/model/formulas*unmatched_persontime_noncovid_death_all.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_noncovid_death_all.txt
  
  # model
  cox_model_unmatched_persontime_noncovid_death_VE_all:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime noncovid_death all
    needs: [data_selection_VE, table_irr_unmatched_all, cox_preflight_unmatched_persontime_noncovid_death_VE_all]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_noncovid_death_all.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_noncovid_death_all.csv
        logs: output/model/log_cox_model_unmatched_persontime_noncovid_death_all.txt

  ### matched persontime all
  # preflight
  cox_preflight_matched_persontime_noncovid_death_VE_all:
    run: r:latest analysis/VE/cox_preflight_VE.R matched persontime noncovid_death all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*matched_persontime_noncovid_death_all.rds
        formulas: output/model/formulas*matched_persontime_noncovid_death_all.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_matched_persontime_noncovid_death_all.txt
  
  # model
  cox_model_matched_persontime_noncovid_death_VE_all:
    run: r:latest analysis/VE/cox_model_VE.R matched persontime noncovid_death all
    needs: [data_selection_VE, table_irr_matched_all, cox_preflight_matched_persontime_noncovid_death_VE_all]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*matched_persontime_noncovid_death_all.rds
      moderately_sensitive:
        csv: output/model/modelcox*matched_persontime_noncovid_death_all.csv
        logs: output/model/log_cox_model_matched_persontime_noncovid_death_all.txt
        
  ### unmatched calendartime all
  # preflight
  cox_preflight_unmatched_calendartime_noncovid_death_VE_all:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched calendartime noncovid_death all
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_calendartime_noncovid_death_all.rds
        formulas: output/model/formulas*unmatched_calendartime_noncovid_death_all.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_calendartime_noncovid_death_all.txt
  
  # model
  cox_model_unmatched_calendartime_noncovid_death_VE_all:
    run: r:latest analysis/VE/cox_model_VE.R unmatched calendartime noncovid_death all
    needs: [data_selection_VE, table_irr_unmatched_all, cox_preflight_unmatched_calendartime_noncovid_death_VE_all]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_calendartime_noncovid_death_all.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_calendartime_noncovid_death_all.csv
        logs: output/model/log_cox_model_unmatched_calendartime_noncovid_death_all.txt

  ### unmatched persontime CKD3
  # preflight
  cox_preflight_unmatched_persontime_noncovid_death_VE_CKD3:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime noncovid_death CKD3
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_noncovid_death_CKD3.rds
        formulas: output/model/formulas*unmatched_persontime_noncovid_death_CKD3.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_noncovid_death_CKD3.txt
  
  # model
  cox_model_unmatched_persontime_noncovid_death_VE_CKD3:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime noncovid_death CKD3
    needs: [data_selection_VE, table_irr_unmatched_CKD3, cox_preflight_unmatched_persontime_noncovid_death_VE_CKD3]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_noncovid_death_CKD3.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_noncovid_death_CKD3.csv
        logs: output/model/log_cox_model_unmatched_persontime_noncovid_death_CKD3.txt

  ### unmatched persontime CKD4-5
  # preflight
  cox_preflight_unmatched_persontime_noncovid_death_VE_CKD4_5:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime noncovid_death CKD4-5
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_noncovid_death_CKD4-5.rds
        formulas: output/model/formulas*unmatched_persontime_noncovid_death_CKD4-5.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_noncovid_death_CKD4-5.txt
  
  # model
  cox_model_unmatched_persontime_noncovid_death_VE_CKD4_5:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime noncovid_death CKD4-5
    needs: [data_selection_VE, table_irr_unmatched_CKD4_5, cox_preflight_unmatched_persontime_noncovid_death_VE_CKD4_5]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_noncovid_death_CKD4-5.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_noncovid_death_CKD4-5.csv
        logs: output/model/log_cox_model_unmatched_persontime_noncovid_death_CKD4-5.txt

  ### unmatched persontime RRT
  # preflight
  cox_preflight_unmatched_persontime_noncovid_death_VE_RRT:
    run: r:latest analysis/VE/cox_preflight_VE.R unmatched persontime noncovid_death RRT
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/model/data*unmatched_persontime_noncovid_death_RRT.rds
        formulas: output/model/formulas*unmatched_persontime_noncovid_death_RRT.rds
      moderately_sensitive:
        logs: output/model/log_cox_preflight_unmatched_persontime_noncovid_death_RRT.txt
  
  # model
  cox_model_unmatched_persontime_noncovid_death_VE_RRT:
    run: r:latest analysis/VE/cox_model_VE.R unmatched persontime noncovid_death RRT
    needs: [data_selection_VE, table_irr_unmatched_RRT, cox_preflight_unmatched_persontime_noncovid_death_VE_RRT]
    outputs:
      highly_sensitive:
        data: output/model/modelcox*unmatched_persontime_noncovid_death_RRT.rds
      moderately_sensitive:
        csv: output/model/modelcox*unmatched_persontime_noncovid_death_RRT.csv
        logs: output/model/log_cox_model_unmatched_persontime_noncovid_death_RRT.txt

  # model
  cox_VE_summary:
    run: r:latest -e 'rmarkdown::render("analysis/VE/cox_VE_summary.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown/")'
    needs:
    - data_selection_VE
    - table_1_VE_all_unmatched
    - table_1_VE_CKD3_unmatched
    - table_1_VE_CKD4_5_unmatched
    - table_1_VE_RRT_unmatched
    - table_1_VE_all_matched
    - table_irr_unmatched_all
    - table_irr_unmatched_CKD3
    - table_irr_unmatched_CKD4_5
    - table_irr_unmatched_RRT
    - table_irr_matched_all
    - cox_model_unmatched_persontime_covid_postest_VE_all
    - cox_model_matched_persontime_covid_postest_VE_all
    - cox_model_unmatched_calendartime_covid_postest_VE_all
    - cox_model_unmatched_persontime_covid_postest_VE_CKD3
    - cox_model_unmatched_persontime_covid_postest_VE_CKD4_5
    - cox_model_unmatched_persontime_covid_postest_VE_RRT
    - cox_model_unmatched_persontime_covid_hosp_VE_all
    - cox_model_matched_persontime_covid_hosp_VE_all
    - cox_model_unmatched_calendartime_covid_hosp_VE_all
    - cox_model_unmatched_persontime_covid_hosp_VE_CKD3
    - cox_model_unmatched_persontime_covid_hosp_VE_CKD4_5
    - cox_model_unmatched_persontime_covid_hosp_VE_RRT
    - cox_model_unmatched_persontime_covid_death_VE_all
    - cox_model_matched_persontime_covid_death_VE_all
    - cox_model_unmatched_calendartime_covid_death_VE_all
    - cox_model_unmatched_persontime_covid_death_VE_CKD3
    - cox_model_unmatched_persontime_covid_death_VE_CKD4_5
    - cox_model_unmatched_persontime_covid_death_VE_RRT
    - cox_model_unmatched_persontime_noncovid_death_VE_all
    - cox_model_matched_persontime_noncovid_death_VE_all
    - cox_model_unmatched_calendartime_noncovid_death_VE_all
    - cox_model_unmatched_persontime_noncovid_death_VE_CKD3
    - cox_model_unmatched_persontime_noncovid_death_VE_CKD4_5
    - cox_model_unmatched_persontime_noncovid_death_VE_RRT
    outputs:
      moderately_sensitive:
        html: output/markdown/cox_VE_summary.html
