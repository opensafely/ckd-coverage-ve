######################################
# Script defines project pipeline via series of actions
######################################

version: '3.0'

expectations:
  population_size: 30000

actions:

  # Extract data ----
  generate_study_population:
    run: cohortextractor:latest generate_cohort --study-definition study_definition --output-dir=output/data
    outputs:
      highly_sensitive:
        cohort: output/data/input.csv
  
# Process data ----
  data_process:
    run: r:latest analysis/data_process.R
    needs: [generate_study_population]
    outputs:
      highly_sensitive:
        data: output/data/data_processed.rds
        csv: output/data/data_processed.csv
        
# Select cohort ----
  data_selection_coverage:
    run: r:latest analysis/data_selection_coverage.R
    needs: [data_process]
    outputs:
      highly_sensitive:
        data: output/data/data_cohort_coverage.rds
        csv: output/data/data_cohort_coverage.csv
      moderately_sensitive:
        csv: output/tables/flowchart_coverage.csv

 # Data properties ----      
  data_properties:
    run: r:latest analysis/data_properties.R output/data/data_cohort_coverage.rds output/data_properties
    needs: [data_selection_coverage]
    outputs:
      moderately_sensitive:
        cohort: output/data_properties/data_cohort*.txt
        
  # Table 1 ----
  table_1_coverage:
    run: r:latest analysis/table_1_coverage.R
    needs: [data_selection_coverage]
    outputs:
      highly_sensitive:
        data: output/tables/table1_coverage_redacted.rds
      moderately_sensitive:
        table: output/tables/table1_coverage_redacted.html
        
  # Cox models - dose-2 coverage ----
  cox_model:
    run: r:latest analysis/cox_model.R
    needs: [data_selection_coverage]
    outputs:
      highly_sensitive:
        data1: output/data/data_cox.rds
        data2: output/model/mod_strat_coxph_redacted.rds
        csv: output/data/data_cox.csv
      moderately_sensitive:
        csv: output/model/mod_strat_coxph_redacted.csv
        
  # Logistic models - dose-2 coverage ----
  logistic_model:
    run: r:latest analysis/logistic_model.R
    needs: [cox_model]
    outputs:
      highly_sensitive:
        data: output/model/mod_strat_logistic_redacted.rds
      moderately_sensitive:
        csv: output/model/mod_strat_logistic_redacted.csv

  # Coverage summaries ----
  vaccine_coverage:
    run: r:latest -e 'rmarkdown::render("analysis/vaccine_coverage.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown")'
    needs: [data_selection_coverage, table_1_coverage, cox_model, logistic_model]
    outputs:
      moderately_sensitive:
        html: output/markdown/vaccine_coverage.html
        csv: output/tables/coverage_over_time_rounded.csv

  # Coverage summaries ----
  cox_model_check:
    run: r:latest -e 'rmarkdown::render("analysis/cox_model_check.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown")'
    needs: [data_selection_coverage, cox_model]
    outputs:
      moderately_sensitive:
        html: output/markdown/cox_model_check.html

# Select cohort (VE) ----
  data_selection_VE:
    run: r:latest analysis/data_selection_VE.R
    needs: [data_process]
    outputs:
      highly_sensitive:
        data: output/data/data_cohort_VE.rds
        csv: output/data/data_cohort_VE.csv
      moderately_sensitive:
        csv: output/tables/flowchart_VE.csv

  # Table 1 (VE) ----
  table_1_VE:
    run: r:latest analysis/table_1_VE.R
    needs: [data_selection_VE]
    outputs:
      highly_sensitive:
        data: output/tables/table1_VE_redacted.rds
      moderately_sensitive:
        table: output/tables/table1_VE_redacted.html

  # Check session info for set of packages ----
  #session:
  #  run: r:latest -e 'rmarkdown::render("analysis/session.Rmd", knit_root_dir = "/workspace", output_dir="/workspace/output/markdown")'
  #  needs: [data_selection]
  #  outputs:
  #    moderately_sensitive:
  #      html: output/markdown/session.html
